"use strict";var e=Object.defineProperty,t=(t,r,n)=>(((t,r,n)=>{r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n})(t,"symbol"!=typeof r?r+"":r,n),n),r=(e,t,r)=>new Promise((n,o)=>{var s=e=>{try{a(r.next(e))}catch(t){o(t)}},i=e=>{try{a(r.throw(e))}catch(t){o(t)}},a=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,i);a((r=r.apply(e,t)).next())});const n=require("../common/vendor.js"),o=require("../constants/storage.js"),s=require("./logger.js"),i=require("./logger-helpers.js");const a=new class{constructor(){t(this,"prefix",o.STORAGE_PREFIX)}set(e,t){return r(this,arguments,function*(e,t,r={}){try{const o={value:t,timestamp:Date.now(),expires:r.expires?Date.now()+1e3*r.expires:null};let s=JSON.stringify(o);return r.encrypt&&(s=this.encrypt(s)),new Promise((t,r)=>{n.wx$1.setStorage({key:this.prefix+e,data:s,success:()=>t(),fail:r})})}catch(o){const e=i.createContext();throw s.logger.error(e,"[StorageManager.set] 存储设置失败",o),o}})}get(e,t=null){return r(this,null,function*(){try{let o=null;if(o=yield new Promise(t=>{n.wx$1.getStorage({key:this.prefix+e,success:e=>t(e.data),fail:()=>t(null)})}),!o)return t;let s=o;try{s=this.decrypt(o)}catch(r){}const i=JSON.parse(s);return i.expires&&Date.now()>i.expires?(yield this.remove(e),t):i.value}catch(o){const e=i.createContext();return s.logger.error(e,"[StorageManager.get] 存储获取失败",o),t}})}remove(e){return r(this,null,function*(){try{return new Promise((t,r)=>{n.wx$1.removeStorage({key:this.prefix+e,success:()=>t(),fail:r})})}catch(t){const e=i.createContext();throw s.logger.error(e,"[StorageManager.remove] 存储删除失败",t),t}})}clear(){return r(this,null,function*(){try{const e=yield new Promise(e=>{n.wx$1.getStorageInfo({success:t=>{const r=t.keys.filter(e=>e.startsWith(this.prefix));e(r)},fail:()=>e([])})});for(const t of e)yield new Promise(e=>{n.wx$1.removeStorage({key:t,success:()=>e(),fail:()=>e()})})}catch(e){const t=i.createContext();throw s.logger.error(t,"[StorageManager.clear] 存储清空失败",e),e}})}getStorageInfo(){return r(this,null,function*(){try{return new Promise((e,t)=>{n.wx$1.getStorageInfo({success:t=>{const r=t.keys.filter(e=>e.startsWith(this.prefix));e({keys:r,currentSize:t.currentSize,limitSize:t.limitSize})},fail:t})})}catch(e){const t=i.createContext();return s.logger.error(t,"[StorageManager.getStorageInfo] 获取存储信息失败",e),{keys:[],currentSize:0,limitSize:0}}})}encrypt(e){try{return btoa(encodeURIComponent(e))}catch(t){return e}}decrypt(e){try{return decodeURIComponent(atob(e))}catch(t){return e}}setFile(e,t){return r(this,null,function*(){const r=n.wx$1.getFileSystemManager(),o=`${n.wx$1.env.USER_DATA_PATH}/${e}`;return new Promise((e,n)=>{r.writeFile({filePath:o,data:t,encoding:"utf8",success:()=>e(o),fail:n})})})}getFile(e){return r(this,null,function*(){const t=n.wx$1.getFileSystemManager(),r=`${n.wx$1.env.USER_DATA_PATH}/${e}`;return new Promise(e=>{t.readFile({filePath:r,encoding:"utf8",success:t=>e(t.data),fail:()=>e(null)})})})}saveToIndexedDB(e,t){return r(this,null,function*(){const r=`file_${e}`;return localStorage.setItem(r,t),Promise.resolve(r)})}getFromIndexedDB(e){return r(this,null,function*(){const t=`file_${e}`;return Promise.resolve(localStorage.getItem(t))})}saveToAppStorage(e,t){return r(this,null,function*(){return new Promise(r=>{plus.storage.setItem(`file_${e}`,t),r(`file_${e}`)})})}getFromAppStorage(e){return r(this,null,function*(){return Promise.resolve(plus.storage.getItem(`file_${e}`))})}};exports.getStorage=(e,t=null)=>a.get(e,t),exports.removeStorage=e=>a.remove(e),exports.setStorage=(e,t,r)=>a.set(e,t,r);
