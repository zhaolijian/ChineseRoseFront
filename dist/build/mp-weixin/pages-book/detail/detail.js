"use strict";var e=(e,o,t)=>new Promise((a,l)=>{var n=e=>{try{i(t.next(e))}catch(o){l(o)}},r=e=>{try{i(t.throw(e))}catch(o){l(o)}},i=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,r);i((t=t.apply(e,o)).next())});const o=require("../../common/vendor.js"),t=require("../../stores/modules/book.js"),a=require("../../api/modules/note.js"),l=require("../../api/modules/mindmap.js"),n=require("../../api/modules/book.js");require("../../utils/request.js");const r=require("../../utils/logger.js"),i=require("../../utils/logger-helpers.js");if(require("../../types/errorCodes.js"),require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(o.resolveComponent("u-icon")+o.resolveComponent("u-button")+o.resolveComponent("u-action-sheet")+o.resolveComponent("u-loading-page"))()}Math||((()=>"../../node-modules/uview-plus/components/u-icon/u-icon.js")+g+d+u+(()=>"../../node-modules/uview-plus/components/u-button/u-button.js")+s+(()=>"../../node-modules/uview-plus/components/u-action-sheet/u-action-sheet.js")+c+(()=>"../../node-modules/uview-plus/components/u-loading-page/u-loading-page.js"))();const u=()=>"../../components/common/LoadingSkeleton.js",s=()=>"../../components/common/TabBar.js",d=()=>"../../components/common/DropdownMenu.js",c=()=>"../../components/create-note-modal/index.js",g=()=>"../../components/book/BookCover.js",v=o.defineComponent({__name:"detail",setup(u){const s=t.useBookStore(),d=o.ref(null),c=o.ref([]),g=o.ref(null),v=o.ref(!1),p=o.ref(!1),m=o.ref(!1),h=o.ref(!1),f=o.ref(!1),k=o.ref(0),b=o.ref("modifiedDesc"),x=o.ref(!1),y=o.ref({x:0,y:0,w:200}),w=o.ref(!1),C=o.computed(()=>d.value?[{id:d.value.id,title:d.value.title,noteCount:d.value.noteCount}]:[]),B=o.computed(()=>{const e=c.value.map(e=>e.chapterName).filter(e=>Boolean(e&&e.trim()));return Array.from(new Set(e))}),j=o.ref(0),D=o.computed(()=>j.value+49.718+16),T=[{name:"修改时间（新→旧）",key:"modifiedDesc"},{name:"标题（A→Z）",key:"titleAZ"},{name:"创建时间（旧→新）",key:"createdAsc"}],A=new Intl.Collator("zh"),I=[{text:"删除书籍",color:"#dc2626"}],N=o.computed(()=>{var e;return(null==(e=T.find(e=>e.key===b.value))?void 0:e.name)||"修改时间（新→旧）"});o.onLoad(e=>{const t=i.createContext();e.id?(k.value=parseInt(e.id),r.logger.info(t,"[BookDetail] 页面加载",{bookId:k.value})):(r.logger.error(t,"[BookDetail] 缺少书籍ID"),o.index.showToast({title:"书籍ID不存在",icon:"error"}),setTimeout(()=>o.index.navigateBack(),1500))}),o.onMounted(()=>e(this,null,function*(){q(),yield z()})),o.onShow(()=>e(this,null,function*(){const e=i.createContext();r.logger.debug(e,"[BookDetail] 页面显示"),k.value&&c.value.length>0&&(yield S())}));const q=()=>{const e=i.createContext();try{const t=o.index.getWindowInfo();j.value=t.statusBarHeight||0,r.logger.debug(e,"[updateSafeArea] 状态栏高度",{height:j.value})}catch(t){r.logger.error(e,"[updateSafeArea] 获取系统信息失败",t),j.value=20}},M=()=>{const e=i.createContext();r.logger.debug(e,"[handleBack] 返回上一页"),o.index.navigateBack({fail:()=>{r.logger.warn(e,"[handleBack] 无法返回，跳转到首页"),o.index.switchTab({url:"/pages/index/index"})}})},z=()=>e(this,null,function*(){const e=i.createContext();if(k.value)try{p.value=!0,r.logger.info(e,"[loadBookDetail] 开始加载书籍详情",{bookId:k.value});const[o]=yield Promise.all([s.fetchBookDetail(k.value),S(),$()]);d.value=o,r.logger.info(e,"[loadBookDetail] 书籍详情加载成功",{title:o.title,noteCount:o.noteCount})}catch(t){r.logger.error(e,"[loadBookDetail] 加载书籍详情失败",t),o.index.showToast({title:"加载失败",icon:"error"})}finally{p.value=!1}else r.logger.error(e,"[loadBookDetail] 书籍ID为空")}),S=()=>e(this,null,function*(){const e=i.createContext();try{m.value=!0,r.logger.debug(e,"[loadNotes] 开始加载笔记列表",{bookId:k.value});const o=yield a.getNotesByBook(k.value,{page:1,pageSize:20});c.value=o.list||[],L(b.value),r.logger.info(e,"[loadNotes] 笔记列表加载成功",{count:c.value.length})}catch(t){r.logger.error(e,"[loadNotes] 加载笔记列表失败",t),c.value=[],o.index.showToast({title:"笔记加载失败",icon:"error"})}finally{m.value=!1}}),$=()=>e(this,null,function*(){const e=i.createContext();try{r.logger.debug(e,"[checkMindMap] 检查思维导图",{bookId:k.value});const o=yield l.getMindmapByBook(k.value);o&&o.id?(g.value=o,v.value=!0,r.logger.info(e,"[checkMindMap] 发现思维导图",{id:o.id})):(v.value=!1,r.logger.debug(e,"[checkMindMap] 未找到思维导图"))}catch(o){10004!==(null==o?void 0:o.code)&&r.logger.error(e,"[checkMindMap] 检查思维导图失败",o),v.value=!1}}),L=e=>{b.value=e;const o=[...c.value];switch(e){case"titleAZ":o.sort((e,o)=>A.compare(e.title||"",o.title||""));break;case"createdAsc":o.sort((e,o)=>new Date(e.createdAt||0).getTime()-new Date(o.createdAt||0).getTime());break;default:o.sort((e,o)=>new Date(o.updatedAt||0).getTime()-new Date(e.updatedAt||0).getTime())}c.value=o;const t=i.createContext();r.logger.debug(t,"[sortNotesByKey] 更新排序方式",{sortKey:e,total:c.value.length})},F=e=>{const o=(null==e?void 0:e.key)||(null==e?void 0:e.value);o&&(L(o),h.value=!1)},_=()=>e(this,null,function*(){const e=o.getCurrentInstance(),t=null==e?void 0:e.proxy,a=o.index.createSelectorQuery();(null==t?void 0:t.$scope)&&a.in(t),yield o.nextTick$1(),a.select("#sort-trigger").boundingClientRect(e=>{if(e&&!Array.isArray(e)&&e.width){const o=e.left,t=e.bottom+8;y.value={x:o,y:t,w:e.width},x.value=!0}else h.value=!0}).exec()}),P=()=>{x.value=!1},K=()=>{f.value=!0},R=e=>{0===e&&Z()},Z=()=>{const t=i.createContext();o.index.showModal({title:"确认删除书籍",content:"删除后,该书籍下的笔记仍会保留在笔记列表中",confirmText:"确认删除",confirmColor:"#dc2626",success:a=>e(this,null,function*(){if(a.confirm)try{r.logger.info(t,"[handleDeleteBook] 开始删除书籍",{bookId:k.value}),o.index.showLoading({title:"删除中...",mask:!0}),yield n.deleteBook(k.value),o.index.hideLoading(),o.index.showToast({title:"删除成功",icon:"success"}),r.logger.info(t,"[handleDeleteBook] 书籍删除成功"),setTimeout(()=>{o.index.navigateBack()},1500)}catch(e){o.index.hideLoading(),r.logger.error(t,"[handleDeleteBook] 删除书籍失败",e),o.index.showToast({title:"删除失败",icon:"error"})}})})},H=()=>{const e=i.createContext();r.logger.info(e,"[handleFabClick] FAB按钮被点击"),w.value=!0},Q=()=>{const e=i.createContext();r.logger.info(e,"[handleAddNote] 点击添加笔记"),w.value=!0},U=()=>{const e=i.createContext();r.logger.debug(e,"[goToMindMap] 跳转到思维导图",{bookId:k.value}),o.index.navigateTo({url:`/pages-mindmap/view/view?bookId=${k.value}`})},E=e=>{const t=i.createContext();r.logger.info(t,"[onCreateNoteSubmit] 确认创建笔记",e);let a=`/pages-note/edit/edit?bookId=${e.bookId}`;e.chapterTitle&&(a+=`&chapter=${encodeURIComponent(e.chapterTitle)}`),o.index.navigateTo({url:a}),w.value=!1},G=(e,o)=>{const t=[];return e&&t.push(e),"number"!=typeof o||Number.isNaN(o)||t.push(`第${o}页`),t.join(" · ")},J=e=>{if(!e)return"";const o=new Date(e),t=(new Date).getTime()-o.getTime(),a=Math.floor(t/6e4),l=Math.floor(t/36e5),n=Math.floor(t/864e5);return a<60?`${a}分钟前`:l<24?`${l}小时前`:n<7?`${n}天前`:o.toLocaleDateString("zh-CN")};return(e,t)=>{var a,l,n,u,s,A,q;return o.e({a:o.o(M),b:o.p({name:"more-dot-fill",size:20,color:"#333333"}),c:o.o(K),d:j.value+"px",e:o.p({src:null==(a=d.value)?void 0:a.coverUrl,width:128,ratio:3/4,radius:16,padding:12,"bg-color":"#F5F7FA",shadow:!0}),f:o.t((null==(l=d.value)?void 0:l.title)||"未知书籍"),g:null==(n=d.value)?void 0:n.author},(null==(u=d.value)?void 0:u.author)?{h:o.t(d.value.author)}:{},{i:o.t((null==(s=d.value)?void 0:s.noteCount)||0),j:v.value},v.value?{k:o.p({name:"grid",size:20,color:"#00a82d"}),l:o.p({name:"grid",size:24,color:"#ffffff"}),m:o.t((null==(A=g.value)?void 0:A.title)||"思维导图"),n:o.t(J(null==(q=g.value)?void 0:q.updatedAt)),o:o.p({name:"arrow-right",size:16,color:"#999999"}),p:o.o(U)}:{},{q:o.p({name:"file-text",size:20,color:"#00a82d"}),r:o.t(o.unref(N)),s:o.p({name:x.value?"arrow-up":"arrow-down",size:12,color:"#666666"}),t:o.o(_),v:o.f(o.unref(T),(e,t,a)=>o.e({a:o.t(e.name),b:e.key===b.value},e.key===b.value?{c:"b60b4379-8-"+a+",b60b4379-7",d:o.p({name:"checkmark",size:14,color:"#00a82d"})}:{},{e:e.key,f:o.o(o=>{return t=e.key,L(t),void P();var t},e.key)})),w:o.o(P),x:o.p({open:x.value,x:y.value.x,y:y.value.y,width:y.value.w}),y:m.value&&0===c.value.length},m.value&&0===c.value.length?{z:o.p({rows:3})}:0===c.value.length?{B:o.p({name:"edit-pen",size:32,color:"#00a82d"}),C:o.o(Q),D:o.p({type:"primary",text:"添加第一条笔记",size:"small"})}:{E:o.f(c.value,(e,t,a)=>o.e({a:o.t(e.title),b:"b60b4379-12-"+a,c:o.t(J(e.updatedAt)),d:e.chapterName||e.pageNumber},e.chapterName||e.pageNumber?{e:"b60b4379-13-"+a,f:o.p({name:"file-text",size:12,color:"#666666"}),g:o.t(G(e.chapterName,e.pageNumber))}:{},{h:o.t(e.content),i:e.tags&&e.tags.length>0},e.tags&&e.tags.length>0?{j:o.f(e.tags,(e,t,a)=>({a:o.t(e),b:e}))}:{},{k:e.id,l:o.o(t=>(e=>{const t=i.createContext();r.logger.debug(t,"[goToNoteDetail] 跳转到笔记详情",{noteId:e.id}),o.index.navigateTo({url:`/pages-note/edit/edit?id=${e.id}`})})(e),e.id)})),F:o.p({name:"clock",size:12,color:"#999999"})},{A:0===c.value.length,G:o.unref(D)+"px",H:o.o(H),I:o.o(R),J:o.o(e=>f.value=e),K:o.p({list:I,modelValue:f.value}),L:o.o(E),M:o.o(e=>w.value=e),N:o.p({"initial-books":o.unref(C),"initial-book-id":k.value,chapters:o.unref(B),open:w.value}),O:o.o(F),P:o.o(e=>h.value=!1),Q:o.p({show:h.value,actions:o.unref(T),title:"排序方式"}),R:o.p({loading:p.value,"bg-color":"#fafafa"})})}}}),p=o._export_sfc(v,[["__scopeId","data-v-b60b4379"]]);wx.createPage(p);
