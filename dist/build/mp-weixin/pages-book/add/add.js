"use strict";var e=Object.defineProperty,r=Object.defineProperties,o=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(r,o,t)=>o in r?e(r,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[o]=t,s=(e,r,o)=>new Promise((t,i)=>{var a=e=>{try{s(o.next(e))}catch(r){i(r)}},l=e=>{try{s(o.throw(e))}catch(r){i(r)}},s=e=>e.done?t(e.value):Promise.resolve(e.value).then(a,l);s((o=o.apply(e,r)).next())});const n=require("../../common/vendor.js"),u=require("../../stores/modules/book.js");require("../../utils/request.js");const p=require("../../constants/validation.js"),c=require("../../utils/logger.js"),d=require("../../utils/logger-helpers.js");if(require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(n.resolveComponent("u-image")+n.resolveComponent("u-icon")+n.resolveComponent("u-input")+n.resolveComponent("u-form-item")+n.resolveComponent("u--textarea")+n.resolveComponent("u-form")+n.resolveComponent("u-button"))()}Math||(g+b)();const g=()=>"../../components/common/AppNavBar.js",b=()=>"../../components/business/IsbnScanner.js",h=n.defineComponent({__name:"add",setup(e,{expose:g}){const b=u.useBookStore(),h=n.ref(null),m=n.computed(()=>!!h.value),v=n.computed(()=>m.value?"编辑书籍":"添加书籍"),_=n.ref(!1),f=n.ref(""),B=n.reactive({title:"",author:"",publisher:"",description:"",cover:"",pages:"",publishYear:"",isbn:""}),x=n.ref();g({validatePages:e=>{if(!e)return!0;const r=parseInt(e);return!isNaN(r)&&r>=p.BOOK_PAGES_MIN&&r<=p.BOOK_PAGES_MAX&&Number.isInteger(r)},validatePublishYear:e=>{if(!e)return!0;const r=parseInt(e),o=(new Date).getFullYear();return!isNaN(r)&&r>=p.PUBLISH_YEAR_MIN&&r<=o}});const A={title:[{required:!0,message:"请输入书名",trigger:"blur"},{min:1,max:p.BOOK_NAME_MAX_LENGTH,message:`书名长度不能超过${p.BOOK_NAME_MAX_LENGTH}个字符`,trigger:"blur"}],author:[{max:p.AUTHOR_NAME_MAX_LENGTH,message:`作者名称不能超过${p.AUTHOR_NAME_MAX_LENGTH}个字符`,trigger:"blur"}],publisher:[{max:p.PUBLISHER_NAME_MAX_LENGTH,message:`出版社名称不能超过${p.PUBLISHER_NAME_MAX_LENGTH}个字符`,trigger:"blur"}],pages:[{validator:(e,r,o)=>{if(!r)return void o();const t=parseInt(r);isNaN(t)||t<p.BOOK_PAGES_MIN||t>p.BOOK_PAGES_MAX||!Number.isInteger(t)?o(new Error(`页数必须是${p.BOOK_PAGES_MIN}-${p.BOOK_PAGES_MAX}之间的正整数`)):o()},message:`页数必须是${p.BOOK_PAGES_MIN}-${p.BOOK_PAGES_MAX}之间的正整数`,trigger:"blur"}],publishYear:[{validator:(e,r,o)=>{if(!r)return void o();const t=parseInt(r),i=(new Date).getFullYear();isNaN(t)||t<p.PUBLISH_YEAR_MIN||t>i?o(new Error(`出版年份必须在${p.PUBLISH_YEAR_MIN}年至${i}年之间`)):o()},message:`出版年份必须在${p.PUBLISH_YEAR_MIN}年至今之间`,trigger:"blur"}],description:[{max:p.BOOK_DESCRIPTION_MAX_LENGTH,message:`简介不能超过${p.BOOK_DESCRIPTION_MAX_LENGTH}个字符`,trigger:"blur"}]};n.onLoad(e=>s(this,null,function*(){const r=d.createContext();(null==e?void 0:e.id)?(h.value=parseInt(e.id),c.logger.info(r,"[AddBookPage] 编辑模式，书籍ID:",h.value),yield N()):c.logger.info(r,"[AddBookPage] 新增模式")}));const N=()=>s(this,null,function*(){var e,r;const o=d.createContext();if(h.value)try{n.index.showLoading({title:"加载中..."});const t=yield b.fetchBookDetail(h.value);B.title=t.title||"",B.author=t.author||"",B.publisher=t.publisher||"",B.description=t.description||"",B.cover=t.coverUrl||"",B.pages=(null==(e=t.pages)?void 0:e.toString())||"",B.publishYear=(null==(r=t.publishYear)?void 0:r.toString())||"",B.isbn=t.isbn||"",c.logger.info(o,"[loadBookDetail] 书籍详情加载成功")}catch(t){c.logger.error(o,"[loadBookDetail] 加载书籍详情失败",t),n.index.showToast({title:"加载失败",icon:"error"}),setTimeout(()=>{n.index.navigateBack()},1500)}finally{n.index.hideLoading()}}),O=()=>{const e=d.createContext();n.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:r=>{c.logger.info(e,"[chooseCover] 选择图片成功"),B.cover=r.tempFilePaths[0]},fail:r=>{c.logger.error(e,"[chooseCover] 选择图片失败",r)}})},I=e=>{const r=d.createContext();c.logger.info(r,"[handleBookFound] 通过ISBN找到书籍",{isbn:e.isbn,title:e.title}),e.isbn&&(B.isbn=e.isbn),e.title&&(B.title=e.title),e.author&&(B.author=e.author),e.publisher&&(B.publisher=e.publisher),e.description&&(B.description=e.description),e.coverUrl&&(B.cover=e.coverUrl),e.pages&&(B.pages=e.pages.toString()),e.publishYear&&(B.publishYear=e.publishYear.toString()),"manual"===e.source&&n.index.showToast({title:"请完善书籍信息",icon:"none"})},E=e=>{const r=d.createContext();c.logger.info(r,"[handleScanComplete] ISBN扫码完成",{isbn:e}),f.value=e,B.isbn=e},S=()=>s(this,null,function*(){const e=d.createContext();try{if(!(yield x.value.validate()))return void c.logger.warn(e,"[handleSave] 表单验证失败");_.value=!0,n.index.showLoading({title:"保存中..."});const p={title:B.title.trim(),author:B.author.trim()||void 0,publisher:B.publisher.trim()||void 0,description:B.description.trim()||void 0,coverUrl:B.cover||void 0,pages:B.pages?parseInt(B.pages):void 0,publishYear:B.publishYear?parseInt(B.publishYear):void 0,isbn:B.isbn.trim()||void 0};if(m.value)c.logger.info(e,"[handleSave] 更新书籍",{bookId:h.value}),yield b.updateBook((s=((e,r)=>{for(var o in r||(r={}))i.call(r,o)&&l(e,o,r[o]);if(t)for(var o of t(r))a.call(r,o)&&l(e,o,r[o]);return e})({},p),u={id:h.value},r(s,o(u)))),n.index.showToast({title:"更新成功",icon:"success"});else{c.logger.info(e,"[handleSave] 创建书籍");const r=yield b.createBook(p);c.logger.info(e,"[handleSave] 书籍创建成功",{bookId:r.id}),n.index.showToast({title:"添加成功",icon:"success"})}setTimeout(()=>{n.index.navigateBack()},1500)}catch(p){c.logger.error(e,"[handleSave] 保存失败",p),n.index.showToast({title:p.message||"保存失败",icon:"error"})}finally{_.value=!1,n.index.hideLoading()}var s,u});return(e,r)=>n.e({a:n.p({title:n.unref(v)}),b:!n.unref(m)},n.unref(m)?{}:{c:n.o(I),d:n.o(E),e:n.o(e=>f.value=e),f:n.p({modelValue:f.value})},{g:B.cover},B.cover?{h:n.p({src:B.cover,mode:"aspectFit",width:"200rpx",height:"280rpx",radius:"8"})}:{i:n.p({name:"photo",size:"40",color:"#999"})},{j:n.o(O),k:n.o(e=>B.title=e),l:n.p({placeholder:"请输入书名",clearable:!0,modelValue:B.title}),m:n.p({label:"书名",prop:"title",required:!0,borderBottom:!0}),n:n.o(e=>B.author=e),o:n.p({placeholder:"请输入作者名称（选填）",clearable:!0,modelValue:B.author}),p:n.p({label:"作者",prop:"author",borderBottom:!0}),q:n.o(e=>B.publisher=e),r:n.p({placeholder:"请输入出版社名称（选填）",clearable:!0,modelValue:B.publisher}),s:n.p({label:"出版社",prop:"publisher",borderBottom:!0}),t:n.o(e=>B.pages=e),v:n.p({type:"number",placeholder:"请输入页数（选填）",clearable:!0,modelValue:B.pages}),w:n.p({label:"页数",prop:"pages",borderBottom:!0}),x:n.o(e=>B.publishYear=e),y:n.p({type:"number",placeholder:"请输入出版年份（选填）",clearable:!0,modelValue:B.publishYear}),z:n.p({label:"出版年份",prop:"publishYear",borderBottom:!0}),A:n.o(e=>B.description=e),B:n.p({placeholder:"请输入书籍简介（选填）",count:!0,maxlength:"500",height:"200rpx",modelValue:B.description}),C:n.p({label:"简介",prop:"description",borderBottom:!0}),D:n.sr(x,"3b11ecc0-2",{k:"formRef"}),E:n.p({model:B,rules:A,"label-position":"left","label-width":"160rpx"}),F:n.o(S),G:n.p({type:"primary",text:"保存",size:"large",loading:_.value,customStyle:{borderRadius:"48rpx",height:"96rpx"}})})}}),m=n._export_sfc(h,[["__scopeId","data-v-3b11ecc0"]]);wx.createPage(m);
