"use strict";var e=Object.defineProperty,o=Object.defineProperties,r=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,l=(o,r,t)=>r in o?e(o,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[r]=t,a=(e,o,r)=>new Promise((t,i)=>{var s=e=>{try{a(r.next(e))}catch(o){i(o)}},l=e=>{try{a(r.throw(e))}catch(o){i(o)}},a=e=>e.done?t(e.value):Promise.resolve(e.value).then(s,l);a((r=r.apply(e,o)).next())});const n=require("../../common/vendor.js"),u=require("../../stores/modules/book.js");require("../../utils/request.js");const p=require("../../constants/validation.js"),d=require("../../utils/logger.js"),c=require("../../utils/logger-helpers.js");if(require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(n.resolveComponent("u-icon")+n.resolveComponent("u-input")+n.resolveComponent("u-form-item")+n.resolveComponent("u-textarea")+n.resolveComponent("u-form")+n.resolveComponent("u-button"))()}Math||(g+m+(()=>"../../node-modules/uview-plus/components/u-icon/u-icon.js")+b+(()=>"../../node-modules/uview-plus/components/u-input/u-input.js")+(()=>"../../node-modules/uview-plus/components/u-form-item/u-form-item.js")+(()=>"../../node-modules/uview-plus/components/u-textarea/u-textarea.js")+(()=>"../../node-modules/uview-plus/components/u-form/u-form.js")+(()=>"../../node-modules/uview-plus/components/u-button/u-button.js"))();const g=()=>"../../components/common/AppNavBar.js",m=()=>"../../components/business/IsbnScanner.js",b=()=>"../../components/book/BookCover.js",h=n.defineComponent({__name:"add",setup(e,{expose:g}){const m=u.useBookStore(),b=n.ref(null),h=n.computed(()=>!!b.value),v=n.computed(()=>h.value?"编辑书籍":"添加书籍"),_=n.ref(!1),f=n.ref(""),B=n.reactive({title:"",author:"",publisher:"",description:"",cover:"",pages:"",publishYear:"",isbn:""}),A=n.ref();g({validatePages:e=>{if(!e)return!0;const o=parseInt(e);return!isNaN(o)&&o>=p.BOOK_PAGES_MIN&&o<=p.BOOK_PAGES_MAX&&Number.isInteger(o)},validatePublishYear:e=>{if(!e)return!0;const o=parseInt(e),r=(new Date).getFullYear();return!isNaN(o)&&o>=p.PUBLISH_YEAR_MIN&&o<=r}});const x={title:[{required:!0,message:"请输入书名",trigger:"blur"},{min:1,max:p.BOOK_NAME_MAX_LENGTH,message:`书名长度不能超过${p.BOOK_NAME_MAX_LENGTH}个字符`,trigger:"blur"}],author:[{max:p.AUTHOR_NAME_MAX_LENGTH,message:`作者名称不能超过${p.AUTHOR_NAME_MAX_LENGTH}个字符`,trigger:"blur"}],publisher:[{max:p.PUBLISHER_NAME_MAX_LENGTH,message:`出版社名称不能超过${p.PUBLISHER_NAME_MAX_LENGTH}个字符`,trigger:"blur"}],pages:[{validator:(e,o,r)=>{if(!o)return void r();const t=parseInt(o);isNaN(t)||t<p.BOOK_PAGES_MIN||t>p.BOOK_PAGES_MAX||!Number.isInteger(t)?r(new Error(`页数必须是${p.BOOK_PAGES_MIN}-${p.BOOK_PAGES_MAX}之间的正整数`)):r()},message:`页数必须是${p.BOOK_PAGES_MIN}-${p.BOOK_PAGES_MAX}之间的正整数`,trigger:"blur"}],publishYear:[{validator:(e,o,r)=>{if(!o)return void r();const t=parseInt(o),i=(new Date).getFullYear();isNaN(t)||t<p.PUBLISH_YEAR_MIN||t>i?r(new Error(`出版年份必须在${p.PUBLISH_YEAR_MIN}年至${i}年之间`)):r()},message:`出版年份必须在${p.PUBLISH_YEAR_MIN}年至今之间`,trigger:"blur"}],description:[{max:p.BOOK_DESCRIPTION_MAX_LENGTH,message:`简介不能超过${p.BOOK_DESCRIPTION_MAX_LENGTH}个字符`,trigger:"blur"}]};n.onLoad(e=>a(this,null,function*(){const o=c.createContext();(null==e?void 0:e.id)?(b.value=parseInt(e.id),d.logger.info(o,"[AddBookPage] 编辑模式，书籍ID:",b.value),yield N()):d.logger.info(o,"[AddBookPage] 新增模式")}));const N=()=>a(this,null,function*(){var e,o;const r=c.createContext();if(b.value)try{n.index.showLoading({title:"加载中..."});const t=yield m.fetchBookDetail(b.value);B.title=t.title||"",B.author=t.author||"",B.publisher=t.publisher||"",B.description=t.description||"",B.cover=t.coverUrl||"",B.pages=(null==(e=t.pages)?void 0:e.toString())||"",B.publishYear=(null==(o=t.publishYear)?void 0:o.toString())||"",B.isbn=t.isbn||"",d.logger.info(r,"[loadBookDetail] 书籍详情加载成功")}catch(t){d.logger.error(r,"[loadBookDetail] 加载书籍详情失败",t),n.index.showToast({title:"加载失败",icon:"error"}),setTimeout(()=>{n.index.navigateBack()},1500)}finally{n.index.hideLoading()}}),O=()=>{const e=c.createContext();n.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:o=>{d.logger.info(e,"[chooseCover] 选择图片成功"),B.cover=o.tempFilePaths[0]},fail:o=>{d.logger.error(e,"[chooseCover] 选择图片失败",o)}})},I=e=>{const o=c.createContext();d.logger.info(o,"[handleBookFound] 通过ISBN找到书籍",{isbn:e.isbn,title:e.title}),e.isbn&&(B.isbn=e.isbn),e.title&&(B.title=e.title),e.author&&(B.author=e.author),e.publisher&&(B.publisher=e.publisher),e.description&&(B.description=e.description),e.coverUrl&&(B.cover=e.coverUrl),e.pages&&(B.pages=e.pages.toString()),e.publishYear&&(B.publishYear=e.publishYear.toString()),"manual"===e.source&&n.index.showToast({title:"请完善书籍信息",icon:"none"})},E=e=>{const o=c.createContext();d.logger.info(o,"[handleScanComplete] ISBN扫码完成",{isbn:e}),f.value=e,B.isbn=e},S=()=>a(this,null,function*(){const e=c.createContext();try{if(!(yield A.value.validate()))return void d.logger.warn(e,"[handleSave] 表单验证失败");_.value=!0,n.index.showLoading({title:"保存中..."});const p={title:B.title.trim(),author:B.author.trim()||void 0,publisher:B.publisher.trim()||void 0,description:B.description.trim()||void 0,coverUrl:B.cover||void 0,pages:B.pages?parseInt(B.pages):void 0,publishYear:B.publishYear?parseInt(B.publishYear):void 0,isbn:B.isbn.trim()||void 0};if(h.value)d.logger.info(e,"[handleSave] 更新书籍",{bookId:b.value}),yield m.updateBook((a=((e,o)=>{for(var r in o||(o={}))i.call(o,r)&&l(e,r,o[r]);if(t)for(var r of t(o))s.call(o,r)&&l(e,r,o[r]);return e})({},p),u={id:b.value},o(a,r(u)))),n.index.showToast({title:"更新成功",icon:"success"});else{d.logger.info(e,"[handleSave] 创建书籍");const o=yield m.createBook(p);d.logger.info(e,"[handleSave] 书籍创建成功",{bookId:o.id}),n.index.showToast({title:"添加成功",icon:"success"})}setTimeout(()=>{n.index.navigateBack()},1500)}catch(p){d.logger.error(e,"[handleSave] 保存失败",p),n.index.showToast({title:p.message||"保存失败",icon:"error"})}finally{_.value=!1,n.index.hideLoading()}var a,u});return(e,o)=>n.e({a:n.p({title:n.unref(v)}),b:!n.unref(h)},n.unref(h)?{}:{c:n.o(I),d:n.o(E),e:n.o(e=>f.value=e),f:n.p({modelValue:f.value})},{g:!B.cover},B.cover?{}:{h:n.p({name:"photo",size:"40",color:"#999"})},{i:n.p({src:B.cover,width:200,ratio:3/4,radius:16,padding:12,shadow:!0,"bg-color":"#F5F7FA"}),j:n.o(O),k:n.o(e=>B.title=e),l:n.p({placeholder:"请输入书名",clearable:!0,modelValue:B.title}),m:n.p({label:"书名",prop:"title",required:!0,borderBottom:!0}),n:n.o(e=>B.author=e),o:n.p({placeholder:"请输入作者名称（选填）",clearable:!0,modelValue:B.author}),p:n.p({label:"作者",prop:"author",borderBottom:!0}),q:n.o(e=>B.publisher=e),r:n.p({placeholder:"请输入出版社名称（选填）",clearable:!0,modelValue:B.publisher}),s:n.p({label:"出版社",prop:"publisher",borderBottom:!0}),t:n.o(e=>B.pages=e),v:n.p({type:"number",placeholder:"请输入页数（选填）",clearable:!0,modelValue:B.pages}),w:n.p({label:"页数",prop:"pages",borderBottom:!0}),x:n.o(e=>B.publishYear=e),y:n.p({type:"number",placeholder:"请输入出版年份（选填）",clearable:!0,modelValue:B.publishYear}),z:n.p({label:"出版年份",prop:"publishYear",borderBottom:!0}),A:n.o(e=>B.description=e),B:n.p({placeholder:"请输入书籍简介（选填）",count:!0,maxlength:"500",height:"200rpx",modelValue:B.description}),C:n.p({label:"简介",prop:"description",borderBottom:!0}),D:n.sr(A,"2853b47e-2",{k:"formRef"}),E:n.p({model:B,rules:x,"label-position":"left","label-width":"160rpx"}),F:n.o(S),G:n.p({type:"primary",text:"保存",size:"large",loading:_.value,customStyle:{borderRadius:"48rpx",height:"96rpx"}})})}}),v=n._export_sfc(h,[["__scopeId","data-v-2853b47e"]]);wx.createPage(v);
