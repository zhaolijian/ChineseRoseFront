"use strict";var e=(e,o,t)=>new Promise((r,a)=>{var l=e=>{try{i(t.next(e))}catch(o){a(o)}},s=e=>{try{i(t.throw(e))}catch(o){a(o)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(l,s);i((t=t.apply(e,o)).next())});const o=require("../../common/vendor.js"),t=require("../../stores/modules/book.js"),r=require("../../stores/modules/note.js");require("../../utils/request.js");const a=require("../../utils/logger.js"),l=require("../../utils/logger-helpers.js"),s=require("../../utils/auth-guard.js");if(require("../../api/modules/note.js"),require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(o.resolveComponent("u-icon")+o.resolveComponent("u-image")+o.resolveComponent("u-input")+o.resolveComponent("u-textarea")+o.resolveComponent("u-button")+o.resolveComponent("u-popup")+o.resolveComponent("u-loading-page"))()}const i=o.defineComponent({__name:"add",setup(i){const n=t.useBookStore(),c=r.useNoteStore(),u=o.reactive({title:"",content:"",bookId:void 0,noteType:"reading",pageNumber:"",chapterName:"",tags:[],images:[]}),d=o.ref([]),m=o.ref(null),p=o.ref(""),g=o.ref(!1),h=o.ref(!1),v=[{key:"reading",label:"阅读笔记",icon:"book"},{key:"thought",label:"思考感悟",icon:"heart"},{key:"quote",label:"摘录",icon:"quote-left"},{key:"summary",label:"总结",icon:"list"}],f=o.computed(()=>u.title.trim()&&u.content.trim()&&m.value);o.onLoad(e=>{if(e.bookId){const o=parseInt(e.bookId);u.bookId=o,y(o)}if(e.ocrText)try{const t=decodeURIComponent(e.ocrText);if(u.content=t,!u.title.trim()&&t.length>0){const e=t.trim().substring(0,20).replace(/\n/g," ");u.title=e+(t.length>20?"...":"")}o.index.showToast({title:"OCR内容已导入",icon:"success"})}catch(t){console.error("解析OCR文本失败:",t),o.index.showToast({title:"OCR内容导入失败",icon:"none"})}}),o.onMounted(()=>e(this,null,function*(){yield b()}));const b=()=>e(this,null,function*(){try{const e=yield n.fetchBooks(1,{pageSize:100});if(d.value=e.books,u.bookId){const e=d.value.find(e=>e.id===u.bookId);e&&(m.value=e)}}catch(e){console.error("加载书籍列表失败:",e)}}),y=o=>e(this,null,function*(){try{const e=yield n.fetchBookDetail(o);m.value=e}catch(e){console.error("加载书籍详情失败:",e)}}),k=()=>{const e=p.value.trim();e&&!u.tags.includes(e)&&u.tags.length<5&&(u.tags.push(e),p.value="")},x=()=>{o.index.chooseImage({count:9-u.images.length,sizeType:["compressed"],sourceType:["camera","album"],success:e=>{u.images.push(...e.tempFilePaths)}})},w=()=>{o.index.navigateTo({url:"/pages-note/ocr/ocr"})},I=()=>{o.index.showToast({title:"功能开发中",icon:"none"})},q=()=>e(this,null,function*(){const e=l.createContext();if(yield s.ensureLoggedIn("保存笔记"))if(f.value)try{g.value=!0;const t={title:u.title.trim(),content:u.content.trim(),bookId:u.bookId,pageNumber:u.pageNumber?parseInt(u.pageNumber):void 0,chapter:u.chapterName.trim()||void 0};a.logger.info(e,"[NoteAdd] 开始保存笔记",{title:t.title,bookId:t.bookId,contentLength:t.content.length}),yield c.createNote(t),a.logger.info(e,"[NoteAdd] 笔记保存成功"),o.index.showToast({title:"保存成功",icon:"success"}),setTimeout(()=>{o.index.navigateBack()},1500)}catch(t){a.logger.error(e,"[NoteAdd] 保存笔记失败",t),o.index.showToast({title:"保存失败",icon:"error"})}finally{g.value=!1}else o.index.showToast({title:"请填写完整信息",icon:"error"})}),j=()=>{u.title.trim()||u.content.trim()?o.index.showModal({title:"确认退出",content:"当前有未保存的内容，确定要退出吗？",success:e=>{e.confirm&&o.index.navigateBack()}}):o.index.navigateBack()};return(e,t)=>o.e({a:o.p({name:"arrow-left",size:"20",color:"#333"}),b:o.o(j),c:o.unref(f)?"":1,d:o.o(q),e:!m.value},(m.value,{}),{f:m.value},m.value?{g:o.p({src:m.value.coverUrl||"/static/images/book-placeholder.png",width:"40px",height:"54px",radius:"4",mode:"aspectFit"}),h:o.t(m.value.title),i:o.t(m.value.author),j:o.p({name:"arrow-right",size:"16",color:"#999"})}:{k:o.p({name:"book",size:"20",color:"#999"}),l:o.p({name:"arrow-right",size:"16",color:"#999"})},{m:o.o(e=>h.value=!0),n:o.o(e=>u.title=e),o:o.p({placeholder:"请输入笔记标题",border:!1,"custom-style":e.inputStyle,maxlength:"100","show-word-limit":!0,modelValue:u.title}),p:o.f(v,(e,t,r)=>({a:"f6f97da3-6-"+r,b:o.p({name:e.icon,size:"18",color:u.noteType===e.key?"#00a82d":"#999"}),c:o.t(e.label),d:e.key,e:u.noteType===e.key?1:"",f:o.o(o=>u.noteType=e.key,e.key)})),q:o.o(e=>u.pageNumber=e),r:o.p({placeholder:"页码",type:"number",border:!1,"custom-style":e.smallInputStyle,modelValue:u.pageNumber}),s:o.o(e=>u.chapterName=e),t:o.p({placeholder:"章节名称",border:!1,"custom-style":e.smallInputStyle,modelValue:u.chapterName}),v:o.o(e=>u.content=e),w:o.p({placeholder:"请输入笔记内容...",border:!1,"custom-style":e.textareaStyle,"auto-height":!0,maxlength:"5000","show-word-limit":!0,modelValue:u.content}),x:u.tags.length>0},u.tags.length>0?{y:o.f(u.tags,(e,t,r)=>({a:o.t(e),b:o.o(e=>(e=>{u.tags.splice(e,1)})(t),t),c:"f6f97da3-10-"+r,d:t})),z:o.p({name:"close",size:"12",color:"#999"})}:{},{A:o.o(k),B:o.o(e=>p.value=e),C:o.p({placeholder:"添加标签...",border:!1,"custom-style":e.tagInputStyle,modelValue:p.value}),D:o.o(k),E:o.p({text:"添加",size:"small",type:"primary",disabled:!p.value.trim()}),F:u.images.length>0},u.images.length>0?{G:o.f(u.images,(e,t,r)=>({a:o.o(e=>(e=>{o.index.previewImage({urls:u.images,current:e})})(t),t),b:"f6f97da3-13-"+r,c:o.p({src:e,width:"80px",height:"80px",radius:"8",mode:"aspectFill"}),d:"f6f97da3-14-"+r,e:o.o(e=>(e=>{u.images.splice(e,1)})(t),t),f:t})),H:o.p({name:"close",size:"12",color:"#fff"})}:{},{I:o.p({name:"camera",size:"20",color:"#00a82d"}),J:o.o(x),K:o.p({name:"scan",size:"20",color:"#00a82d"}),L:o.o(w),M:o.p({name:"mic",size:"20",color:"#00a82d"}),N:o.o(I),O:o.f(d.value,(e,t,r)=>{var a,l;return o.e({a:"f6f97da3-19-"+r+",f6f97da3-18",b:o.p({src:e.coverUrl||"/static/images/book-placeholder.png",width:"40px",height:"54px",radius:"4",mode:"aspectFit"}),c:o.t(e.title),d:o.t(e.author),e:(null==(a=m.value)?void 0:a.id)===e.id},(null==(l=m.value)?void 0:l.id)===e.id?{f:"f6f97da3-20-"+r+",f6f97da3-18",g:o.p({name:"checkmark",size:"16",color:"#00a82d"})}:{},{h:e.id,i:o.o(o=>(e=>{m.value=e,u.bookId=e.id,h.value=!1})(e),e.id)})}),P:o.o(e=>h.value=e),Q:o.p({mode:"bottom",height:"60%",round:"20",closeable:!0,modelValue:h.value}),R:o.p({loading:g.value,"bg-color":"rgba(255,255,255,0.8)"})})}}),n=o._export_sfc(i,[["__scopeId","data-v-f6f97da3"]]);wx.createPage(n);
