"use strict";var e=Object.defineProperty,t=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,l=(t,r,o)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o,a=(e,a)=>{for(var u in a||(a={}))r.call(a,u)&&l(e,u,a[u]);if(t)for(var u of t(a))o.call(a,u)&&l(e,u,a[u]);return e},u=(e,t,r)=>new Promise((o,l)=>{var a=e=>{try{n(r.next(e))}catch(t){l(t)}},u=e=>{try{n(r.throw(e))}catch(t){l(t)}},n=e=>e.done?o(e.value):Promise.resolve(e.value).then(a,u);n((r=r.apply(e,t)).next())});const n=require("../../common/vendor.js"),c=require("../../api/modules/note.js");require("../../utils/request.js");const i=require("../../utils/logger.js"),s=require("../../utils/logger-helpers.js"),v=n.defineStore("note",()=>{const e=n.ref([]),t=n.ref(null),r=n.ref(1),o=n.ref(20),l=n.ref(0),v=n.ref(!0),g=n.ref(!1),f=n.ref(""),d=n.ref([]),y=n.ref("idle"),h=n.ref(""),N=n.ref({}),p=(...t)=>u(exports,[...t],function*(t=1,u={}){const n=s.createContext();try{g.value=!0,N.value=a({},u);const s=yield c.getNoteList(a({page:t,pageSize:o.value},u));return 1===t?e.value=[...s.list]:e.value.push(...s.list),r.value=s.page,l.value=s.total,v.value=s.hasMore,i.logger.debug(n,"[NoteStore] 获取笔记列表成功",{page:t,params:u,total:l.value}),s}catch(f){throw i.logger.error(n,"[NoteStore] 获取笔记列表失败",f),f}finally{g.value=!1}});return{notes:e,currentNote:t,currentPage:r,pageSize:o,total:l,hasMore:v,loading:g,searchKeyword:f,searchResults:d,syncStatus:y,lastSyncTime:h,fetchNotes:p,fetchNoteDetail:r=>u(exports,null,function*(){const o=s.createContext();try{g.value=!0;const l=yield c.getNoteDetail(r);t.value=l;const a=e.value.findIndex(e=>e.id===r);return-1!==a&&(e.value[a]=l),i.logger.debug(o,"[NoteStore] 获取笔记详情成功",{id:r}),l}catch(l){throw i.logger.error(o,"[NoteStore] 获取笔记详情失败",l),l}finally{g.value=!1}}),createNote:t=>u(exports,null,function*(){const r=s.createContext();try{g.value=!0;const o=yield c.createNote(t);return e.value.unshift(o),l.value+=1,i.logger.info(r,"[NoteStore] 创建笔记成功",{id:o.id}),o}catch(o){throw i.logger.error(r,"[NoteStore] 创建笔记失败",o),o}finally{g.value=!1}}),updateNote:(r,o)=>u(exports,null,function*(){var l;const a=s.createContext();try{g.value=!0;const u=yield c.updateNote(r,o),n=e.value.findIndex(e=>e.id===r);return-1!==n&&(e.value[n]=u),(null==(l=t.value)?void 0:l.id)===r&&(t.value=u),i.logger.info(a,"[NoteStore] 更新笔记成功",{id:r}),u}catch(u){throw i.logger.error(a,"[NoteStore] 更新笔记失败",u),u}finally{g.value=!1}}),deleteNote:r=>u(exports,null,function*(){var o;const a=s.createContext();try{g.value=!0,yield c.deleteNote(r),e.value=e.value.filter(e=>e.id!==r),l.value=Math.max(0,l.value-1),(null==(o=t.value)?void 0:o.id)===r&&(t.value=null),i.logger.info(a,"[NoteStore] 删除笔记成功",{id:r})}catch(u){throw i.logger.error(a,"[NoteStore] 删除笔记失败",u),u}finally{g.value=!1}}),searchNotes:(e,...t)=>u(exports,[e,...t],function*(e,t={}){const r=s.createContext(),o=e.trim();if(f.value=o,!o)return d.value=[],i.logger.debug(r,"[NoteStore] 搜索关键字为空，返回空结果"),[];try{g.value=!0;const e=yield c.searchNotes(o,t);return d.value=e.list,i.logger.debug(r,"[NoteStore] 搜索笔记成功",{keyword:o,count:e.list.length}),e.list}catch(l){throw i.logger.error(r,"[NoteStore] 搜索笔记失败",l),l}finally{g.value=!1}}),fetchNotesByBook:(t,...n)=>u(exports,[t,...n],function*(t,u={}){const n=s.createContext();try{g.value=!0;const s=yield c.getNotesByBook(t,a({page:r.value,pageSize:o.value},u));return e.value=s.list,l.value=s.total,v.value=s.hasMore,i.logger.debug(n,"[NoteStore] 按书籍获取笔记成功",{bookId:t}),s}catch(f){throw i.logger.error(n,"[NoteStore] 按书籍获取笔记失败",f),f}finally{g.value=!1}}),clearSearch:()=>{f.value="",d.value=[]},syncNotes:()=>u(exports,null,function*(){const e=s.createContext();try{y.value="syncing",yield p(1,N.value),h.value=(new Date).toISOString(),y.value="success",i.logger.info(e,"[NoteStore] 同步笔记成功")}catch(t){throw y.value="error",i.logger.error(e,"[NoteStore] 同步笔记失败",t),t}}),reset:()=>{e.value=[],t.value=null,r.value=1,l.value=0,v.value=!0,g.value=!1,f.value="",d.value=[],y.value="idle",h.value="",N.value={}}}});exports.useNoteStore=v;
