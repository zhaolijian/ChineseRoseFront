"use strict";const e=require("../../common/vendor.js"),o=require("../../api/modules/book.js");require("../../utils/request.js");const r=require("../../utils/logger.js"),t=require("../../utils/logger-helpers.js"),s=require("../../utils/auth-guard.js");if(require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(e.resolveComponent("u-image")+e.resolveComponent("u-button")+e.resolveComponent("u-popup"))()}const i=e.defineComponent({__name:"BookPreview",props:{modelValue:{type:Boolean},book:null},emits:["update:modelValue","rescan","added"],setup(i,{emit:l}){const a=i,u=e.ref(!1),n=e.ref(!1);e.watch(()=>a.modelValue,e=>{u.value=e}),e.watch(u,e=>{l("update:modelValue",e)});const c=()=>{const e=t.createContext();r.logger.debug(e,"[BookPreview] 关闭预览弹窗"),u.value=!1},d=()=>{const e=t.createContext();r.logger.debug(e,"[BookPreview] 触发重新扫描"),u.value=!1,l("rescan")},p=()=>{return i=this,c=null,d=function*(){var i;const c=t.createContext();if(yield s.ensureLoggedIn("添加书籍"))try{n.value=!0,r.logger.info(c,"[BookPreview] 开始添加书籍到书架",{isbn:a.book.isbn});const t={title:a.book.title,author:a.book.author,isbn:a.book.isbn,publisher:a.book.publisher,publishDate:a.book.publishDate,coverUrl:a.book.coverUrl,source:"isbn_api"},s=yield o.createBook(t);r.logger.info(c,"[BookPreview] 书籍添加成功",{bookId:s.id}),e.index.showToast({title:"添加成功",icon:"success"}),u.value=!1,l("added",s)}catch(d){r.logger.error(c,"[BookPreview] 添加书籍失败",d),(null==(i=d.message)?void 0:i.includes("已存在"))?e.index.showToast({title:"该书籍已在书架中",icon:"none"}):e.index.showToast({title:"添加失败",icon:"error"})}finally{n.value=!1}else u.value=!1},new Promise((e,o)=>{var r=e=>{try{s(d.next(e))}catch(r){o(r)}},t=e=>{try{s(d.throw(e))}catch(r){o(r)}},s=o=>o.done?e(o.value):Promise.resolve(o.value).then(r,t);s((d=d.apply(i,c)).next())});var i,c,d};return(o,r)=>e.e({a:e.p({src:i.book.coverUrl||"/static/images/book-placeholder.svg",width:"120px",height:"160px",radius:"8",mode:"aspectFit"}),b:e.t(i.book.title||"-"),c:e.t(i.book.author||"-"),d:e.t(i.book.publisher||"-"),e:e.t(i.book.isbn||"-"),f:i.book.publishDate},i.book.publishDate?{g:e.t(i.book.publishDate)}:{},{h:i.book.description},i.book.description?{i:e.t(i.book.description)}:{},{j:e.o(d),k:e.p({type:"default",text:"重新扫描",shape:"circle",size:"normal"}),l:e.o(p),m:e.p({type:"primary",text:"添加到书架",shape:"circle",size:"normal",loading:n.value}),n:e.o(c),o:e.o(e=>u.value=e),p:e.p({mode:"center",width:"90%",round:"20",closeable:!0,modelValue:u.value})})}}),l=e._export_sfc(i,[["__scopeId","data-v-b6f412dd"]]);wx.createComponent(l);
