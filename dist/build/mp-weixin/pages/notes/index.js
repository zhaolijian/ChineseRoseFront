"use strict";var e=(e,t,o)=>new Promise((s,a)=>{var n=e=>{try{l(o.next(e))}catch(t){a(t)}},r=e=>{try{l(o.throw(e))}catch(t){a(t)}},l=e=>e.done?s(e.value):Promise.resolve(e.value).then(n,r);l((o=o.apply(e,t)).next())});const t=require("../../common/vendor.js"),o=require("../../utils/tabbar.js"),s=require("../../stores/modules/book.js"),a=require("../../stores/modules/note.js"),n=require("../../stores/modules/mindmap.js");require("../../utils/request.js");const r=require("../../utils/logger.js"),l=require("../../utils/logger-helpers.js");if(require("../../api/modules/note.js"),require("../../types/errorCodes.js"),require("../../api/modules/mindmap.js"),require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(t.resolveComponent("u-icon")+t.resolveComponent("u-loading-page"))()}Math||((()=>"../../node-modules/uview-plus/components/u-icon/u-icon.js")+i+u+d+(()=>"../../node-modules/uview-plus/components/u-loading-page/u-loading-page.js"))();const i=()=>"../../components/common/AppNavBar.js",u=()=>"../../components/common/PageContainer.js",d=()=>"../../components/common/TabBar.js",c=t.defineComponent({__name:"index",setup(i){const u=s.useBookStore(),d=a.useNoteStore(),c=n.useMindmapStore(),m=t.reactive({books:0,notes:0,mindmaps:0}),p=t.ref([]),g=t.ref(!1),f=t.ref(!1),h={reading:"阅读笔记",thought:"思考感悟",quote:"摘录",summary:"总结",default:"笔记"};t.computed(()=>({books:m.books,notes:m.notes,mindmaps:m.mindmaps})).value;const v=t.ref(120),b=t.computed(()=>({marginTop:`${v.value}rpx`})),j=(o=!1)=>e(this,null,function*(){var e,s,a;const n=l.createContext();try{g.value=!0,o&&(f.value=!0);const[t,l,i]=yield Promise.allSettled([u.fetchBooks(1,{limit:12}),d.fetchNotes(1,{pageSize:10,sortBy:"updatedAt",sortOrder:"desc"}),c.fetchMindmaps(1,{limit:12})]);if("fulfilled"===t.status?m.books=null!=(e=t.value.total)?e:u.bookCount:r.logger.warn(n,"[NotesDashboard] 获取书籍统计失败",t.reason),"fulfilled"===l.status){const e=l.value;m.notes=null!=(s=e.total)?s:d.total,p.value=y(e.list)}else r.logger.warn(n,"[NotesDashboard] 获取笔记列表失败",l.reason),p.value=[];"fulfilled"===i.status?m.mindmaps=null!=(a=i.value.total)?a:c.total:r.logger.warn(n,"[NotesDashboard] 获取导图统计失败",i.reason)}catch(i){r.logger.error(n,"[NotesDashboard] 加载面板数据失败",i),t.index.showToast({title:"加载失败",icon:"error"})}finally{g.value=!1,f.value=!1}}),y=e=>e.slice(0,5).map(e=>{var t,o;const s=e.title||"无标题笔记",a=e.chapter||e.bookTitle||"未关联书籍",n=null!=(o=null==(t=e.tags)?void 0:t.length)?o:0,r=n>0?`${n} 个标签`:"无标签",l=w(e.updatedAt||e.createdAt),i=e.noteType||"default",u=q(e);return{id:e.id,title:s,subtitle:a,countLabel:r,timeLabel:l,progress:u,noteType:i,typeLabel:h[i]||h.default,tags:(e.tags||[]).slice(0,3)}}),q=e=>{var t,o;const s=e.progress;if("number"==typeof s)return Math.max(0,Math.min(100,Math.round(s)));const a=null!=(o=null==(t=e.content)?void 0:t.length)?o:0;if(0===a)return 0;const n=Math.min(100,Math.round(a%500/500*100));return n<=0?15:n},w=e=>{if(!e)return"";const t=new Date(e);if(Number.isNaN(t.getTime()))return"";const o=Date.now()-t.getTime(),s=6e4,a=36e5,n=24*a,r=7*n;return o<s?"刚刚":o<a?`${Math.floor(o/s)} 分钟前`:o<n?`${Math.floor(o/a)} 小时前`:o<r?`${Math.floor(o/n)} 天前`:t.toLocaleDateString()},x=()=>{t.index.navigateTo({url:"/pages-note/list/list"})},M=()=>{t.index.navigateTo({url:"/pages-note/add/add"})},T=()=>{t.index.navigateTo({url:"/pages-note/list/list"})},k=()=>{var e,o,s,a,n;try{const r=null==(o=(e=t.index).getSystemInfoSync)?void 0:o.call(e);if(!r)return;const l=r.windowWidth||375,i=r.statusBarHeight||0,u=null==(a=(s=t.index).getMenuButtonBoundingClientRect)?void 0:a.call(s),d=(null!=(n=null==u?void 0:u.bottom)?n:i+44)+6,c=Math.round(750*d/l);v.value=Math.max(c,60)}catch(i){r.logger.warn(l.createContext(),"[NotesDashboard] 获取系统信息失败",i)}};return t.onMounted(()=>e(this,null,function*(){yield j(!0),o.safeHideTabBar(),k()})),t.onShow(()=>e(this,null,function*(){o.safeHideTabBar(),k(),yield j(!0)})),t.onPullDownRefresh(()=>e(this,null,function*(){yield j(!0),t.index.stopPullDownRefresh()})),(e,o)=>t.e({a:t.o(x),b:t.p({name:"search",size:"20"}),c:t.o(M),d:t.p({name:"plus-circle",size:"20"}),e:t.p({title:"笔记",showBack:!1}),f:t.t(m.books),g:t.t(m.notes),h:t.t(m.mindmaps),i:t.p({name:"arrow-right",size:"16",color:"#00a82d"}),j:t.o(T),k:p.value.length>0},p.value.length>0?{l:t.f(p.value,(e,o,s)=>t.e({a:"f9fd7daa-5-"+s+",f9fd7daa-3",b:t.t(e.title),c:t.t(e.subtitle),d:t.t(e.countLabel),e:t.t(e.timeLabel),f:t.t(e.progress),g:`${e.progress}%`,h:t.t(e.typeLabel),i:e.tags&&e.tags.length},e.tags&&e.tags.length?{j:t.f(e.tags,(e,o,s)=>({a:t.t(e),b:e}))}:{},{k:e.id,l:t.n(`note-card--type-${e.noteType}`),m:t.o(o=>{return s=e.id,void t.index.navigateTo({url:`/pages-note/edit/edit?id=${s}`});var s},e.id)})),m:t.p({name:"book",size:"24",color:"#ffffff"})}:{},{n:t.s(t.unref(b)),o:t.o(M),p:t.p({loading:f.value,"bg-color":"#f5f7fa"})})}}),m=t._export_sfc(c,[["__scopeId","data-v-f9fd7daa"]]);wx.createPage(m);
