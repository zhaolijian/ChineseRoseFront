"use strict";var e=(e,o,n)=>new Promise((t,a)=>{var l=e=>{try{s(n.next(e))}catch(o){a(o)}},r=e=>{try{s(n.throw(e))}catch(o){a(o)}},s=e=>e.done?t(e.value):Promise.resolve(e.value).then(l,r);s((n=n.apply(e,o)).next())});const o=require("../../common/vendor.js"),n=require("../../stores/modules/book.js"),t=require("../../stores/modules/user.js"),a=require("../../utils/tabbar.js");require("../../utils/request.js");const l=require("../../utils/logger.js"),r=require("../../utils/logger-helpers.js"),s=require("../../api/modules/book.js");if(require("../../utils/storage.js"),require("../../constants/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),require("../../types/errorCodes.js"),require("../../constants/request.js"),require("../../utils/error-handler.js"),!Array){(o.resolveComponent("u-icon")+o.resolveComponent("u-image")+o.resolveComponent("u-popup")+o.resolveComponent("u-loading-page"))()}Math||(i+u+c+g+d+h)();const i=()=>"../../components/common/AppNavBar.js",g=()=>"../../components/common/PageContainer.js",u=()=>"../../components/common/EmptyState.js",d=()=>"../../components/common/TabBar.js",c=()=>"../../components/common/LoadingSkeleton.js",h=()=>"../../components/business/BookPreview.js",f=o.defineComponent({__name:"index",setup(i){const g=n.useBookStore(),u=t.useUserStore(),d=o.ref([]),c=o.ref(!1),h=o.ref(!1),f=o.ref(!1),v=o.ref(!0),p=o.ref(!1),b=o.ref({}),m=o.ref(!1),x=o.ref(!1);o.onMounted(()=>e(this,null,function*(){const e=r.createContext();l.logger.info(e,"[BookshelfPage] 页面挂载"),yield k()})),o.onShow(()=>e(this,null,function*(){const e=r.createContext();l.logger.info(e,"[BookshelfPage] 页面显示"),a.safeHideTabBar(),u.isLoggedIn?(l.logger.debug(e,"[BookshelfPage] 用户已登录，加载书籍数据"),x.value&&(yield y(!0))):l.logger.debug(e,"[BookshelfPage] 用户未登录，跳过加载")})),o.onPullDownRefresh(()=>e(this,null,function*(){const e=r.createContext();if(l.logger.debug(e,"[BookshelfPage] 触发下拉刷新"),!u.isLoggedIn)return l.logger.debug(e,"[BookshelfPage] 用户未登录，静默处理下拉刷新"),void o.index.stopPullDownRefresh();yield y(!0),o.index.stopPullDownRefresh()})),o.onReachBottom(()=>e(this,null,function*(){const e=r.createContext();u.isLoggedIn?v.value&&!h.value&&(l.logger.debug(e,"[BookshelfPage] 触底加载更多"),yield C()):l.logger.debug(e,"[BookshelfPage] 用户未登录，静默处理触底事件")}));const k=()=>e(this,null,function*(){const e=r.createContext();try{f.value=!0,l.logger.debug(e,"[init] 初始化书架页"),u.isLoggedIn?(l.logger.debug(e,"[init] 用户已登录，加载书籍数据"),yield y(!0),x.value=!0):l.logger.debug(e,"[init] 用户未登录，显示登录引导")}catch(n){l.logger.error(e,"[init] 初始化失败",n),o.index.showToast({title:"加载失败",icon:"error"})}finally{f.value=!1}}),B=()=>{const e=r.createContext();l.logger.debug(e,"[goToLogin] 跳转到登录页"),o.index.navigateTo({url:"/pages/login/login"})},y=(n=!1)=>e(this,null,function*(){const e=r.createContext();try{h.value=!0,l.logger.debug(e,"[loadBooks] 开始加载书籍",{refresh:n});const o=n||0===d.value.length?1:g.currentPage+1,t=yield g.fetchBooks(o);d.value=1===o?[...t.books]:[...d.value,...t.books],v.value=t.hasMore,l.logger.info(e,"[loadBooks] 加载书籍成功",{count:t.books.length,hasMore:t.hasMore})}catch(t){l.logger.error(e,"[loadBooks] 加载书籍失败",t),o.index.showToast({title:"加载失败",icon:"error"})}finally{h.value=!1}}),C=()=>e(this,null,function*(){v.value&&(yield y())}),j=()=>{const e=r.createContext();l.logger.debug(e,"[goToAddBook] 跳转到添加书籍页面"),o.index.navigateTo({url:"/pages-book/add/add"})},S=()=>{const e=r.createContext();l.logger.debug(e,"[addByISBN] 调用扫码功能"),c.value=!1,I()},I=()=>e(this,null,function*(){var e;const n=r.createContext();try{l.logger.debug(n,"[handleScanISBN] 开始扫码");const e=yield o.index.scanCode({onlyFromCamera:!1,scanType:["barCode"]});if(!e.result)return void l.logger.warn(n,"[handleScanISBN] 扫码结果为空");const a=e.result;l.logger.info(n,"[handleScanISBN] 扫码成功",{isbn:a}),o.index.showLoading({title:"正在查询书籍信息...",mask:!0}),m.value=!0;try{const e=yield s.searchBookByISBN(a);l.logger.info(n,"[handleScanISBN] 书籍信息查询成功",{bookInfo:e}),b.value=e,p.value=!0}catch(t){l.logger.error(n,"[handleScanISBN] 查询书籍信息失败",t),o.index.showModal({title:"未找到书籍信息",content:"无法获取该ISBN的书籍信息，是否手动创建？",confirmText:"手动创建",cancelText:"重新扫描",success:e=>{e.confirm?o.index.navigateTo({url:`/pages-book/add/add?isbn=${a}`}):I()}})}finally{o.index.hideLoading(),m.value=!1}}catch(t){const n=r.createContext();if(null==(e=t.errMsg)?void 0:e.includes("cancel"))return void l.logger.debug(n,"[handleScanISBN] 用户取消扫码");l.logger.error(n,"[handleScanISBN] 扫码失败",t),o.index.showToast({title:"扫码失败，请重试",icon:"none"})}}),q=()=>{const e=r.createContext();l.logger.debug(e,"[handleRescan] 重新扫描"),p.value=!1,I()},w=o=>e(this,null,function*(){const e=r.createContext();l.logger.info(e,"[handleBookAdded] 书籍添加成功",{bookId:o.id}),yield y(!0)}),T=()=>{const e=r.createContext();l.logger.debug(e,"[addManually] 跳转到手动添加页面"),c.value=!1,o.index.navigateTo({url:"/pages-book/add/add"})};return(e,n)=>o.e({a:o.o(j),b:o.p({name:"plus",size:"20",color:"#2E7D32"}),c:o.o(I),d:o.p({name:"scan",size:"20",color:"#2E7D32"}),e:o.p({title:"书架",showBack:!1}),f:!o.unref(u).isLoggedIn},o.unref(u).isLoggedIn?o.e({i:h.value&&0===d.value.length},h.value&&0===d.value.length?{j:o.p({rows:4})}:0===d.value.length?{l:o.o(e=>c.value=!0),m:o.p({icon:"book",title:"还没有添加书籍",actionText:"添加第一本书"})}:{n:o.f(d.value,(e,n,t)=>({a:"bafd1a4d-7-"+t+",bafd1a4d-3",b:o.p({src:e.coverUrl||"/static/images/book-placeholder.svg",mode:"aspectFit",width:"100%",height:"140px",radius:"8","loading-icon":"book"}),c:o.t(e.title),d:o.t(e.author),e:o.t(e.noteCount||0),f:e.id,g:o.o(n=>(e=>{const n=r.createContext();l.logger.debug(n,"[goToBookDetail] 跳转到书籍详情",{bookId:e.id,title:e.title}),o.index.navigateTo({url:`/pages-book/detail/detail?id=${e.id}`})})(e),e.id)}))},{k:0===d.value.length}):{g:o.o(B),h:o.p({icon:"account",title:"登录后查看你的书架",actionText:"立即登录"})},{o:o.p({name:"scan",size:"30"}),p:o.o(S),q:o.p({name:"edit-pen",size:"30"}),r:o.o(T),s:o.o(e=>c.value=e),t:o.p({mode:"bottom",height:"30%",round:"20",closeable:!0,modelValue:c.value}),v:o.p({loading:f.value,"bg-color":"#f5f7fa"}),w:o.o(q),x:o.o(w),y:o.o(e=>p.value=e),z:o.p({book:b.value,modelValue:p.value})})}}),v=o._export_sfc(f,[["__scopeId","data-v-bafd1a4d"]]);wx.createPage(v);
