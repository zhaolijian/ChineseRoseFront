"use strict";var e=(e,o,n)=>new Promise((r,t)=>{var s=e=>{try{u(n.next(e))}catch(o){t(o)}},i=e=>{try{u(n.throw(e))}catch(o){t(o)}},u=e=>e.done?r(e.value):Promise.resolve(e.value).then(s,i);u((n=n.apply(e,o)).next())});const o=require("../../common/vendor.js");require("../../stores/index.js"),require("../../utils/request.js");const n=require("../../constants/validation.js"),r=require("../../utils/logger.js"),t=require("../../utils/logger-helpers.js"),s=require("../../utils/validate.js"),i=require("../../api/modules/auth.js"),u=require("../../composables/useCountdown.js"),a=require("../../stores/modules/user.js");require("../../stores/modules/book.js"),require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../utils/storage.js"),require("../../utils/base64.js");const l=o.defineComponent({__name:"phone-login",setup(l){const c={user:"https://chinese-rose.com/agreement/user",privacy:"https://chinese-rose.com/agreement/privacy"},d=a.useUserStore(),g=o.ref(""),v=o.ref(""),h=o.ref(!1),p=o.ref(!1),f=o.ref(!1),{countdown:m,start:x,restore:q}=u.useCountdown(),w=o.computed(()=>{var e;return`${null!=(e=g.value)?e:""}`.trim()}),j=o.computed(()=>{var e;return`${null!=(e=v.value)?e:""}`.trim()}),P=o.computed(()=>`padding-top: ${o.index.getSystemInfoSync().statusBarHeight||0}px;`),y=o.computed(()=>s.isValidPhone(w.value)),L=o.computed(()=>y.value&&6===j.value.length),C=o.computed(()=>m.value>0?`${m.value}s`:f.value?"重新发送":"获取验证码");o.watch(m,e=>{e>0&&(f.value=!0)});const T=()=>e(this,null,function*(){const e=t.createContext();if(!y.value)return;if(m.value>0)return;const s=w.value;try{r.logger.info(e,"[PhoneLoginPage] 发送验证码",{phone:s}),o.index.showLoading({title:"发送中..."}),yield i.sendSMSCode(s),f.value=!0,x(n.VERIFY_CODE_COUNTDOWN),o.index.showToast({title:"验证码已发送",icon:"success"}),r.logger.info(e,"[PhoneLoginPage] 验证码发送成功")}catch(u){r.logger.error(e,"[PhoneLoginPage] 发送验证码失败",u),o.index.showToast({title:(null==u?void 0:u.message)||"发送失败，请重试",icon:"none"})}finally{o.index.hideLoading()}}),_=()=>{q(),m.value>0&&(f.value=!0)};o.onLoad(_),o.onShow(_);const b=()=>e(this,null,function*(){const e=t.createContext();if(L.value)if(h.value)try{p.value=!0;const n=w.value,t=j.value;r.logger.info(e,"[PhoneLoginPage] 开始手机号登录",{phone:n}),o.index.showLoading({title:"登录中..."});const s=yield d.loginWithPhone({phone:n,code:t});if(!(null==s?void 0:s.success))throw new Error((null==s?void 0:s.message)||"登录失败");o.index.showToast({title:"登录成功",icon:"success"}),r.logger.info(e,"[PhoneLoginPage] 登录成功"),setTimeout(()=>{o.index.reLaunch({url:"/pages/index/index"})},500)}catch(n){r.logger.error(e,"[PhoneLoginPage] 登录失败",n),o.index.showToast({title:(null==n?void 0:n.message)||"登录失败，请重试",icon:"none"})}finally{o.index.hideLoading(),p.value=!1}else o.index.showToast({title:"请先勾选用户协议和隐私政策",icon:"none",duration:2e3})}),S=e=>{h.value=e.detail.value.includes("agree")},$=e=>{const n=c[e];o.index.navigateTo({url:`/pages/webview/index?url=${encodeURIComponent(n)}`})},I=()=>{o.index.navigateBack({delta:1})};return(e,n)=>({a:o.o(I),b:o.o(I),c:o.s(o.unref(P)),d:g.value,e:o.o(e=>g.value=e.detail.value),f:v.value,g:o.o(e=>v.value=e.detail.value),h:o.t(o.unref(C)),i:o.unref(m)>0||!o.unref(y)?1:"",j:o.unref(m)>0||!o.unref(y),k:o.o(T),l:o.o(T),m:h.value,n:o.o(S),o:o.o(e=>$("user")),p:o.o(e=>$("privacy")),q:!o.unref(L),r:p.value,s:o.o(b)})}}),c=o._export_sfc(l,[["__scopeId","data-v-2e9cbcdb"]]);wx.createPage(c);
