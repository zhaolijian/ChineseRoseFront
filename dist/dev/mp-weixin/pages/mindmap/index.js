"use strict";var e=(e,o,t)=>new Promise((n,a)=>{var i=e=>{try{s(t.next(e))}catch(o){a(o)}},l=e=>{try{s(t.throw(e))}catch(o){a(o)}},s=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,l);s((t=t.apply(e,o)).next())});const o=require("../../common/vendor.js"),t=require("../../stores/modules/mindmap.js"),n=require("../../stores/modules/user.js"),a=require("../../utils/tabbar.js");require("../../utils/request.js");const i=require("../../utils/logger.js"),l=require("../../utils/logger-helpers.js");if(require("../../api/modules/mindmap.js"),require("../../types/errorCodes.js"),require("../../utils/storage.js"),require("../../constants/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),require("../../constants/request.js"),require("../../utils/error-handler.js"),!Array){(o.resolveComponent("u-icon")+o.resolveComponent("u-tabs")+o.resolveComponent("u-image")+o.resolveComponent("u-action-sheet")+o.resolveComponent("u-loading-page"))()}Math||((()=>"../../node-modules/uview-plus/components/u-icon/u-icon.js")+s+(()=>"../../node-modules/uview-plus/components/u-tabs/u-tabs.js")+u+d+(()=>"../../node-modules/uview-plus/components/u-image/u-image.js")+r+c+(()=>"../../node-modules/uview-plus/components/u-action-sheet/u-action-sheet.js")+(()=>"../../node-modules/uview-plus/components/u-loading-page/u-loading-page.js"))();const s=()=>"../../components/common/AppNavBar.js",r=()=>"../../components/common/PageContainer.js",d=()=>"../../components/common/EmptyState.js",u=()=>"../../components/common/LoadingSkeleton.js",c=()=>"../../components/common/TabBar.js",m=o.defineComponent({__name:"index",setup(s){t.useMindmapStore();const r=n.useUserStore(),d=o.ref([]),u=o.ref(!1),c=o.ref(!1),m=o.ref(!0),g=o.ref(0),p=o.ref(!1),h=o.ref(null),v=o.ref([{name:"网格"},{name:"列表"}]),f=o.ref([{text:"编辑",name:"edit"},{text:"分享",name:"share"},{text:"删除",name:"delete",color:"#ff4757"}]);o.onMounted(()=>e(this,null,function*(){const e=l.createContext();i.logger.info(e,"[MindmapPage] 页面挂载"),yield b()})),o.onShow(()=>e(this,null,function*(){const e=l.createContext();i.logger.info(e,"[MindmapPage] 页面显示"),a.safeHideTabBar(),yield x()})),o.onPullDownRefresh(()=>e(this,null,function*(){const e=l.createContext();i.logger.debug(e,"[MindmapPage] 触发下拉刷新"),yield x(!0),o.index.stopPullDownRefresh()})),o.onReachBottom(()=>e(this,null,function*(){const e=l.createContext();m.value&&!u.value&&(i.logger.debug(e,"[MindmapPage] 触底加载更多"),yield j())}));const b=()=>e(this,null,function*(){const e=l.createContext();try{if(c.value=!0,i.logger.debug(e,"[checkLoginAndLoadData] 开始检查登录状态"),!r.isLoggedIn)return i.logger.info(e,"[checkLoginAndLoadData] 用户未登录，跳转到登录页"),void o.index.navigateTo({url:"/pages/login/login"});i.logger.debug(e,"[checkLoginAndLoadData] 用户已登录，加载思维导图数据"),yield x()}catch(t){i.logger.error(e,"[checkLoginAndLoadData] 初始化失败",t),o.index.showToast({title:"加载失败",icon:"error"})}finally{c.value=!1}}),x=(t=!1)=>e(this,null,function*(){const e=l.createContext();try{u.value=!0,i.logger.debug(e,"[loadMindmaps] 开始加载思维导图",{refresh:t});const o=[{id:1,title:"《示例书籍》知识结构",bookId:1,bookTitle:"《示例书籍》",nodeCount:15,createdAt:"2024-01-15T10:30:00Z"}];t?d.value=o:d.value.push(...o),m.value=!1,i.logger.info(e,"[loadMindmaps] 加载思维导图成功",{count:o.length})}catch(n){i.logger.error(e,"[loadMindmaps] 加载思维导图失败",n),o.index.showToast({title:"加载失败",icon:"error"})}finally{u.value=!1}}),j=()=>e(this,null,function*(){m.value&&(yield x())}),C=e=>{const o=l.createContext();i.logger.debug(o,"[onViewChange] 切换视图",{view:v.value[e].name}),g.value=e},w=e=>{const t=l.createContext();i.logger.debug(t,"[goToMindmapDetail] 跳转到思维导图详情",{mindmapId:e.id,title:e.title}),o.index.navigateTo({url:`/pages-mindmap/detail/detail?id=${e.id}`})},y=()=>{const e=l.createContext();i.logger.debug(e,"[goToCreateMindmap] 跳转到创建思维导图页"),o.index.navigateTo({url:"/pages-mindmap/create/create"})},T=()=>{const e=l.createContext();i.logger.debug(e,"[goToSearch] 跳转到搜索页",{type:"mindmap"}),o.index.navigateTo({url:"/pages/search/search?type=mindmap"})},k=e=>{const o=l.createContext();i.logger.debug(o,"[showActions] 显示操作菜单",{mindmapId:e.id}),h.value=e,p.value=!0},q=e=>{const t=l.createContext();if(h.value){switch(i.logger.debug(t,"[onActionClick] 点击操作",{action:e.name,mindmapId:h.value.id}),e.name){case"edit":o.index.navigateTo({url:`/pages-mindmap/edit/edit?id=${h.value.id}`});break;case"share":i.logger.debug(t,"[onActionClick] 分享功能待开发"),o.index.showToast({title:"功能开发中",icon:"none"});break;case"delete":o.index.showModal({title:"确认删除",content:"删除后不可恢复，确定要删除这个思维导图吗？",success:e=>{e.confirm&&M(h.value.id)}})}p.value=!1,h.value=null}},M=t=>e(this,null,function*(){const e=l.createContext();try{i.logger.info(e,"[deleteMindmap] 开始删除思维导图",{mindmapId:t});const n=d.value.findIndex(e=>e.id===t);n>-1&&d.value.splice(n,1),i.logger.info(e,"[deleteMindmap] 删除思维导图成功"),o.index.showToast({title:"删除成功",icon:"success"})}catch(n){i.logger.error(e,"[deleteMindmap] 删除思维导图失败",n),o.index.showToast({title:"删除失败",icon:"error"})}}),A=e=>{const o=new Date(e),t=(new Date).getTime()-o.getTime(),n=Math.floor(t/864e5);return 0===n?"今天":1===n?"昨天":n<7?`${n}天前`:o.toLocaleDateString("zh-CN",{month:"numeric",day:"numeric"})};return(e,t)=>o.e({a:o.o(T),b:o.p({name:"search",size:"20"}),c:o.o(y),d:o.p({name:"plus-circle",size:"20"}),e:o.p({title:"思维导图",showBack:!1}),f:o.o(C),g:o.o(e=>g.value=e),h:o.p({list:v.value,lineWidth:"30",lineHeight:"3",activeStyle:{color:"#059669",fontWeight:"bold"},modelValue:g.value}),i:u.value&&0===d.value.length},u.value&&0===d.value.length?{j:o.p({rows:4})}:0===d.value.length?{l:o.o(y),m:o.p({icon:"data",title:"还没有思维导图",actionText:"创建第一个思维导图"})}:0===g.value?{o:o.f(d.value,(e,t,n)=>({a:"010bfa13-7-"+n+",010bfa13-4",b:o.p({src:e.thumbnail||"/static/images/mindmap-placeholder.png",mode:"aspectFit",width:"100%",height:"120px",radius:"8","loading-icon":"loading"}),c:o.t(e.title||"无标题思维导图"),d:o.t(A(e.createdAt)),e:"010bfa13-8-"+n+",010bfa13-4",f:o.t(e.bookTitle||"未知书籍"),g:o.t(e.nodeCount||0),h:o.o(o=>k(e),e.id||"mmg-"+t),i:"010bfa13-9-"+n+",010bfa13-4",j:o.o(()=>{},e.id||"mmg-"+t),k:e.id||"mmg-"+t,l:o.o(o=>w(e),e.id||"mmg-"+t)})),p:o.p({name:"book",size:"10",color:"#999"}),q:o.p({name:"more-dot-fill",size:"16",color:"#999"})}:{r:o.f(d.value,(e,t,n)=>({a:"010bfa13-10-"+n+",010bfa13-4",b:o.p({src:e.thumbnail||"/static/images/mindmap-placeholder.png",mode:"aspectFit",width:"60px",height:"60px",radius:"6"}),c:o.t(e.title||"无标题思维导图"),d:o.t(A(e.createdAt)),e:o.t(e.bookTitle||"未知书籍"),f:o.t(e.nodeCount||0),g:o.o(o=>k(e),e.id||"mml-"+t),h:"010bfa13-11-"+n+",010bfa13-4",i:o.o(()=>{},e.id||"mml-"+t),j:e.id||"mml-"+t,k:o.o(o=>w(e),e.id||"mml-"+t)})),s:o.p({name:"more-dot-fill",size:"16",color:"#999"})},{k:0===d.value.length,n:0===g.value,t:o.p({name:"plus",size:"24",color:"#fff"}),v:o.o(y),w:o.o(q),x:o.o(e=>p.value=e),y:o.p({actions:f.value,title:"选择操作",modelValue:p.value}),z:o.p({loading:c.value,"bg-color":"#f5f7fa"})})}}),g=o._export_sfc(m,[["__scopeId","data-v-010bfa13"],["__file","/Users/zhaolijian/Projects/chinese-rose-front/src/pages/mindmap/index.vue"]]);wx.createPage(g);
