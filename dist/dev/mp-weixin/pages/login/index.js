"use strict";const e=require("../../common/vendor.js");require("../../stores/index.js"),require("../../utils/request.js");const o=require("../../utils/logger.js"),r=require("../../utils/logger-helpers.js"),i=require("../../stores/modules/user.js");require("../../stores/modules/book.js"),require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js");const n=e.defineComponent({__name:"index",setup(n){const s=i.useUserStore(),t=e.ref(!1),a=e.ref(!1),l=e=>{t.value=e.detail.value.includes("agree")},u=i=>{return n=this,l=null,u=function*(){const n=r.createContext();if(t.value)try{if(!i.detail.code)return o.logger.warn(n,"[LoginPage] 用户拒绝授权手机号"),void e.index.showToast({title:"需要授权手机号才能一键登录",icon:"none"});a.value=!0,o.logger.info(n,"[LoginPage] 开始微信一键登录");const r=yield e.index.login({provider:"weixin"});if(!r.code)throw new Error("获取登录凭证失败");o.logger.debug(n,"[LoginPage] 获取loginCode成功");const t=i.detail.code;o.logger.debug(n,"[LoginPage] 获取phoneCode成功"),o.logger.info(n,"[LoginPage] 调用微信一键登录接口"),yield s.wechatQuickLogin(r.code,t),e.index.showToast({title:"登录成功",icon:"success"}),o.logger.info(n,"[LoginPage] 一键登录成功"),setTimeout(()=>{e.index.reLaunch({url:"/pages/index/index"})},500)}catch(l){o.logger.error(n,"[LoginPage] 微信登录失败",l),e.index.showToast({title:(null==l?void 0:l.message)||"登录失败，请重试",icon:"none"})}finally{a.value=!1}else e.index.showToast({title:"请先勾选用户协议和隐私政策",icon:"none",duration:2e3})},new Promise((e,o)=>{var r=e=>{try{t(u.next(e))}catch(i){o(i)}},s=e=>{try{t(u.throw(e))}catch(i){o(i)}},t=o=>o.done?e(o.value):Promise.resolve(o.value).then(r,s);t((u=u.apply(n,l)).next())});var n,l,u},g=o=>{const r="user"===o?{}.VITE_AGREEMENT_URL_USER||"https://example.com/user-agreement":{}.VITE_AGREEMENT_URL_PRIVACY||"https://example.com/privacy-policy";e.index.navigateTo({url:`/pages/webview/index?url=${encodeURIComponent(r)}`})},c=()=>{e.index.navigateTo({url:"/pages/login/phone-login"})};return(o,r)=>({a:a.value,b:e.o(u),c:t.value,d:e.o(l),e:e.o(e=>g("user")),f:e.o(e=>g("privacy")),g:e.o(c)})}}),s=e._export_sfc(n,[["__scopeId","data-v-45258083"],["__file","/Users/zhaolijian/Projects/chinese-rose-front/src/pages/login/index.vue"]]);wx.createComponent(s);
