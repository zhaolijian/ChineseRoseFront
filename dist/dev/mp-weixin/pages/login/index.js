"use strict";const e=require("../../common/vendor.js");require("../../stores/index.js"),require("../../utils/request.js");const o=require("../../utils/logger.js"),r=require("../../utils/logger-helpers.js"),n=require("../../stores/modules/user.js");require("../../stores/modules/book.js"),require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js");const s=e.defineComponent({__name:"index",setup(s){const i=n.useUserStore(),t=e.ref(!1),a=e.ref(!1),u=e=>{t.value=e.detail.value.includes("agree")},l=n=>{return s=this,u=null,l=function*(){const s=r.createContext();if(t.value)try{if(!n.detail.code)return o.logger.warn(s,"[LoginPage] 用户拒绝授权手机号"),void e.index.showToast({title:"需要授权手机号才能一键登录",icon:"none"});a.value=!0,o.logger.info(s,"[LoginPage] 开始微信一键登录");const r=yield e.index.login({provider:"weixin"});if(!r.code)throw new Error("获取登录凭证失败");o.logger.debug(s,"[LoginPage] 获取loginCode成功");const t=n.detail.code;o.logger.debug(s,"[LoginPage] 获取phoneCode成功"),o.logger.info(s,"[LoginPage] 调用微信一键登录接口"),yield i.wechatQuickLogin(r.code,t),e.index.showToast({title:"登录成功",icon:"success"}),o.logger.info(s,"[LoginPage] 一键登录成功"),setTimeout(()=>{e.index.reLaunch({url:"/pages/index/index"})},500)}catch(u){o.logger.error(s,"[LoginPage] 微信登录失败",u),e.index.showToast({title:(null==u?void 0:u.message)||"登录失败，请重试",icon:"none"})}finally{a.value=!1}else e.index.showToast({title:"请先勾选用户协议和隐私政策",icon:"none",duration:2e3})},new Promise((e,o)=>{var r=e=>{try{t(l.next(e))}catch(n){o(n)}},i=e=>{try{t(l.throw(e))}catch(n){o(n)}},t=o=>o.done?e(o.value):Promise.resolve(o.value).then(r,i);t((l=l.apply(s,u)).next())});var s,u,l},g=o=>{const r="user"===o?"https://chinese-rose.com/agreement/user":"https://chinese-rose.com/agreement/privacy";e.index.navigateTo({url:`/pages/webview/index?url=${encodeURIComponent(r)}`})},c=()=>{e.index.navigateTo({url:"/pages/login/phone-login"})};return(o,r)=>({a:a.value,b:e.o(l),c:t.value,d:e.o(u),e:e.o(e=>g("user")),f:e.o(e=>g("privacy")),g:e.o(c)})}}),i=e._export_sfc(s,[["__scopeId","data-v-b667d1d7"]]);wx.createComponent(i);
