"use strict";var e=(e,o,n)=>new Promise((i,t)=>{var s=e=>{try{r(n.next(e))}catch(o){t(o)}},l=e=>{try{r(n.throw(e))}catch(o){t(o)}},r=e=>e.done?i(e.value):Promise.resolve(e.value).then(s,l);r((n=n.apply(e,o)).next())});const o=require("../../common/vendor.js");require("../../stores/index.js"),require("../../utils/request.js");const n=require("../../utils/logger.js"),i=require("../../utils/logger-helpers.js"),t=require("../../utils/validate.js"),s=require("../../api/modules/auth.js"),l=require("../../stores/modules/user.js");require("../../stores/modules/book.js"),require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../constants/validation.js"),require("../../utils/storage.js"),require("../../utils/base64.js");const r=o.defineComponent({__name:"phone-login",setup(r){const a={user:"https://chinese-rose.com/agreement/user",privacy:"https://chinese-rose.com/agreement/privacy"},u=l.useUserStore(),d=o.ref(""),c=o.ref(""),v=o.ref(!1),g=o.ref(0),h=o.ref(!1),f=o.ref(!1),m=o.computed(()=>`padding-top: ${o.index.getSystemInfoSync().statusBarHeight||0}px;`),p=o.computed(()=>t.isValidPhone(d.value)),x=o.computed(()=>p.value&&6===c.value.length),w=o.computed(()=>g.value>0?`${g.value}s`:f.value?"重新发送":"获取验证码"),{set:q,clear:T}=(()=>{var e,n,i,t;if(void 0!==o.wx$1){const i=null==(e=o.wx$1.setTimeout)?void 0:e.bind(o.wx$1),t=null==(n=o.wx$1.clearTimeout)?void 0:n.bind(o.wx$1);if(i&&t)return{set:i,clear:t}}if("undefined"!=typeof globalThis){const e=null==(i=globalThis.setTimeout)?void 0:i.bind(globalThis),o=null==(t=globalThis.clearTimeout)?void 0:t.bind(globalThis);if(e&&o)return{set:e,clear:o}}return{set:setTimeout,clear:clearTimeout}})();let j=null;const P=()=>{null!==j&&(T(j),j=null),g.value=0};o.onUnmounted(()=>{P()});const y=()=>e(this,null,function*(){const e=i.createContext();if(p.value&&!(g.value>0))try{n.logger.info(e,"[PhoneLoginPage] 发送验证码",{phone:d.value}),o.index.showLoading({title:"发送中..."}),yield s.sendSMSCode(d.value),f.value=!0,((e=60)=>{P(),g.value=e;const o=()=>{j=q(()=>{g.value<=1?P():(g.value-=1,o())},1e3)};o()})(),o.index.showToast({title:"验证码已发送",icon:"success"}),n.logger.info(e,"[PhoneLoginPage] 验证码发送成功")}catch(t){n.logger.error(e,"[PhoneLoginPage] 发送验证码失败",t),o.index.showToast({title:(null==t?void 0:t.message)||"发送失败，请重试",icon:"none"})}finally{o.index.hideLoading()}}),b=()=>e(this,null,function*(){const e=i.createContext();if(x.value)if(v.value)try{h.value=!0,n.logger.info(e,"[PhoneLoginPage] 开始手机号登录",{phone:d.value}),o.index.showLoading({title:"登录中..."});const i=yield u.loginWithPhone({phone:d.value,code:c.value});if(!(null==i?void 0:i.success))throw new Error((null==i?void 0:i.message)||"登录失败");o.index.showToast({title:"登录成功",icon:"success"}),n.logger.info(e,"[PhoneLoginPage] 登录成功"),setTimeout(()=>{o.index.reLaunch({url:"/pages/index/index"})},500)}catch(t){n.logger.error(e,"[PhoneLoginPage] 登录失败",t),o.index.showToast({title:(null==t?void 0:t.message)||"登录失败，请重试",icon:"none"})}finally{o.index.hideLoading(),h.value=!1}else o.index.showToast({title:"请先勾选用户协议和隐私政策",icon:"none",duration:2e3})}),L=e=>{v.value=e.detail.value.includes("agree")},$=e=>{const n=a[e];o.index.navigateTo({url:`/pages/webview/index?url=${encodeURIComponent(n)}`})},C=()=>{o.index.navigateBack({delta:1})};return(e,n)=>({a:o.o(C),b:o.s(o.unref(m)),c:d.value,d:o.o(e=>d.value=e.detail.value),e:c.value,f:o.o(e=>c.value=e.detail.value),g:o.t(o.unref(w)),h:g.value>0||!o.unref(p)?1:"",i:o.o(y),j:v.value,k:o.o(L),l:o.o(e=>$("user")),m:o.o(e=>$("privacy")),n:!o.unref(x),o:h.value,p:o.o(b)})}}),a=o._export_sfc(r,[["__scopeId","data-v-1817fc90"]]);wx.createPage(a);
