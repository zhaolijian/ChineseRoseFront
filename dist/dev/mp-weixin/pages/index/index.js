"use strict";var e=Object.defineProperty,o=Object.defineProperties,n=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,a=(o,n,l)=>n in o?e(o,n,{enumerable:!0,configurable:!0,writable:!0,value:l}):o[n]=l,i=(e,o,n)=>new Promise((l,t)=>{var r=e=>{try{i(n.next(e))}catch(o){t(o)}},a=e=>{try{i(n.throw(e))}catch(o){t(o)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,a);i((n=n.apply(e,o)).next())});const s=require("../../common/vendor.js"),u=require("../../stores/modules/book.js"),d=require("../../stores/modules/user.js"),c=require("../../utils/tabbar.js");require("../../utils/request.js");const g=require("../../utils/logger.js"),v=require("../../utils/logger-helpers.js"),f=require("../../api/modules/book.js"),h=require("../../types/errorCodes.js");if(require("../../utils/storage.js"),require("../../constants/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),require("../../constants/request.js"),require("../../utils/error-handler.js"),!Array){(s.resolveComponent("u-icon")+s.resolveComponent("u-popup")+s.resolveComponent("u-loading-page"))()}Math||(p+m+(()=>"../../node-modules/uview-plus/components/u-icon/u-icon.js")+y+B+b+x+(()=>"../../node-modules/uview-plus/components/u-popup/u-popup.js")+(()=>"../../node-modules/uview-plus/components/u-loading-page/u-loading-page.js")+k)();const p=()=>"../../components/common/AppNavBar.js",b=()=>"../../components/common/PageContainer.js",m=()=>"../../components/common/EmptyState.js",x=()=>"../../components/common/TabBar.js",y=()=>"../../components/common/LoadingSkeleton.js",B=()=>"../../components/book/BookCover.js",k=()=>"../../components/business/BookPreview.js",w=s.defineComponent({__name:"index",setup(e){const p=u.useBookStore(),b=d.useUserStore(),m=s.ref([]),x=s.ref(!1),y=s.ref(!1),B=s.ref(!1),k=s.ref(!0),w=s.ref(!1),S=s.ref({}),j=s.ref(!1),C=s.ref(!1),I={backgroundColor:"#ffffff",boxShadow:"0 -2rpx 16rpx rgba(0, 0, 0, 0.08)"},P=s.ref(""),T=s.ref(""),N=s.ref(!1),q=s.ref(375),M=s.ref(56),L=s.ref(16),O=e=>{const o=q.value||375;return Math.round(750*e/o)},z=s.computed(()=>{const e=Math.max(0,L.value-16);return e<=0?{}:{paddingRight:`${O(e)}rpx`}});s.onMounted(()=>i(this,null,function*(){const e=v.createContext();g.logger.info(e,"[BookshelfPage] 页面挂载"),Y(),yield R()})),s.onShow(()=>i(this,null,function*(){const e=v.createContext();g.logger.info(e,"[BookshelfPage] 页面显示"),Y(),c.safeHideTabBar(),b.isLoggedIn?(g.logger.debug(e,"[BookshelfPage] 用户已登录，加载书籍数据"),C.value&&(yield A(!0))):g.logger.debug(e,"[BookshelfPage] 用户未登录，跳过加载")})),s.onPullDownRefresh(()=>i(this,null,function*(){const e=v.createContext();if(g.logger.debug(e,"[BookshelfPage] 触发下拉刷新"),!b.isLoggedIn)return g.logger.debug(e,"[BookshelfPage] 用户未登录，静默处理下拉刷新"),void s.index.stopPullDownRefresh();yield A(!0),s.index.stopPullDownRefresh()})),s.onReachBottom(()=>i(this,null,function*(){const e=v.createContext();b.isLoggedIn?k.value&&!y.value&&(g.logger.debug(e,"[BookshelfPage] 触底加载更多"),yield D()):g.logger.debug(e,"[BookshelfPage] 用户未登录，静默处理触底事件")}));const R=()=>i(this,null,function*(){const e=v.createContext();try{B.value=!0,g.logger.debug(e,"[init] 初始化书架页"),b.isLoggedIn?(g.logger.debug(e,"[init] 用户已登录，加载书籍数据"),yield A(!0),C.value=!0):g.logger.debug(e,"[init] 用户未登录，显示登录引导")}catch(o){g.logger.error(e,"[init] 初始化失败",o),s.index.showToast({title:"加载失败",icon:"error"})}finally{B.value=!1}}),$=()=>{const e=v.createContext();g.logger.debug(e,"[goToLogin] 跳转到登录页"),s.index.navigateTo({url:"/pages/login/login"})},A=(e=!1)=>i(this,null,function*(){const o=v.createContext();try{y.value=!0,g.logger.debug(o,"[loadBooks] 开始加载书籍",{refresh:e});const n=e||0===m.value.length?1:p.currentPage+1,l={pageSize:12,limit:12};T.value&&(l.keyword=T.value);const t=yield p.fetchBooks(n,l);m.value=1===n?[...t.books]:[...m.value,...t.books],k.value=t.hasMore,g.logger.info(o,"[loadBooks] 加载书籍成功",{count:t.books.length,hasMore:t.hasMore})}catch(n){g.logger.error(o,"[loadBooks] 加载书籍失败",n),s.index.showToast({title:"加载失败",icon:"error"})}finally{y.value=!1}}),D=()=>i(this,null,function*(){k.value&&(yield A())}),_=()=>{const e=v.createContext();g.logger.debug(e,"[goToAddBook] 跳转到添加书籍页面"),s.index.navigateTo({url:"/pages/book/add-book"})},F=()=>{const e=v.createContext();g.logger.debug(e,"[addByISBN] 调用扫码功能"),x.value=!1,U()},E=e=>{setTimeout(()=>{var i,u;s.index.showToast((i=((e,o)=>{for(var n in o||(o={}))t.call(o,n)&&a(e,n,o[n]);if(l)for(var n of l(o))r.call(o,n)&&a(e,n,o[n]);return e})({},e),u={duration:e.duration||2500},o(i,n(u))))},300)},U=()=>i(this,null,function*(){var e;const o=v.createContext();try{g.logger.info(o,"[handleScanISBN] 开始扫码");const e=yield s.index.scanCode({onlyFromCamera:!0,scanType:["barCode"]});if(!e.result)return g.logger.warn(o,"[handleScanISBN] 扫码结果为空"),void E({title:"未识别到条形码，请重试",icon:"none"});const r=e.result||"",a=(e=>(e||"").replace(/[^0-9Xx]/g,"").toUpperCase())(r);if(g.logger.info(o,"[handleScanISBN] 扫码原始结果",{raw:r,isbn:a}),!/^\d{13}$/.test(n=a)&&!/^\d{9}[\dX]$/.test(n))return g.logger.warn(o,"[handleScanISBN] 无效的ISBN",{raw:r,isbn:a}),void E({title:`扫描到：${r}，这不是有效的ISBN码`,icon:"none",duration:3e3});g.logger.info(o,"[handleScanISBN] ISBN校验通过",{isbn:a}),s.index.showLoading({title:"正在查询书籍信息...",mask:!0}),j.value=!0;try{const e=yield f.searchBookByISBN(a,{showLoading:!1});g.logger.info(o,"[handleScanISBN] 书籍信息查询成功",{hasTitle:!!(null==e?void 0:e.title),hasISBN:!!(null==e?void 0:e.isbn),bookInfo:e}),S.value=e,w.value=!0}catch(l){if(g.logger.error(o,"[handleScanISBN] 查询书籍信息失败",{error:l,errorCode:null==l?void 0:l.code,errorMessage:null==l?void 0:l.message}),"number"==typeof(null==l?void 0:l.code)&&h.isNetworkError(l.code))return void E({title:"网络异常，请检查网络后重试",icon:"none"});s.index.showModal({title:"未找到书籍信息",content:`ISBN：${a}\n\n数据库中暂无此书信息，请手动添加`,confirmText:"手动添加",cancelText:"重新扫描",success:e=>{e.confirm?s.index.navigateTo({url:`/pages/book/add-book?isbn=${a}`}):e.cancel&&U()}})}finally{try{s.index.hideLoading()}catch(t){g.logger.warn(o,"[handleScanISBN] hideLoading失败（非致命错误）",t)}j.value=!1}}catch(l){const o=v.createContext();if(null==(e=l.errMsg)?void 0:e.includes("cancel"))return void g.logger.debug(o,"[handleScanISBN] 用户取消扫码");g.logger.error(o,"[handleScanISBN] 扫码失败",l),s.index.showToast({title:"扫码失败，请重试",icon:"none"})}var n}),H=()=>{const e=v.createContext();g.logger.debug(e,"[handleRescan] 重新扫描"),w.value=!1,U()},V=e=>i(this,null,function*(){const o=v.createContext();g.logger.info(o,"[handleBookAdded] 书籍添加成功",{bookId:e.id}),yield A(!0)}),X=()=>{const e=v.createContext();g.logger.debug(e,"[addManually] 跳转到手动添加页面"),x.value=!1,s.index.navigateTo({url:"/pages/book/add-book"})},G=e=>{var o,n,l,t;P.value=null!=(t=null!=(l=null==(o=null==e?void 0:e.detail)?void 0:o.value)?l:null==(n=null==e?void 0:e.target)?void 0:n.value)?t:""},J=e=>i(this,null,function*(){var o,n;const l=null!=(n=null==(o=null==e?void 0:e.detail)?void 0:o.value)?n:P.value;T.value=l.trim(),P.value=T.value,yield A(!0)}),W=()=>{N.value=!0},K=()=>{N.value=!1},Q=()=>i(this,null,function*(){P.value="",T.value="",yield A(!0)});function Y(){var e,o,n,l,t,r;try{const a=null==(o=(e=s.index).getSystemInfoSync)?void 0:o.call(e);if(!a)return;q.value=a.windowWidth||375;const i=a.statusBarHeight||0,u=null==(l=(n=s.index).getMenuButtonBoundingClientRect)?void 0:l.call(n),d=null!=(t=null==u?void 0:u.bottom)?t:i+44,c=null!=(r=null==u?void 0:u.right)?r:q.value-16;M.value=d+6,L.value=Math.max(12,q.value-c)}catch(a){g.logger.warn(v.createContext(),"[BookshelfPage] 获取系统信息失败",a)}}return(e,o)=>s.e({a:s.p({title:"书架",showBack:!1}),b:!s.unref(b).isLoggedIn},s.unref(b).isLoggedIn?s.e({e:s.p({name:"search",size:"20",color:"#6b7280"}),f:P.value,g:s.o(G),h:s.o(J),i:s.o(J),j:s.o(W),k:s.o(K),l:P.value},P.value?{m:s.o(Q),n:s.p({name:"close",size:"20",color:"#6b7280"})}:{},{o:s.o(U),p:s.n({"search-box--focus":N.value}),q:s.s(s.unref(z)),r:y.value&&0===m.value.length},y.value&&0===m.value.length?{s:s.p({rows:4})}:{t:s.o(_),v:s.f(m.value,(e,o,n)=>({a:"42ebc204-6-"+n+",42ebc204-1",b:s.p({src:e.coverUrl,width:120,ratio:3/4,radius:16,padding:12,"bg-color":"#F5F7FA",shadow:!0}),c:s.t(e.title),d:s.t(e.noteCount||0),e:e.id,f:s.o(o=>(e=>{const o=v.createContext();g.logger.debug(o,"[goToBookDetail] 跳转到书籍详情",{bookId:e.id,title:e.title}),s.index.navigateTo({url:`/pages-book/detail/detail?id=${e.id}`})})(e),e.id)}))}):{c:s.o($),d:s.p({icon:"account",title:"登录后查看你的书架",actionText:"立即登录"})},{w:s.o(_),x:x.value},x.value?{y:s.p({name:"scan",size:"30"}),z:s.o(F),A:s.p({name:"edit-pen",size:"30"}),B:s.o(X),C:s.o(e=>x.value=e),D:s.p({mode:"bottom",round:24,closeable:!0,"z-index":10075,overlay:!0,"close-on-click-overlay":!0,"custom-style":I,modelValue:x.value})}:{},{E:s.p({loading:B.value,"bg-color":"#f5f7fa"}),F:w.value},w.value?{G:s.o(H),H:s.o(V),I:s.o(e=>w.value=e),J:s.p({book:S.value,modelValue:w.value})}:{})}}),S=s._export_sfc(w,[["__file","/Users/zhaolijian/Projects/chinese-rose-front/src/pages/index/index.vue"]]);wx.createPage(S);
