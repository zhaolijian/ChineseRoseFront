"use strict";var e=(e,a,t)=>new Promise((l,s)=>{var u=e=>{try{i(t.next(e))}catch(a){s(a)}},o=e=>{try{i(t.throw(e))}catch(a){s(a)}},i=e=>e.done?l(e.value):Promise.resolve(e.value).then(u,o);i((t=t.apply(e,a)).next())});const a=require("../../common/vendor.js"),t=require("../../utils/imageUpload.js"),l=require("../../api/modules/storage.js"),s=require("../../api/modules/book.js"),u=require("../../stores/modules/book.js");require("../../utils/request.js"),require("../../utils/logger.js"),require("../../utils/logger-helpers.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../constants/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),require("../../types/errorCodes.js"),require("../../constants/request.js"),require("../../utils/error-handler.js"),Math||o();const o=()=>"../../components/book/BookCover.js",i=a.defineComponent({__name:"add-book",setup(o){const i=a.ref(0),r=a.ref({title:"",author:"",publisher:"",publishDate:"",coverUrl:"",pages:null}),n=a.ref(""),v=a.ref({title:"",pages:""}),c=a.ref(0),d=u.useBookStore(),h=a.computed(()=>i.value+49.718+50),p=()=>{var e,t;try{const l=null==(t=(e=a.index).getSystemInfoSync)?void 0:t.call(e);if(!l)return;i.value=l.statusBarHeight||0}catch(l){i.value=0}};a.onLoad(()=>{p()}),a.onMounted(()=>{p()});const g=()=>{getCurrentPages().length>1?a.index.navigateBack():a.index.switchTab({url:"/pages/bookshelf/index"})},m=()=>{a.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:s=>e(this,null,function*(){var e;const u=null==(e=s.tempFilePaths)?void 0:e[0];if(u)try{c.value=1,n.value&&l.deleteTempObject(n.value).catch(()=>{});const{key:e,previewUrl:s}=yield t.presignAndUploadCover(u);n.value=e,r.value.coverUrl=s,c.value=100,a.index.showToast({title:"封面上传成功",icon:"success"})}catch(o){c.value=0,a.index.showToast({title:(null==o?void 0:o.message)||"上传失败",icon:"none"})}})})},b=e=>{r.value.publishDate=e.detail.value},f=()=>{const e=r.value.title.trim();e&&e.length>200?v.value.title="书名不能超过200字符":v.value.title=""},x=e=>{const a=e.detail.value;if(!a||""===a)return v.value.pages="",void(r.value.pages=null);const t=Number(a);if(!Number.isFinite(t))return v.value.pages="页数范围：1-50000",void(r.value.pages=null);t<1||t>5e4?v.value.pages="页数范围：1-50000":(v.value.pages="",r.value.pages=Math.floor(t))},j=()=>e(this,null,function*(){const e=r.value.title.trim();if(e&&0!==e.length)if(e.length>200)a.index.showToast({title:"书名不能超过200字符",icon:"none",duration:2e3});else if(v.value.pages)a.index.showToast({title:"页数范围：1-50000",icon:"none",duration:2e3});else try{a.index.showLoading({title:"创建中..."});const t={title:e,source:"manual"};r.value.author.trim()&&(t.author=r.value.author.trim()),r.value.publisher.trim()&&(t.publisher=r.value.publisher.trim()),r.value.publishDate&&(t.publishDate=`${r.value.publishDate}T00:00:00+08:00`),n.value&&(t.coverKey=n.value),null===r.value.pages||v.value.pages||(t.pages=r.value.pages),yield s.createBook(t),d.fetchBooks(1).catch(()=>{}),a.index.showToast({title:"添加成功",icon:"success"}),setTimeout(()=>{a.index.$emit("refreshBookList");getCurrentPages().length>1?a.index.navigateBack():a.index.switchTab({url:"/pages/bookshelf/index"})},1200)}catch(t){a.index.showToast({title:(null==t?void 0:t.message)||"创建失败",icon:"none"})}finally{a.index.hideLoading()}else a.index.showToast({title:"请输入书名",icon:"none",duration:2e3})});return(e,t)=>a.e({a:a.o(g),b:i.value+"px",c:!r.value.coverUrl},(r.value.coverUrl,{}),{d:c.value>0&&c.value<100},c.value>0&&c.value<100?{e:a.t(c.value)}:{},{f:a.p({src:r.value.coverUrl,width:144,ratio:3/4,radius:16,padding:12,shadow:!0,"bg-color":"#F5F7FA"}),g:a.o(m),h:a.o([e=>r.value.title=e.detail.value,f]),i:r.value.title,j:v.value.title},v.value.title?{k:a.t(v.value.title)}:{},{l:r.value.author,m:a.o(e=>r.value.author=e.detail.value),n:r.value.publisher,o:a.o(e=>r.value.publisher=e.detail.value),p:a.t(r.value.publishDate||"轻点选择"),q:r.value.publishDate?"":1,r:r.value.publishDate,s:a.o(b),t:a.o([a.m(e=>r.value.pages=e.detail.value,{number:!0}),x]),v:r.value.pages,w:v.value.pages},v.value.pages?{x:a.t(v.value.pages)}:{},{y:a.unref(h)+"px",z:a.o(j)})}}),r=a._export_sfc(i,[["__scopeId","data-v-05465a30"],["__file","/Users/zhaolijian/Projects/chinese-rose-front/src/pages/book/add-book.vue"]]);wx.createPage(r);
