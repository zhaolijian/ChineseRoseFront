"use strict";var e=(e,o,t)=>new Promise((a,s)=>{var r=e=>{try{l(t.next(e))}catch(o){s(o)}},n=e=>{try{l(t.throw(e))}catch(o){s(o)}},l=e=>e.done?a(e.value):Promise.resolve(e.value).then(r,n);l((t=t.apply(e,o)).next())});const o=require("../../common/vendor.js"),t=require("../../stores/modules/book.js"),a=require("../../stores/modules/note.js");require("../../utils/request.js");const s=require("../../utils/logger.js"),r=require("../../utils/logger-helpers.js"),n=require("../../utils/auth-guard.js");if(require("../../api/modules/note.js"),require("../../types/errorCodes.js"),require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(o.resolveComponent("u-icon")+o.resolveComponent("u-input")+o.resolveComponent("u-textarea")+o.resolveComponent("u-button")+o.resolveComponent("u-image")+o.resolveComponent("u-popup")+o.resolveComponent("u-loading-page"))()}Math||((()=>"../../node-modules/uview-plus/components/u-icon/u-icon.js")+l+(()=>"../../node-modules/uview-plus/components/u-input/u-input.js")+(()=>"../../node-modules/uview-plus/components/u-textarea/u-textarea.js")+(()=>"../../node-modules/uview-plus/components/u-button/u-button.js")+(()=>"../../node-modules/uview-plus/components/u-image/u-image.js")+(()=>"../../node-modules/uview-plus/components/u-popup/u-popup.js")+(()=>"../../node-modules/uview-plus/components/u-loading-page/u-loading-page.js"))();const l=()=>"../../components/book/BookCover.js",i=o.defineComponent({__name:"add",setup(l){const i=t.useBookStore(),u=a.useNoteStore(),c=o.reactive({title:"",content:"",bookId:void 0,noteType:"reading",pageNumber:"",chapterName:"",tags:[],images:[]}),d=o.ref([]),p=o.ref(null),m=o.ref(""),g=o.ref(!1),h=o.ref(!1),v=[{key:"reading",label:"阅读笔记",icon:"book"},{key:"thought",label:"思考感悟",icon:"heart"},{key:"quote",label:"摘录",icon:"quote-left"},{key:"summary",label:"总结",icon:"list"}],b=o.computed(()=>c.title.trim()&&c.content.trim()&&p.value);o.onLoad(e=>{if(e.bookId){const o=parseInt(e.bookId);c.bookId=o,y(o)}if(e.ocrText)try{const t=decodeURIComponent(e.ocrText);if(c.content=t,!c.title.trim()&&t.length>0){const e=t.trim().substring(0,20).replace(/\n/g," ");c.title=e+(t.length>20?"...":"")}o.index.showToast({title:"OCR内容已导入",icon:"success"})}catch(t){console.error("解析OCR文本失败:",t),o.index.showToast({title:"OCR内容导入失败",icon:"none"})}}),o.onMounted(()=>e(this,null,function*(){yield f()}));const f=()=>e(this,null,function*(){try{const e=yield i.fetchBooks(1,{pageSize:100});if(d.value=e.books,c.bookId){const e=d.value.find(e=>e.id===c.bookId);e&&(p.value=e)}}catch(e){console.error("加载书籍列表失败:",e)}}),y=o=>e(this,null,function*(){try{const e=yield i.fetchBookDetail(o);p.value=e}catch(e){console.error("加载书籍详情失败:",e)}}),k=()=>{const e=m.value.trim();e&&!c.tags.includes(e)&&c.tags.length<5&&(c.tags.push(e),m.value="")},w=()=>{o.index.chooseImage({count:9-c.images.length,sizeType:["compressed"],sourceType:["camera","album"],success:e=>{c.images.push(...e.tempFilePaths)}})},x=()=>{o.index.navigateTo({url:"/pages-note/ocr/ocr"})},j=()=>{o.index.showToast({title:"功能开发中",icon:"none"})},I=()=>e(this,null,function*(){const e=r.createContext();if(yield n.ensureLoggedIn("保存笔记"))if(b.value)try{g.value=!0;const t={title:c.title.trim(),content:c.content.trim(),bookId:c.bookId,noteType:c.noteType,tags:[...c.tags],pageNumber:c.pageNumber?parseInt(c.pageNumber):void 0,chapter:c.chapterName.trim()||void 0};s.logger.info(e,"[NoteAdd] 开始保存笔记",{title:t.title,bookId:t.bookId,contentLength:t.content.length}),yield u.createNote(t),s.logger.info(e,"[NoteAdd] 笔记保存成功"),o.index.showToast({title:"保存成功",icon:"success"}),setTimeout(()=>{o.index.navigateBack()},1500)}catch(t){s.logger.error(e,"[NoteAdd] 保存笔记失败",t),o.index.showToast({title:"保存失败",icon:"error"})}finally{g.value=!1}else o.index.showToast({title:"请填写完整信息",icon:"error"})}),q=()=>{c.title.trim()||c.content.trim()?o.index.showModal({title:"确认退出",content:"当前有未保存的内容，确定要退出吗？",success:e=>{e.confirm&&o.index.navigateBack()}}):o.index.navigateBack()};return(e,t)=>o.e({a:o.p({name:"arrow-left",size:"20",color:"#333"}),b:o.o(q),c:o.unref(b)?"":1,d:o.o(I),e:!p.value},(p.value,{}),{f:p.value},p.value?{g:o.p({src:p.value.coverUrl,width:80,ratio:3/4,radius:12,padding:8,shadow:!1,"bg-color":"#F5F7FA"}),h:o.t(p.value.title),i:o.t(p.value.author),j:o.p({name:"arrow-right",size:"16",color:"#999"})}:{k:o.p({name:"book",size:"20",color:"#999"}),l:o.p({name:"arrow-right",size:"16",color:"#999"})},{m:o.o(e=>h.value=!0),n:o.o(e=>c.title=e),o:o.p({placeholder:"请输入笔记标题",border:!1,"custom-style":e.inputStyle,maxlength:"100","show-word-limit":!0,modelValue:c.title}),p:o.f(v,(e,t,a)=>({a:"eacaff0b-6-"+a,b:o.p({name:e.icon,size:"18",color:c.noteType===e.key?"#00a82d":"#999"}),c:o.t(e.label),d:e.key,e:c.noteType===e.key?1:"",f:o.o(o=>c.noteType=e.key,e.key)})),q:o.o(e=>c.pageNumber=e),r:o.p({placeholder:"页码",type:"number",border:!1,"custom-style":e.smallInputStyle,modelValue:c.pageNumber}),s:o.o(e=>c.chapterName=e),t:o.p({placeholder:"章节名称",border:!1,"custom-style":e.smallInputStyle,modelValue:c.chapterName}),v:o.o(e=>c.content=e),w:o.p({placeholder:"请输入笔记内容...",border:!1,"custom-style":e.textareaStyle,"auto-height":!0,maxlength:"5000","show-word-limit":!0,modelValue:c.content}),x:c.tags.length>0},c.tags.length>0?{y:o.f(c.tags,(e,t,a)=>({a:o.t(e),b:o.o(e=>(e=>{c.tags.splice(e,1)})(t),t),c:"eacaff0b-10-"+a,d:t})),z:o.p({name:"close",size:"12",color:"#999"})}:{},{A:o.o(k),B:o.o(e=>m.value=e),C:o.p({placeholder:"添加标签...",border:!1,"custom-style":e.tagInputStyle,modelValue:m.value}),D:o.o(k),E:o.p({text:"添加",size:"small",type:"primary",disabled:!m.value.trim()}),F:c.images.length>0},c.images.length>0?{G:o.f(c.images,(e,t,a)=>({a:o.o(e=>(e=>{o.index.previewImage({urls:c.images,current:e})})(t),t),b:"eacaff0b-13-"+a,c:o.p({src:e,width:"80px",height:"80px",radius:"8",mode:"aspectFill"}),d:"eacaff0b-14-"+a,e:o.o(e=>(e=>{c.images.splice(e,1)})(t),t),f:t})),H:o.p({name:"close",size:"12",color:"#fff"})}:{},{I:o.p({name:"camera",size:"20",color:"#00a82d"}),J:o.o(w),K:o.p({name:"scan",size:"20",color:"#00a82d"}),L:o.o(x),M:o.p({name:"mic",size:"20",color:"#00a82d"}),N:o.o(j),O:o.f(d.value,(e,t,a)=>{var s,r;return o.e({a:"eacaff0b-19-"+a+",eacaff0b-18",b:o.p({src:e.coverUrl,width:80,ratio:3/4,radius:12,padding:8,shadow:!1,"bg-color":"#F5F7FA"}),c:o.t(e.title),d:o.t(e.author),e:(null==(s=p.value)?void 0:s.id)===e.id},(null==(r=p.value)?void 0:r.id)===e.id?{f:"eacaff0b-20-"+a+",eacaff0b-18",g:o.p({name:"checkmark",size:"16",color:"#00a82d"})}:{},{h:e.id,i:o.o(o=>(e=>{p.value=e,c.bookId=e.id,h.value=!1})(e),e.id)})}),P:o.o(e=>h.value=e),Q:o.p({mode:"bottom",height:"60%",round:"20",closeable:!0,modelValue:h.value}),R:o.p({loading:g.value,"bg-color":"rgba(255,255,255,0.8)"})})}}),u=o._export_sfc(i,[["__scopeId","data-v-eacaff0b"],["__file","/Users/zhaolijian/Projects/chinese-rose-front/src/pages-note/add/add.vue"]]);wx.createPage(u);
