"use strict";var e=Object.defineProperty,t=Object.defineProperties,o=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,a=(t,o,n)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[o]=n,l=(e,t,o)=>new Promise((n,r)=>{var i=e=>{try{l(o.next(e))}catch(t){r(t)}},a=e=>{try{l(o.throw(e))}catch(t){r(t)}},l=e=>e.done?n(e.value):Promise.resolve(e.value).then(i,a);l((o=o.apply(e,t)).next())});const s=require("../../common/vendor.js");require("../../utils/request.js");const c=require("../../utils/logger.js"),u=require("../../utils/logger-helpers.js"),d=require("../../types/errorCodes.js"),g=require("../../utils/auth-guard.js");if(require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(s.resolveComponent("u-icon")+s.resolveComponent("u-loading-icon")+s.resolveComponent("u-button")+s.resolveComponent("u-line-progress")+s.resolveComponent("u-textarea"))()}Math||((()=>"../../node-modules/uview-plus/components/u-icon/u-icon.js")+(()=>"../../node-modules/uview-plus/components/u-loading-icon/u-loading-icon.js")+m+(()=>"../../node-modules/uview-plus/components/u-button/u-button.js")+(()=>"../../node-modules/uview-plus/components/u-line-progress/u-line-progress.js")+(()=>"../../node-modules/uview-plus/components/u-textarea/u-textarea.js")+v+h)();const h=()=>"../../components/common/PageContainer.js",m=()=>"../../components/common/PrimaryButton.js",v=()=>"../../components/common/EmptyState.js",f=s.defineComponent({__name:"ocr",setup(e){class h extends Error{constructor(e,t,o){super(t),this.errorCode=e,this.errno=o,this.name="OCRError"}}const m=s.ref([]),v=s.ref([]),f=s.ref(!1),p=s.ref(!1),C=s.ref({current:0,total:0}),x=s.computed(()=>v.value.some(e=>{var t;return null==(t=e.editedText)?void 0:t.trim()})),R=()=>{const e=u.createContext();if(m.value.length>=9)return void s.index.showToast({title:"最多只能选择9张图片",icon:"none"});const t=9-m.value.length;s.index.chooseImage({count:t,sizeType:["compressed"],sourceType:["album","camera"],success:t=>l(this,null,function*(){var o,n;c.logger.info(e,"[OCRPage] 选择图片成功",{count:t.tempFilePaths.length,totalFiles:null==(o=t.tempFiles)?void 0:o.length});try{for(let e=0;e<t.tempFilePaths.length;e++){const o=t.tempFilePaths[e],r=null==(n=t.tempFiles)?void 0:n[e];r&&(yield O(o,r.size))}}catch(r){c.logger.error(e,"[OCRPage] 处理选择的图片失败",r),s.index.showToast({title:"处理图片失败",icon:"none"})}}),fail:t=>{c.logger.error(e,"[OCRPage] 选择图片失败",t),"chooseImage:fail cancel"!==t.errMsg&&s.index.showToast({title:"选择图片失败",icon:"none"})}})},O=(e,t)=>l(this,null,function*(){const o=u.createContext(),n=2097152;let r=e,i=t,a=!1;try{const l=yield w(e);if(t>n||l.width>1920||l.height>1920){c.logger.info(o,"[OCRPage] 开始智能压缩图片",{originalSize:t,originalWidth:l.width,originalHeight:l.height,reason:t>n?"size":"resolution"});const s=yield E(e,l,t);r=s.path,i=s.size,a=!0,c.logger.info(o,"[OCRPage] 智能压缩完成",{originalSize:t,compressedSize:i,compressionRatio:(i/t*100).toFixed(1)+"%"})}m.value.push({path:r,size:i,compressed:a,originalSize:t})}catch(l){c.logger.error(o,"[OCRPage] 处理图片失败",l),m.value.push({path:e,size:t,compressed:!1,originalSize:t})}}),w=e=>new Promise((t,o)=>{s.index.getImageInfo({src:e,success:e=>{t({width:e.width,height:e.height,type:e.type})},fail:o})}),E=(e,t,o)=>l(this,null,function*(){const n=u.createContext();let r=92,i=t.width,a=t.height;o>8388608?r=85:o>5242880?r=88:o>2097152&&(r=90);const l=Math.min(t.width,t.height),s=Math.max(t.width,t.height);if(s>2400){const e=2400/s;i=Math.floor(t.width*e),a=Math.floor(t.height*e),c.logger.info(n,"[smartCompressImage] 压缩超大图片",{originalSize:`${t.width}x${t.height}`,newSize:`${i}x${a}`,ratio:e.toFixed(3)})}else if(l<800&&s>800){const e=800/l;i=Math.floor(t.width*e),a=Math.floor(t.height*e),c.logger.info(n,"[smartCompressImage] 放大小图提升OCR质量",{originalSize:`${t.width}x${t.height}`,newSize:`${i}x${a}`,ratio:e.toFixed(3)})}return c.logger.info(n,"[smartCompressImage] OCR压缩策略",{originalSize:$(o),resolution:`${t.width}x${t.height}`,targetQuality:r,sizeAdjusted:i!==t.width||a!==t.height}),P(e,r,i,a)}),P=(e,t=90,o,n)=>{const r=u.createContext();return new Promise((i,a)=>{const l={src:e,quality:t,success:t=>{s.index.getFileInfo({filePath:t.tempFilePath,success:o=>{c.logger.info(r,"[OCRPage] 压缩图片成功",{originalPath:e,compressedPath:t.tempFilePath,compressedSize:o.size}),i({path:t.tempFilePath,size:o.size})},fail:()=>{i({path:t.tempFilePath,size:0})}})},fail:e=>{c.logger.error(r,"[OCRPage] 压缩图片失败",e),a(e)}};o&&n&&(l.width=o,l.height=n),s.index.compressImage(l)})},_=e=>{const l=u.createContext();c.logger.info(l,"[OCRPage] 删除图片",{index:e}),m.value.splice(e,1),v.value=v.value.filter(t=>t.imageIndex!==e).map(l=>{return s=((e,t)=>{for(var o in t||(t={}))r.call(t,o)&&a(e,o,t[o]);if(n)for(var o of n(t))i.call(t,o)&&a(e,o,t[o]);return e})({},l),c={imageIndex:l.imageIndex>e?l.imageIndex-1:l.imageIndex},t(s,o(c));var s,c})},T=()=>{const e=u.createContext();c.logger.info(e,"[OCRPage] 清空所有图片"),m.value=[],v.value=[],C.value={current:0,total:0}},I=()=>l(this,null,function*(){1===m.value.length&&(f.value=!0,yield b(0),f.value=!1)}),y=()=>l(this,null,function*(){if(0!==m.value.length){p.value=!0,C.value={current:0,total:m.value.length};for(let e=0;e<m.value.length;e++)C.value.current=e,yield b(e),e<m.value.length-1&&(yield new Promise(e=>setTimeout(e,500)));C.value.current=m.value.length,p.value=!1}}),b=e=>l(this,null,function*(){var t;const o=u.createContext();try{c.logger.info(o,"[OCRPage] 开始OCR识别",{imageIndex:e});const r=m.value[e];if(!r)throw new Error("图片不存在");let i;yield G();try{i=yield N(r.path)}catch(n){throw new h(d.ErrorCode.ERR_OCR_IMAGE_PROCESS_ERROR,"获取图片数据失败")}const a=yield B(i);c.logger.info(o,"[OCRPage] OCR识别成功",{imageIndex:e,textsCount:null==(t=a.texts)?void 0:t.length}),j(e,a)}catch(r){if(c.logger.error(o,"[OCRPage] OCR识别异常",{imageIndex:e,error:r}),yield z(e,r),!p.value)throw r}}),j=(e,t)=>{const o=u.createContext(),n=t.texts||[],r=n.map(e=>e.text).join("\n").trim(),i=n.length>0?n.reduce((e,t)=>e+(t.confidence||0),0)/n.length:0;if(c.logger.info(o,"[OCRPage] 处理OCR结果",{imageIndex:e,textLength:r.length,confidence:i}),!r||0===r.length)return c.logger.warn(o,"[OCRPage] 未识别到文字内容",{imageIndex:e}),V(e),void s.index.showToast({title:"未识别到文字，请手动输入",icon:"none",duration:2e3});const a=v.value.findIndex(t=>t.imageIndex===e),l={imageIndex:e,originalText:r,editedText:r,texts:n,confidence:i};a>=0?v.value[a]=l:v.value.push(l)},z=(e,t)=>l(this,null,function*(){const o=u.createContext(),n=t instanceof h?t.errorCode:d.ErrorCode.ERR_OCR_FAILED,r=t instanceof h?t.errno:void 0;c.logger.error(o,"[OCRPage] OCR识别失败",{imageIndex:e,errorMessage:t.message,errorCode:n,errno:r}),p.value&&e!==m.value.length-1||(yield S(e,n))}),S=(e,t)=>l(this,null,function*(){const o=u.createContext();c.logger.info(o,"[OCRPage] 触发OCR降级处理",{imageIndex:e,errorCode:t||d.ErrorCode.ERR_OCR_FAILED});const n=e=>{const t=d.getFriendlyErrorMessage(e||d.ErrorCode.ERR_OCR_FAILED);switch(e){case d.ErrorCode.ERR_OCR_VK_NOT_SUPPORTED:return t;case d.ErrorCode.ERR_OCR_IMAGE_PROCESS_ERROR:return`${t}，是否手动输入？`;case d.ErrorCode.ERR_OCR_TIMEOUT:return`${t}，是否重试或手动输入？`;case d.ErrorCode.ERR_OCR_RECOGNITION_FAILED:default:return`${t}，是否手动输入？`}},r=t!==d.ErrorCode.ERR_OCR_VK_NOT_SUPPORTED;return new Promise(o=>{r?s.index.showModal({title:"识别失败",content:n(t),showCancel:!0,confirmText:"手动输入",cancelText:"重试",success:t=>{t.confirm?V(e):setTimeout(()=>{b(e).catch(()=>{V(e)})},1e3),o()},fail:()=>{V(e),o()}}):s.index.showModal({title:"功能提示",content:n(t),showCancel:!1,confirmText:"知道了",success:()=>{V(e),o()}})})}),V=e=>{const t=u.createContext(),o={imageIndex:e,originalText:"",editedText:"",texts:[],confidence:0},n=v.value.findIndex(t=>t.imageIndex===e);n>=0?v.value[n]=o:v.value.push(o),c.logger.info(t,"[OCRPage] 创建手动输入结果",{imageIndex:e}),setTimeout(()=>{s.index.showToast({title:"请在下方文本框中输入内容",icon:"none",duration:2e3})},500)},K=e=>l(this,null,function*(){yield b(e)}),F=e=>v.value.find(t=>t.imageIndex===e),M=e=>f.value&&0===e||p.value&&e===C.value.current,$=e=>{if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(1))+" "+["B","KB","MB","GB"][t]},q=()=>l(this,null,function*(){const e=u.createContext();if(!(yield g.ensureLoggedIn("保存笔记")))return;const t=v.value.filter(e=>{var t;return null==(t=e.editedText)?void 0:t.trim()}).map(e=>e.editedText.trim()).join("\n\n");t?(c.logger.info(e,"[OCRPage] 保存为笔记",{textLength:t.length}),s.index.navigateTo({url:`/pages-note/add/add?ocrText=${encodeURIComponent(t)}`})):s.index.showToast({title:"请先输入文字内容",icon:"none"})}),A=()=>{const e=u.createContext(),t=v.value.filter(e=>{var t;return null==(t=e.editedText)?void 0:t.trim()}).map(e=>e.editedText.trim()).join("\n\n");t?(c.logger.info(e,"[OCRPage] 导出文本",{textLength:t.length}),D(t)):s.index.showToast({title:"没有可导出的内容",icon:"none"})},D=e=>{(null==e?void 0:e.trim())?s.index.setClipboardData({data:e,success:()=>{s.index.showToast({title:"已复制到剪贴板",icon:"success"})},fail:()=>{s.index.showToast({title:"复制失败",icon:"none"})}}):s.index.showToast({title:"没有可复制的内容",icon:"none"})};let L=null;const U=()=>{var e,t,o,n;if(void 0===s.wx$1||!s.wx$1.createVKSession)return!1;return!!((null==(t=(e=s.wx$1).isVKSupport)?void 0:t.call(e,"v2"))?"v2":(null==(n=(o=s.wx$1).isVKSupport)?void 0:n.call(o,"v1"))?"v1":"")},N=e=>{const t=u.createContext();return new Promise((o,n)=>{s.index.getImageInfo({src:e,success:r=>{c.logger.info(t,"[OCRPage] 获取图片信息成功",{width:r.width,height:r.height});const i=s.index.createCanvasContext("temp-canvas");i.drawImage(e,0,0,r.width,r.height),i.draw(!1,()=>{s.index.canvasGetImageData({canvasId:"temp-canvas",x:0,y:0,width:r.width,height:r.height,success:e=>{o({data:e.data.buffer,width:r.width,height:r.height})},fail:e=>{c.logger.error(t,"[OCRPage] 获取canvas数据失败",e),n(e)}})})},fail:e=>{c.logger.error(t,"[OCRPage] 获取图片信息失败",e),n(e)}})})},B=e=>{const t=u.createContext();return new Promise((o,n)=>{if(!L)return void n(new h(d.ErrorCode.ERR_OCR_VK_NOT_SUPPORTED,"VK会话意外未初始化"));let r,i=!1;const a=()=>{r&&clearTimeout(r),L.off("updateAnchors",l)};r=setTimeout(()=>{i||(i=!0,a(),c.logger.error(t,"[runVKOCR] OCR识别超时"),n(new h(d.ErrorCode.ERR_OCR_TIMEOUT,"OCR识别超时",void 0)))},15e3);const l=e=>{if(i)return;i=!0,a(),c.logger.info(t,"[runVKOCR] VK OCR识别完成",{anchorsCount:e.length});const n=e.map(e=>({text:e.text||"",confidence:e.confidence||.9}));o({texts:n})};L.on("updateAnchors",l),L.start(o=>{if(!i){if(o){i=!0,a();const e=(e=>{switch(e){case 1:case 2:case 3:return d.ErrorCode.ERR_OCR_VK_NOT_SUPPORTED;case 4:case 7:return d.ErrorCode.ERR_OCR_IMAGE_PROCESS_ERROR;case 5:return d.ErrorCode.ERR_OCR_TIMEOUT;case 6:case 8:return d.ErrorCode.ERR_OCR_RECOGNITION_FAILED;case 9:return d.ErrorCode.ERR_OCR_SERVICE_UNAVAIL;default:return d.ErrorCode.ERR_OCR_FAILED}})(o);return c.logger.error(t,"[runVKOCR] VK会话启动失败",{errno:o,errorCode:e}),void n(new h(e,"VK会话启动失败",o))}try{L.runOCR({frameBuffer:e.data,width:e.width,height:e.height})}catch(r){if(!i){i=!0,a();const e=d.ErrorCode.ERR_OCR_IMAGE_PROCESS_ERROR;c.logger.error(t,"[runVKOCR] 运行OCR失败",r),n(new h(e,"运行OCR失败",void 0))}}}})})},G=()=>l(this,null,function*(){if(L)return;const e=u.createContext();if(!U())throw new h(d.ErrorCode.ERR_OCR_VK_NOT_SUPPORTED,"设备不支持VisionKit OCR");try{yield(()=>{const e=u.createContext();return new Promise((t,o)=>{var n,r;try{const o=(null==(r=(n=s.wx$1).isVKSupport)?void 0:r.call(n,"v2"))?"v2":"v1";L=s.wx$1.createVKSession({version:o,track:{OCR:{mode:2}}}),c.logger.info(e,"[OCRPage] VK会话已创建",{version:o}),t()}catch(i){c.logger.error(e,"[OCRPage] 创建VK会话失败",i),o(i)}})})(),c.logger.info(e,"[ensureVKSession] VisionKit OCR会话已就绪")}catch(t){throw c.logger.error(e,"[ensureVKSession] VisionKit初始化失败",t),new h(d.ErrorCode.ERR_OCR_VK_NOT_SUPPORTED,"VisionKit初始化失败")}});return s.onMounted(()=>{const e=u.createContext();c.logger.info(e,"[OCRPage] 页面加载完成"),U()||c.logger.warn(e,"[OCRPage] 设备不支持VisionKit，将使用降级方案")}),s.onBeforeUnmount(()=>{const e=u.createContext();if(L)try{L.destroy(),c.logger.info(e,"[OCRPage] VK会话已销毁")}catch(t){c.logger.error(e,"[OCRPage] 销毁VK会话失败",t)}}),(e,t)=>s.e({a:s.t(9),b:m.value.length>0},m.value.length>0?{c:s.f(m.value,(e,t,o)=>s.e({a:e.path,b:s.t($(e.size)),c:e.compressed},(e.compressed,{}),{d:"82e0be74-1-"+o+",82e0be74-0",e:s.o(e=>_(t),t),f:F(t)},F(t)?{g:"82e0be74-2-"+o+",82e0be74-0",h:s.p({name:"checkmark-circle-fill",size:"16",color:"#4CAF50"})}:M(t)?{j:"82e0be74-3-"+o+",82e0be74-0",k:s.p({mode:"circle",size:"16"})}:{},{i:M(t),l:t})),d:s.p({name:"close-circle-fill",size:"20",color:"#fff"})}:{},{e:s.p({name:"plus",size:"40",color:"#999"}),f:s.t(0===m.value.length?"点击选择图片":`${m.value.length}/9`),g:s.o(R),h:m.value.length>=9?1:"",i:m.value.length>0},m.value.length>0?s.e({j:1===m.value.length},1===m.value.length?{k:s.o(I),l:s.p({type:"primary",loading:f.value,disabled:f.value||p.value})}:{},{m:m.value.length>1},m.value.length>1?{n:s.t(m.value.length),o:s.o(y),p:s.p({type:"primary",loading:p.value,disabled:f.value||p.value})}:{},{q:s.o(T),r:s.p({type:"default",disabled:f.value||p.value}),s:p.value&&C.value.total>0},p.value&&C.value.total>0?{t:s.t(C.value.current),v:s.t(C.value.total),w:s.p({percentage:C.value.current/C.value.total*100,"show-percent":!1,"active-color":"#2E7D32"})}:{}):{},{x:v.value.length>0},v.value.length>0?{y:s.f(v.value,(e,t,o)=>{var n,r,i,a,l;return s.e({a:s.t(e.imageIndex+1),b:s.o(t=>K(e.imageIndex),t),c:"82e0be74-9-"+o+",82e0be74-0",d:s.o(t=>(e=>{const t=v.value.findIndex(t=>t.imageIndex===e);t>=0&&(v.value[t].editedText="")})(e.imageIndex),t),e:"82e0be74-10-"+o+",82e0be74-0",f:"82e0be74-11-"+o+",82e0be74-0",g:s.o(t=>e.editedText=t,t),h:s.p({placeholder:e.originalText||"请输入文字内容",autoHeight:!0,minHeight:100,maxLength:5e3,count:!0,modelValue:e.editedText}),i:e.confidence},e.confidence?{j:s.t((100*e.confidence).toFixed(1)),k:s.n((l=e.confidence,l>=.9?"confidence-high":l>=.7?"confidence-medium":"confidence-low"))}:{},{l:s.t((null==(n=e.editedText)?void 0:n.length)||0),m:s.t((a=e.editedText,a?a.split("\n").length:0)),n:null==(r=e.texts)?void 0:r.length},(null==(i=e.texts)?void 0:i.length)?{o:s.t(e.texts.length)}:{},{p:s.o(t=>(e=>{var t,o;const n=u.createContext();if(!(null==(t=e.editedText)?void 0:t.trim()))return void s.index.showToast({title:"没有文本内容",icon:"none"});let r=e.editedText.replace(/\s+/g," ").replace(/([。！？])\s*([^\s])/g,"$1\n$2").replace(/，\s*/g,"，").trim();e.editedText=r,c.logger.info(n,"[OCRPage] 文本格式化完成",{originalLength:(null==(o=e.originalText)?void 0:o.length)||0,formattedLength:r.length}),s.index.showToast({title:"格式化完成",icon:"success"})})(e),t),q:"82e0be74-12-"+o+",82e0be74-0",r:s.o(e=>{s.index.showToast({title:"翻译功能开发中",icon:"none"})},t),s:"82e0be74-13-"+o+",82e0be74-0",t:s.o(t=>D(e.editedText),t),v:"82e0be74-14-"+o+",82e0be74-0",w:s.o(t=>(e=>{s.index.showModal({title:"确认清空",content:"确定要清空这段识别结果吗？",showCancel:!0,success:t=>{t.confirm&&(e.editedText="",s.index.showToast({title:"已清空",icon:"success"}))}})})(e),t),x:"82e0be74-15-"+o+",82e0be74-0",y:t})}),z:s.p({type:"default",size:"mini"}),A:s.p({type:"default",size:"mini"}),B:s.p({type:"default",size:"mini"}),C:s.p({type:"default",size:"mini"}),D:s.p({type:"default",size:"mini"}),E:s.p({type:"default",size:"mini"})}:{},{F:v.value.length>0},v.value.length>0?{G:s.o(q),H:s.p({type:"primary",disabled:!s.unref(x)}),I:s.o(A),J:s.p({type:"default"})}:{},{K:0===m.value.length},0===m.value.length?{L:s.p({icon:"camera",title:"开始文字识别",description:"选择图片进行OCR识别，支持中英文混合内容"})}:{})}}),p=s._export_sfc(f,[["__scopeId","data-v-82e0be74"],["__file","/Users/zhaolijian/Projects/chinese-rose-front/src/pages-note/ocr/ocr.vue"]]);wx.createPage(p);
