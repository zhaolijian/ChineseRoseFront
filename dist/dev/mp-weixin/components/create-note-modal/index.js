"use strict";var e=(e,t,o)=>new Promise((l,n)=>{var r=e=>{try{a(o.next(e))}catch(t){n(t)}},i=e=>{try{a(o.throw(e))}catch(t){n(t)}},a=e=>e.done?l(e.value):Promise.resolve(e.value).then(r,i);a((o=o.apply(e,t)).next())});const t=require("../../common/vendor.js"),o=require("../../api/modules/book.js");require("../../utils/request.js");const l=require("../../utils/logger.js"),n=require("../../utils/logger-helpers.js");if(require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(t.resolveComponent("u-icon")+t.resolveComponent("u-popup")+t.resolveComponent("u-overlay"))()}Math||(r+(()=>"../../node-modules/uview-plus/components/u-icon/u-icon.js")+(()=>"../../node-modules/uview-plus/components/u-popup/u-popup.js")+(()=>"../../node-modules/uview-plus/components/u-overlay/u-overlay.js"))();const r=()=>"../book/BookCover.js",i=t.defineComponent({__name:"index",props:{open:{type:Boolean},initialBookId:null,currentBookId:null,initialBookTitle:null,initialNoteCount:null,initialCoverUrl:null,initialBooks:null,chapters:null},emits:["update:open","confirm","close"],setup(r,{emit:i}){const a=r,{proxy:u}=t.getCurrentInstance();function d(o,l){return e(this,null,function*(){return yield new Promise(e=>setTimeout(e,100)),new Promise(e=>{t.index.createSelectorQuery().in(u).select(o).boundingClientRect(t=>{console.log("[DEBUG measureRowHeight] 测量详情：",{selector:o,rect:t?{height:t.height,width:t.width,top:t.top,bottom:t.bottom,left:t.left,right:t.right}:null,fallback:l});const n=(null==t?void 0:t.height)?Math.max(1,Math.round(t.height)):l;console.log("[DEBUG measureRowHeight] 最终高度：",n,"(原始值:",null==t?void 0:t.height,")"),e(n)}).exec()})})}function s(e){const{anchorTop:t,topLimit:o,gap:l,rowHeight:n,totalRows:r,preferredRows:i}=e,a=Math.max(0,t-o-l),u=Math.floor(a/n),d=Math.max(1,Math.min(i,u,r)),s=Math.max(n,d*n),c=t-s-l;return{panelHeight:Math.round(s),panelTop:Math.round(c),visibleRows:d}}const c="/static/cover-default.png",p=t.computed(()=>{var e,t;return null!=(t=null!=(e=a.initialBookId)?e:a.currentBookId)?t:0}),h=t.computed({get:()=>a.open,set:e=>i("update:open",e)}),g=t.ref(!1),v=t.ref(!1),f=t.ref([]),w=t.ref(null),m=t.ref([]),x=t.ref(""),C=t.reactive({top:"0px",left:"0px",width:"0px",height:"0px"}),M=t.reactive({top:"0px",left:"0px",width:"0px",height:"0px"}),b=t.computed(()=>f.value.find(e=>e.id===w.value)||null),y=t.computed(()=>g.value||v.value);function k(){g.value=!1,v.value=!1}function N(){return e(this,null,function*(){var e;const t=n.createContext();if(!(f.value.length>1))try{l.logger.info(t,"[CreateNoteModal] 开始加载书籍列表");const n=yield o.getBookList({page:1,limit:100});let r=[];Array.isArray(n)?r=n:(null==n?void 0:n.books)?r=n.books:(null==(e=null==n?void 0:n.data)?void 0:e.list)?r=n.data.list:(null==n?void 0:n.data)&&(r=Array.isArray(n.data)?n.data:[]),f.value=r.map(e=>{var t,o,l,n,r,i,a;return{id:null!=(t=e.id)?t:e.bookId,title:null!=(l=null!=(o=e.title)?o:e.name)?l:"",cover:null!=(n=e.cover)?n:e.coverUrl,coverUrl:null!=(r=e.coverUrl)?r:e.cover,noteCount:null!=(a=null!=(i=e.noteCount)?i:e.totalNotes)?a:0,author:e.author}}).filter(e=>e.id&&e.title),l.logger.info(t,"[CreateNoteModal] 书籍列表加载成功",{count:f.value.length})}catch(r){l.logger.error(t,"[CreateNoteModal] 书籍列表加载失败",r)}})}function j(){return e(this,null,function*(){const o=n.createContext();yield N(),v.value=!1,C.top="-9999px",g.value=!0,setTimeout(()=>e(this,null,function*(){t.index.createSelectorQuery().in(u).select("#book-field").boundingClientRect(n=>e(this,null,function*(){if(l.logger.debug(o,"[CreateNoteModal] 获取锚点rect",{rect:n?{top:n.top,left:n.left,width:n.width,height:n.height}:null}),!n){l.logger.warn(o,"[CreateNoteModal] 未获取到锚点rect，使用兜底定位");const{windowHeight:e,windowWidth:n}=t.index.getWindowInfo();return C.top=Math.round(.2*e)+"px",C.left=Math.round(.1*n)+"px",C.width=Math.round(.8*n)+"px",void(C.height=Math.round(.5*e)+"px")}C.width=`${Math.round(n.width)}px`,C.left=`${Math.round(n.left)}px`,yield new Promise(e=>setTimeout(e,16));const{windowHeight:e}=t.index.getWindowInfo(),r=.35*e,i=yield d(".cr-book-item",Math.round(t.index.upx2px(88))),{panelHeight:a,panelTop:u,visibleRows:c}=s({anchorTop:n.top,topLimit:r,gap:2,rowHeight:i,totalRows:f.value.length,preferredRows:4});C.top=`${u}px`,C.height=`${a}px`,l.logger.info(o,"[CreateNoteModal] 书籍面板(整数行)定位完成",{rowHeight:i,visibleRows:c,panelHeight:a,anchorTop:n.top,panelTop:u,gap:2,topLimit:r,totalRows:f.value.length})})).exec()}),150)})}function R(t){return e(this,null,function*(){const e=n.createContext();if(t)if(a.chapters&&a.chapters.length)m.value=a.chapters.map((e,t)=>({id:t,name:e}));else try{l.logger.info(e,"[CreateNoteModal] 开始加载章节列表",{bookId:t});const n=yield o.getBookChapters(Number(t));let r=[];Array.isArray(n)?r=n:(null==n?void 0:n.chapters)?r=n.chapters:(null==n?void 0:n.data)&&(r=Array.isArray(n.data)?n.data:[]),m.value=r.map((e,t)=>{var o,l,n;return{id:null!=(o=e.id)?o:t,name:"string"==typeof e?e:null!=(n=null!=(l=e.name)?l:e.title)?n:""}}).filter(e=>e.name),l.logger.info(e,"[CreateNoteModal] 章节列表加载成功",{count:m.value.length})}catch(r){l.logger.error(e,"[CreateNoteModal] 章节列表加载失败",r),m.value=[]}else m.value=[]})}function T(){const o=n.createContext();if(!b.value)return l.logger.warn(o,"[CreateNoteModal] 未选择书籍"),void(g.value=!0);m.value&&0!==m.value.length?(g.value=!1,M.top="-9999px",v.value=!0,setTimeout(()=>e(this,null,function*(){t.index.createSelectorQuery().in(u).select("#chapter-field").boundingClientRect(n=>e(this,null,function*(){if(l.logger.debug(o,"[CreateNoteModal] 获取章节字段rect",{rect:n?{top:n.top,left:n.left,width:n.width,height:n.height}:null}),!n){l.logger.warn(o,"[CreateNoteModal] 未获取到章节字段rect，使用兜底定位");const{windowHeight:e,windowWidth:n}=t.index.getWindowInfo();return M.top=Math.round(.2*e)+"px",M.left=Math.round(.1*n)+"px",M.width=Math.round(.8*n)+"px",void(M.height=Math.round(.5*e)+"px")}M.width=`${Math.round(n.width)}px`,M.left=`${Math.round(n.left)}px`,yield new Promise(e=>setTimeout(e,16));const{windowHeight:e}=t.index.getWindowInfo(),r=.35*e,i=yield d(".cr-chapter-item",Math.round(t.index.upx2px(80))),{panelHeight:a,panelTop:u,visibleRows:c}=s({anchorTop:n.top,topLimit:r,gap:2,rowHeight:i,totalRows:m.value.length,preferredRows:6});M.top=`${u}px`,M.height=`${a}px`,l.logger.info(o,"[CreateNoteModal] 章节面板(整数行)定位完成",{rowHeight:i,visibleRows:c,panelHeight:a,anchorTop:n.top,panelTop:u,gap:2,topLimit:r,totalRows:m.value.length})})).exec()}),150)):l.logger.debug(o,"[CreateNoteModal] 无章节，允许手动输入")}function $(e){var t,o,r;const i=n.createContext();x.value=(null==(r=null!=(o=null==(t=null==e?void 0:e.detail)?void 0:t.value)?o:x.value)?void 0:r.trim())||"",v.value=!1,l.logger.debug(i,"[CreateNoteModal] 章节输入确认",{text:x.value})}function I(){const e=n.createContext();l.logger.debug(e,"[CreateNoteModal] 关闭弹窗"),k(),i("close"),i("update:open",!1)}function q(){const e=n.createContext();if(!b.value)return l.logger.warn(e,"[CreateNoteModal] 未选择书籍"),void(g.value=!0);k();const t=x.value.trim()||void 0;l.logger.info(e,"[CreateNoteModal] 确认创建笔记",{bookId:b.value.id,chapterTitle:t}),i("confirm",{bookId:b.value.id,chapterTitle:t}),h.value=!1}return t.watch(()=>a.open,t=>e(this,null,function*(){var e,o;const r=n.createContext();if(!t)return;l.logger.debug(r,"[CreateNoteModal] 弹窗打开"),yield N();const i=f.value.find(e=>e.id===p.value);w.value=i?i.id:null!=(o=null==(e=f.value[0])?void 0:e.id)?o:null,l.logger.info(r,"[CreateNoteModal] 默认选中书籍",{currentId:p.value,selectedBookId:w.value,bookListCount:f.value.length}),w.value&&(yield R(w.value)),x.value=""})),(e,o)=>{var r,i,a;return{a:t.p({src:(null==(r=t.unref(b))?void 0:r.cover)||(null==(i=t.unref(b))?void 0:i.coverUrl)||c,width:48,ratio:3/4,radius:8,padding:0,"bg-color":"#F5F7FA",shadow:!1}),b:t.t(t.unref(b)?`${t.unref(b).title}（${null!=(a=t.unref(b).noteCount)?a:0}条笔记）`:"请选择一本书籍"),c:t.p({name:"arrow-down",size:"18"}),d:t.o(j),e:t.o($),f:t.o(()=>{}),g:x.value,h:t.o(e=>x.value=e.detail.value),i:t.o(T),j:t.o(q),k:t.o(I),l:t.p({show:t.unref(h),mode:"bottom",closeable:!0,"close-on-click-overlay":!t.unref(y),round:27,"safe-area-inset-bottom":!0,"custom-style":{padding:"0",backgroundColor:"transparent"}}),m:t.o(k),n:t.p({show:t.unref(y),"z-index":10090}),o:t.f(f.value,(e,o,r)=>{var i;return t.e({a:"40988549-4-"+r,b:t.p({src:e.cover||e.coverUrl||c,width:48,ratio:3/4,radius:8,padding:0,"bg-color":"#F5F7FA",shadow:!1}),c:t.t(e.title),d:t.t(null!=(i=e.noteCount)?i:0),e:e.id===w.value},e.id===w.value?{f:"40988549-5-"+r,g:t.p({name:"checkmark",size:"18",color:"#16A34A"})}:{},{h:e.id,i:t.o(t=>function(e){const t=n.createContext();w.value=e.id,g.value=!1,x.value="",l.logger.info(t,"[CreateNoteModal] 选择书籍",{bookId:e.id,title:e.title}),R(e.id)}(e),e.id)})}),p:g.value,q:t.s(`position:fixed;z-index:10100;top:${C.top};left:${C.left};width:${C.width};height:${C.height};`),r:t.o(()=>{}),s:t.f(m.value,(e,o,r)=>({a:t.t(e.name),b:o,c:t.o(t=>function(e){const t=n.createContext();x.value=e.name,v.value=!1,l.logger.info(t,"[CreateNoteModal] 选择章节",{chapter:e.name})}(e),o)})),t:v.value,v:t.s(`position:fixed;z-index:10100;top:${M.top};left:${M.left};width:${M.width};height:${M.height};`),w:t.o(()=>{})}}}}),a=t._export_sfc(i,[["__scopeId","data-v-40988549"],["__file","/Users/zhaolijian/Projects/chinese-rose-front/src/components/create-note-modal/index.vue"]]);wx.createComponent(a);
