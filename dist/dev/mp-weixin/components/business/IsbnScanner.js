"use strict";const e=require("../../common/vendor.js"),o=require("../../api/modules/book.js");require("../../utils/request.js");const s=require("../../utils/logger.js"),n=require("../../utils/logger-helpers.js");if(require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-button")+e.resolveComponent("u-input")+e.resolveComponent("u-popup"))()}Math||((()=>"../../node-modules/uview-plus/components/u-icon/u-icon.js")+(()=>"../../node-modules/uview-plus/components/u-button/u-button.js")+(()=>"../../node-modules/uview-plus/components/u-input/u-input.js")+(()=>"../../node-modules/uview-plus/components/u-popup/u-popup.js"))();const t=e.defineComponent({__name:"IsbnScanner",props:{modelValue:null},setup(t,{emit:r}){const u=t,l=e.ref(u.modelValue||""),a=e.ref(""),i=e.ref(!1),c=e.ref(!1),p=e=>{if(!e)return!1;const o=e.replace(/[-\s]/g,"");return/^\d{13}$/.test(o)},d=()=>{const o=n.createContext();e.index.scanCode({scanType:["barCode"],success:n=>{s.logger.info(o,"[IsbnScanner] 扫码成功",{result:n.result});const t=n.result.trim();p(t)?(l.value=t,r("update:modelValue",t),r("scanComplete",t)):e.index.showToast({title:"扫码结果不是有效的ISBN",icon:"none"})},fail:n=>{s.logger.error(o,"[IsbnScanner] 扫码失败",n),"scanCode:fail cancel"!==n.errMsg&&e.index.showToast({title:"扫码失败，请重试",icon:"none"})}})},m=()=>{return t=this,u=null,a=function*(){if(!l.value)return;const t=n.createContext();try{c.value=!0,s.logger.info(t,"[IsbnScanner] 开始查询ISBN",{isbn:l.value});const n=yield o.searchBookByISBN(l.value);s.logger.info(t,"[IsbnScanner] ISBN查询成功",{isbn:l.value,title:n.title}),r("bookFound",n),e.index.showToast({title:"找到书籍信息",icon:"success"})}catch(u){s.logger.error(t,"[IsbnScanner] ISBN查询失败",u),e.index.showModal({title:"查询失败",content:"未找到该ISBN的书籍信息，是否手动添加？",confirmText:"手动添加",cancelText:"重新扫码",success:e=>{e.confirm?r("bookFound",{id:0,title:"",isbn:l.value,source:"manual"}):f()}})}finally{c.value=!1}},new Promise((e,o)=>{var s=e=>{try{r(a.next(e))}catch(s){o(s)}},n=e=>{try{r(a.throw(e))}catch(s){o(s)}},r=o=>o.done?e(o.value):Promise.resolve(o.value).then(s,n);r((a=a.apply(t,u)).next())});var t,u,a},v=()=>{p(a.value)&&(l.value=a.value,r("update:modelValue",a.value),r("scanComplete",a.value),i.value=!1,a.value="")},f=()=>{l.value="",r("update:modelValue","")};return(o,s)=>e.e({a:l.value},l.value?{b:e.p({name:"checkmark-circle",size:"20",color:"#4CAF50"}),c:e.t(l.value),d:e.o(m),e:e.p({type:"primary",size:"small",loading:c.value}),f:e.o(f),g:e.p({type:"default",size:"small"})}:{h:e.p({name:"scan",size:"40",color:"#2E7D32"}),i:e.o(d)},{j:!l.value},l.value?{}:{k:e.o(e=>i.value=!0),l:e.p({type:"default",size:"small"})},{m:e.o(e=>a.value=e),n:e.p({placeholder:"请输入13位ISBN码",maxlength:"13",type:"number","custom-style":{marginBottom:"20rpx"},modelValue:a.value}),o:e.o(e=>i.value=!1),p:e.p({type:"default"}),q:e.o(v),r:e.p({type:"primary",disabled:!p(a.value)}),s:e.o(e=>i.value=e),t:e.p({mode:"center","custom-style":{padding:"40rpx"},modelValue:i.value})})}}),r=e._export_sfc(t,[["__scopeId","data-v-04b2777a"],["__file","/Users/zhaolijian/Projects/chinese-rose-front/src/components/business/IsbnScanner.vue"]]);wx.createComponent(r);
