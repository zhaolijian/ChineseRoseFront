"use strict";const e=require("../../common/vendor.js"),o=require("../../api/modules/book.js");require("../../utils/request.js");const r=require("../../utils/logger.js"),t=require("../../utils/logger-helpers.js");if(require("../../constants/request.js"),require("../../constants/storage.js"),require("../../utils/error-handler.js"),require("../../types/errorCodes.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),!Array){(e.resolveComponent("u-icon")+e.resolveComponent("u-button")+e.resolveComponent("u-input")+e.resolveComponent("u-popup"))()}const l=e.defineComponent({__name:"IsbnScanner",props:{modelValue:null},setup(l,{emit:s}){const n=l,a=e.ref(n.modelValue||""),u=e.ref(""),i=e.ref(!1),c=e.ref(!1),p=e=>{if(!e)return!1;const o=e.replace(/[-\s]/g,"");return/^\d{13}$/.test(o)},d=()=>{const o=t.createContext();e.index.scanCode({scanType:["barCode"],success:t=>{r.logger.info(o,"[IsbnScanner] 扫码成功",{result:t.result});const l=t.result.trim();p(l)?(a.value=l,s("update:modelValue",l),s("scanComplete",l)):e.index.showToast({title:"扫码结果不是有效的ISBN",icon:"none"})},fail:t=>{r.logger.error(o,"[IsbnScanner] 扫码失败",t),"scanCode:fail cancel"!==t.errMsg&&e.index.showToast({title:"扫码失败，请重试",icon:"none"})}})},m=()=>{return l=this,n=null,u=function*(){if(!a.value)return;const l=t.createContext();try{c.value=!0,r.logger.info(l,"[IsbnScanner] 开始查询ISBN",{isbn:a.value});const t=yield o.searchBookByISBN(a.value);r.logger.info(l,"[IsbnScanner] ISBN查询成功",{isbn:a.value,title:t.title}),s("bookFound",t),e.index.showToast({title:"找到书籍信息",icon:"success"})}catch(n){r.logger.error(l,"[IsbnScanner] ISBN查询失败",n),e.index.showModal({title:"查询失败",content:"未找到该ISBN的书籍信息，是否手动添加？",confirmText:"手动添加",cancelText:"重新扫码",success:e=>{e.confirm?s("bookFound",{id:0,title:"",isbn:a.value,source:"manual"}):g()}})}finally{c.value=!1}},new Promise((e,o)=>{var r=e=>{try{s(u.next(e))}catch(r){o(r)}},t=e=>{try{s(u.throw(e))}catch(r){o(r)}},s=o=>o.done?e(o.value):Promise.resolve(o.value).then(r,t);s((u=u.apply(l,n)).next())});var l,n,u},v=()=>{p(u.value)&&(a.value=u.value,s("update:modelValue",u.value),s("scanComplete",u.value),i.value=!1,u.value="")},g=()=>{a.value="",s("update:modelValue","")};return(o,r)=>e.e({a:a.value},a.value?{b:e.p({name:"checkmark-circle",size:"20",color:"#4CAF50"}),c:e.t(a.value),d:e.o(m),e:e.p({type:"primary",size:"small",loading:c.value}),f:e.o(g),g:e.p({type:"default",size:"small"})}:{h:e.p({name:"scan",size:"40",color:"#2E7D32"}),i:e.o(d)},{j:!a.value},a.value?{}:{k:e.o(e=>i.value=!0),l:e.p({type:"default",size:"small"})},{m:e.o(e=>u.value=e),n:e.p({placeholder:"请输入13位ISBN码",maxlength:"13",type:"number","custom-style":{marginBottom:"20rpx"},modelValue:u.value}),o:e.o(e=>i.value=!1),p:e.p({type:"default"}),q:e.o(v),r:e.p({type:"primary",disabled:!p(u.value)}),s:e.o(e=>i.value=e),t:e.p({mode:"center","custom-style":{padding:"40rpx"},modelValue:i.value})})}}),s=e._export_sfc(l,[["__scopeId","data-v-678a2a52"]]);wx.createComponent(s);
