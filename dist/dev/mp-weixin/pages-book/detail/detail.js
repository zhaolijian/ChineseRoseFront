"use strict";var e=(e,o,t)=>new Promise((l,r)=>{var i=e=>{try{n(t.next(e))}catch(o){r(o)}},a=e=>{try{n(t.throw(e))}catch(o){r(o)}},n=e=>e.done?l(e.value):Promise.resolve(e.value).then(i,a);n((t=t.apply(e,o)).next())});const o=require("../../common/vendor.js"),t=require("../../stores/modules/book.js"),l=require("../../api/modules/book.js");if(require("../../utils/request.js"),require("../../utils/logger.js"),require("../../utils/logger-helpers.js"),require("../../stores/modules/user.js"),require("../../utils/storage.js"),require("../../constants/storage.js"),require("../../utils/base64.js"),require("../../api/modules/auth.js"),require("../../types/errorCodes.js"),require("../../constants/request.js"),require("../../utils/error-handler.js"),!Array){(o.resolveComponent("u-icon")+o.resolveComponent("u-image")+o.resolveComponent("u-button")+o.resolveComponent("u-line-progress")+o.resolveComponent("u-empty")+o.resolveComponent("u-slider")+o.resolveComponent("u-popup")+o.resolveComponent("u-loading-page"))()}Math||r();const r=()=>"../../components/common/AppNavBar.js",i=o.defineComponent({__name:"detail",setup(r){const i=t.useBookStore(),a=o.ref(null),n=o.ref([]),s=o.ref(!1),u=o.ref(!1),d=o.ref(!1),c=o.ref(0),v=o.ref(0);o.onLoad(e=>{e.id&&(v.value=parseInt(e.id))}),o.onMounted(()=>e(this,null,function*(){yield p()})),o.onShow(()=>e(this,null,function*(){yield g()}));const p=()=>e(this,null,function*(){if(v.value)try{s.value=!0;const e=yield i.fetchBookDetail(v.value);a.value=e,c.value=e.progress||0,yield g()}catch(e){console.error("加载书籍详情失败:",e),o.index.showToast({title:"加载失败",icon:"error"})}finally{s.value=!1}else o.index.showToast({title:"书籍ID不存在",icon:"error"})}),g=()=>e(this,null,function*(){try{n.value=[]}catch(e){console.error("加载最近笔记失败:",e)}}),h=()=>e(this,null,function*(){try{u.value=!0,yield i.updateReadingProgress(v.value,c.value),a.value&&(a.value.progress=c.value),d.value=!1,o.index.showToast({title:"进度更新成功",icon:"success"})}catch(e){console.error("更新进度失败:",e),o.index.showToast({title:"更新失败",icon:"error"})}finally{u.value=!1}}),m=()=>{o.index.navigateTo({url:`/pages-note/add/add?bookId=${v.value}`})},f=()=>{o.index.navigateTo({url:`/pages-note/list/list?bookId=${v.value}`})},x=()=>{o.index.navigateTo({url:`/pages-mindmap/view/view?bookId=${v.value}`})},y=e=>{if(!e)return"";const o=new Date(e),t=(new Date).getTime()-o.getTime(),l=Math.floor(t/6e4),r=Math.floor(t/36e5),i=Math.floor(t/864e5);return l<60?`${l}分钟前`:r<24?`${r}小时前`:i<7?`${i}天前`:o.toLocaleDateString()},w=()=>{o.index.showModal({title:"确认删除书籍",content:"删除后，该书籍下的笔记仍会保留在笔记列表中",confirmText:"确认删除",confirmColor:"#ee0a24",success:t=>e(this,null,function*(){if(t.confirm)try{o.index.showLoading({title:"删除中...",mask:!0}),yield l.deleteBook(v.value),o.index.hideLoading(),o.index.showToast({title:"删除成功",icon:"success"}),setTimeout(()=>{o.index.navigateBack()},1500)}catch(e){o.index.hideLoading(),console.error("删除书籍失败:",e),o.index.showToast({title:"删除失败",icon:"error"})}})})};return(e,t)=>{var l,r,i,v,p,g,b,q,j;return o.e({a:o.o(w),b:o.p({name:"trash",size:"20",color:"#ee0a24"}),c:o.p({title:"书籍详情",showBack:!0}),d:o.p({src:(null==(l=a.value)?void 0:l.coverUrl)||"/static/images/book-placeholder.png",mode:"aspectFit",width:"120px",height:"160px",radius:"8","loading-icon":"book"}),e:o.t((null==(r=a.value)?void 0:r.title)||"未知书籍"),f:o.t((null==(i=a.value)?void 0:i.author)||"未知作者"),g:null==(v=a.value)?void 0:v.isbn},(null==(p=a.value)?void 0:p.isbn)?{h:o.t(a.value.isbn)}:{},{i:o.t((null==(g=a.value)?void 0:g.noteCount)||0),j:o.t((null==(b=a.value)?void 0:b.progress)||0),k:o.o(m),l:o.p({type:"primary",size:"small"}),m:o.o(x),n:o.p({type:"info",size:"small"}),o:o.o(e=>d.value=!0),p:o.p({percent:(null==(q=a.value)?void 0:q.progress)||0,"active-color":"#00a82d","inactive-color":"#e9ecef",height:"8"}),q:o.t((null==(j=a.value)?void 0:j.progress)||0),r:o.o(f),s:0===n.value.length},0===n.value.length?{t:o.o(m),v:o.p({type:"primary",text:"添加第一条笔记",size:"small"}),w:o.p({mode:"list",text:"还没有添加笔记",textColor:"#999",iconSize:"60"})}:{x:o.f(n.value,(e,t,l)=>o.e({a:o.t(e.title),b:o.t(y(e.createdAt)),c:o.t(e.content),d:e.tags&&e.tags.length>0},e.tags&&e.tags.length>0?{e:o.f(e.tags,(e,t,l)=>({a:o.t(e),b:e}))}:{},{f:e.id,g:o.o(t=>(e=>{o.index.navigateTo({url:`/pages-note/edit/edit?id=${e.id}`})})(e),e.id)}))},{y:o.t(c.value),z:o.o(e=>c.value=e),A:o.p({min:"0",max:"100",step:"1","inactive-color":"#e9ecef","active-color":"#00a82d","block-color":"#00a82d",modelValue:c.value}),B:o.o(e=>d.value=!1),C:o.p({text:"取消"}),D:o.o(h),E:o.p({type:"primary",text:"确定",loading:u.value}),F:o.o(e=>d.value=e),G:o.p({mode:"center",width:"300px",height:"250px",round:"16",closeable:!0,modelValue:d.value}),H:o.p({loading:s.value,"bg-color":"#f5f7fa"})})}}}),a=o._export_sfc(i,[["__scopeId","data-v-ebfe9438"]]);wx.createPage(a);
