"use strict";var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,a=(t,r,o)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o,i=(e,t)=>{for(var r in t||(t={}))s.call(t,r)&&a(e,r,t[r]);if(o)for(var r of o(t))n.call(t,r)&&a(e,r,t[r]);return e},d=(e,o)=>t(e,r(o)),c=(e,t,r)=>(a(e,"symbol"!=typeof t?t+"":t,r),r);const l=require("../common/vendor.js"),u=require("./logger.js"),g=require("./logger-helpers.js"),p=require("../constants/request.js"),h=require("../constants/storage.js"),E=require("./error-handler.js"),R=require("../types/errorCodes.js");let m=!1;const I=new class{constructor(){c(this,"baseURL",""),c(this,"timeout",p.DEFAULT_REQUEST_TIMEOUT),c(this,"requestInterceptors",[]),c(this,"responseInterceptors",[]),c(this,"errorInterceptors",[]),this.setBaseURL(),this.setupDefaultInterceptors()}setBaseURL(){var e,t,r,o,s;const n={VITE_API_BASE:"https://api.chinese-rose.com/api",VITE_AGREEMENT_URL_USER:"https://chinese-rose.com/agreement/user",VITE_AGREEMENT_URL_PRIVACY:"https://chinese-rose.com/agreement/privacy",VITE_USER_NODE_ENV:"production",VITE_ROOT_DIR:"/Users/zhaolijian/Projects/chinese-rose-front",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1},a=n.VITE_API_BASE,i=g.createRequestContext();u.logger.debug(i,"[setBaseURL] 环境变量检查",{VITE_API_BASE:a,MODE:n.MODE,DEV:n.DEV});const d=n.VITE_API_BASE_MP_DEV||n.VITE_API_BASE_DEV||"http://127.0.0.1:8080/api";let c=!1;try{const n=null==(t=(e=l.index).getSystemInfoSync)?void 0:t.call(e);"devtools"===(null==n?void 0:n.platform)&&(c=!0,u.logger.debug(i,"[setBaseURL] 检测到微信开发者工具 platform=devtools"));const a=null==(o=(r=l.index).getAccountInfoSync)?void 0:o.call(r),d=null==(s=null==a?void 0:a.miniProgram)?void 0:s.envVersion;"develop"!==d&&"trial"!==d||(c=!0,u.logger.debug(i,`[setBaseURL] envVersion=${d}，视为调试环境`))}catch(p){u.logger.warn(i,"[setBaseURL] 检测小程序运行环境失败",p)}return c?(this.baseURL=d||a||"http://127.0.0.1:8080/api",void u.logger.warn(i,`[setBaseURL] 微信调试环境强制使用调试基址: ${this.baseURL}`)):a?(this.baseURL=a,void u.logger.info(i,`[setBaseURL] 使用环境变量配置: ${this.baseURL}`)):(this.baseURL="http://127.0.0.1:8080/api",u.logger.info(i,"[setBaseURL] 小程序默认地址: http://127.0.0.1:8080/api"),this.baseURL="http://127.0.0.1:8080/api",u.logger.info(i,"[setBaseURL] 其他平台默认地址: http://127.0.0.1:8080/api"),void u.logger.info(i,`[setBaseURL] 最终baseURL: ${this.baseURL}`))}setupDefaultInterceptors(){this.addRequestInterceptor(e=>{const t=e.logContext||g.createRequestContext();e.logContext=t,e.headers=d(i({},e.headers),{"X-Trace-Id":t.traceId});let r="";try{const e=l.index.getStorageSync(h.TOKEN_KEY);if(e){const t=JSON.parse(e);!t.expires||Date.now()<=t.expires?r=t.value:l.index.removeStorageSync(h.TOKEN_KEY)}}catch(o){u.logger.error(t,"[setupDefaultInterceptors] 获取token失败",o)}return r?(e.headers=d(i({},e.headers),{Authorization:`Bearer ${r}`}),u.logger.debug(t,"[addRequestInterceptor] 已添加token")):u.logger.debug(t,"[addRequestInterceptor] 无token"),u.logger.debug(t,`[addRequestInterceptor] 请求 ${e.method||"GET"} ${e.url}`),e}),this.addResponseInterceptor(e=>{var t;const{statusCode:r,data:o}=e,s=(null==(t=e.config)?void 0:t.logContext)||g.createRequestContext();return u.logger.info(s,`[addResponseInterceptor] 响应状态码: ${r}`),401===r||403===r?(u.logger.warn(s,`[addResponseInterceptor] HTTP ${r} 认证失败，清除登录状态并跳转登录`),this.redirectToLogin(),Promise.reject({code:r,message:401===r?"登录已过期，请重新登录":"访问被拒绝"})):o&&void 0!==o.code?0===o.code?(u.logger.debug(s,"[addResponseInterceptor] 请求成功"),o.data):(u.logger.warn(s,`[addResponseInterceptor] 业务错误 - 错误码: ${o.code}, 信息: ${o.message}`),this.handleBusinessError(o),Promise.reject(o)):(u.logger.error(s,"[addResponseInterceptor] 响应数据格式异常",o),l.index.showToast({title:"服务器响应格式异常",icon:"none"}),Promise.reject({code:-1,message:"响应格式异常"}))}),this.addErrorInterceptor(e=>(this.handleNetworkError(e),Promise.reject(e)))}addRequestInterceptor(e){this.requestInterceptors.push(e)}addResponseInterceptor(e){this.responseInterceptors.push(e)}addErrorInterceptor(e){this.errorInterceptors.push(e)}handleBusinessError(e){const t=(null==e?void 0:e.code)||0,r=g.createRequestContext();u.logger.warn(r,"[handleBusinessError] 业务错误",e),E.handleError(e,{showToast:!0,needLogin:R.isAuthError(t)})}redirectToLogin(){const e=g.createRequestContext();if(m)u.logger.warn(e,"[redirectToLogin] 正在跳转中，忽略重复请求");else{m=!0;try{l.index.removeStorageSync(h.TOKEN_KEY),l.index.removeStorageSync(h.USER_INFO_KEY),l.index.removeStorageSync("chinese_rose_token"),l.index.removeStorageSync("chinese_rose_userInfo"),l.index.removeStorageSync("token"),l.index.removeStorageSync("user"),l.index.removeStorageSync("userInfo"),g.clearRequestContext();try{"../stores/modules/user.js".then(t=>{const{useUserStore:r}=t,o=r();o.token="",o.userInfo=null,u.logger.debug(e,"[redirectToLogin] 已清除store状态")})}catch(t){u.logger.warn(e,"[redirectToLogin] 清除store状态失败（非致命错误）",t)}u.logger.info(e,"[redirectToLogin] 已清除用户信息，跳转到登录页"),l.index.reLaunch({url:"/pages/login/login"})}finally{setTimeout(()=>{m=!1},p.REDIRECT_THROTTLE_TIME)}}}handleNetworkError(e){const t=g.createRequestContext();u.logger.error(t,"[handleNetworkError] 网络请求错误",e),E.handleError(e,{showToast:!0,canRetry:!0,retryCallback:()=>{const e=getCurrentPages(),t=e[e.length-1];t&&t.onLoad&&t.onLoad(t.options)}})}request(e){return t=this,r=null,o=function*(){var t;let r=e;for(const e of this.requestInterceptors)r=yield e(r);!1!==r.showLoading&&l.index.showLoading({title:"加载中...",mask:!0});try{const e=r.url.startsWith("http")?r.url:this.baseURL+r.url,o="GET"===(r.method||"GET").toUpperCase()&&null!=(t=r.params)?t:r.data,s=r.logContext||g.createRequestContext();r.logContext=s,u.logger.info(s,`[request] 开始请求 ${r.method||"GET"} ${e}`,{data:o,headers:r.headers});const n=yield new Promise((t,s)=>{l.wx$1.request({url:e,method:r.method||"GET",data:o,header:i({"Content-Type":"application/json"},r.headers),timeout:r.timeout||this.timeout,success:e=>t(e),fail:e=>s(e)})});!1!==r.showLoading&&l.index.hideLoading();let a=n;for(const t of this.responseInterceptors)a=t(a);return a}catch(o){!1!==r.showLoading&&l.index.hideLoading();for(const e of this.errorInterceptors)yield e(o);throw o}finally{g.clearRequestContext()}},new Promise((e,s)=>{var n=e=>{try{i(o.next(e))}catch(t){s(t)}},a=e=>{try{i(o.throw(e))}catch(t){s(t)}},i=t=>t.done?e(t.value):Promise.resolve(t.value).then(n,a);i((o=o.apply(t,r)).next())});var t,r,o}get(e,t,r){return this.request(i({url:e,method:"GET",params:t},r))}post(e,t,r){return this.request(i({url:e,method:"POST",data:t},r))}put(e,t,r){return this.request(i({url:e,method:"PUT",data:t},r))}delete(e,t){return this.request(i({url:e,method:"DELETE"},t))}upload(e,t){return new Promise((r,o)=>{let s="";try{const e=l.index.getStorageSync(h.TOKEN_KEY);if(e){const t=JSON.parse(e);(!t.expires||Date.now()<=t.expires)&&(s=t.value)}}catch(n){const e=g.createRequestContext();u.logger.error(e,"[upload] 文件上传获取token失败",n)}l.index.uploadFile({url:this.baseURL+"/upload",filePath:e,name:"file",formData:t,header:{Authorization:s?`Bearer ${s}`:""},success:e=>{try{const t=JSON.parse(e.data);0===t.code?r(t):o(t)}catch(t){o({code:-1,message:"响应解析失败"})}},fail:o})})}},T=e=>I.request(e);T.get=I.get.bind(I),T.post=I.post.bind(I),T.put=I.put.bind(I),T.delete=I.delete.bind(I),T.upload=I.upload.bind(I);const f=T;exports.http=I,exports.request=f;
