"use strict";var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,a=(t,r,o)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o,i=(e,t)=>{for(var r in t||(t={}))s.call(t,r)&&a(e,r,t[r]);if(o)for(var r of o(t))n.call(t,r)&&a(e,r,t[r]);return e},d=(e,o)=>t(e,r(o)),l=(e,t,r)=>(a(e,"symbol"!=typeof t?t+"":t,r),r);const c=require("../common/vendor.js"),u=require("./logger.js"),g=require("./logger-helpers.js"),h=require("../constants/request.js"),p=require("../constants/storage.js"),E=require("./error-handler.js"),I=require("../types/errorCodes.js"),_=require("../stores/modules/user.js");let f=!1;const m=new class{constructor(){l(this,"baseURL",""),l(this,"timeout",h.DEFAULT_REQUEST_TIMEOUT),l(this,"requestInterceptors",[]),l(this,"responseInterceptors",[]),l(this,"errorInterceptors",[]),l(this,"loadingCount",0),this.setBaseURL(),this.setupDefaultInterceptors()}setBaseURL(){var e,t;const r={VITE_API_BASE:"http://localhost:8080/api",VITE_API_BASE_MP_DEV:"http://127.0.0.1:8080/api",VITE_API_BASE_MP_DEVICE:"http://192.168.2.207:8080/api",VITE_DEV_LOGIN_CODE:"123456",VITE_USER_NODE_ENV:"development",VITE_ROOT_DIR:"/Users/zhaolijian/Projects/chinese-rose-front",BASE_URL:"/",MODE:"development",DEV:!0,PROD:!1,SSR:!1},o=r.VITE_API_BASE,s=g.createRequestContext();u.logger.debug(s,"[setBaseURL] 环境变量检查",{VITE_API_BASE:o,VITE_API_BASE_MP_DEV:r.VITE_API_BASE_MP_DEV,VITE_API_BASE_MP_DEVICE:r.VITE_API_BASE_MP_DEVICE,MODE:r.MODE,DEV:r.DEV});let n=!1,a="unknown";try{const r=null==(t=(e=c.index).getSystemInfoSync)?void 0:t.call(e);a=(null==r?void 0:r.platform)||"unknown","devtools"===a&&(n=!0,u.logger.debug(s,"[setBaseURL] 检测到微信开发者工具 platform=devtools"))}catch(i){u.logger.warn(s,"[setBaseURL] 检测小程序运行环境失败",i)}if(n){const e=r.VITE_API_BASE_MP_DEV||r.VITE_API_BASE_DEV||"http://127.0.0.1:8080/api";return this.baseURL=e||o||"http://127.0.0.1:8080/api",void u.logger.warn(s,`[setBaseURL] 微信开发者工具环境，使用本地调试基址: ${this.baseURL}`,{platform:a})}{const e=r.VITE_API_BASE_MP_DEVICE;if(!e||""===e.trim()){const e='真机环境未配置API地址！\n请在 .env.development 中设置 VITE_API_BASE_MP_DEVICE\n获取IP方法：\nMac: ifconfig | grep "inet " | grep -v 127.0.0.1\nWindows: ipconfig 查看IPv4地址\n示例: VITE_API_BASE_MP_DEVICE=http://192.168.31.88:8080/api';throw u.logger.error(s,"[setBaseURL] "+e.replace(/\n/g," ")),c.index.showModal({title:"网络配置错误",content:"真机环境需要配置局域网IP地址，请联系开发者",showCancel:!1}),new Error(e)}return this.baseURL=e,void u.logger.info(s,`[setBaseURL] 真机环境，使用配置的局域网API基址: ${this.baseURL}`,{platform:a})}}setupDefaultInterceptors(){this.addRequestInterceptor(e=>{const t=e.logContext||g.createRequestContext();e.logContext=t,e.headers=d(i({},e.headers),{"X-Trace-Id":t.traceId});let r="";try{const e=c.index.getStorageSync(p.TOKEN_KEY);if(e){const t=JSON.parse(e);!t.expires||Date.now()<=t.expires?r=t.value:c.index.removeStorageSync(p.TOKEN_KEY)}}catch(o){u.logger.error(t,"[setupDefaultInterceptors] 获取token失败",o)}return r?(e.headers=d(i({},e.headers),{Authorization:`Bearer ${r}`}),u.logger.debug(t,"[addRequestInterceptor] 已添加token")):u.logger.debug(t,"[addRequestInterceptor] 无token"),u.logger.debug(t,`[addRequestInterceptor] 请求 ${e.method||"GET"} ${e.url}`),e}),this.addResponseInterceptor(e=>{var t;const{statusCode:r,data:o,config:s}=e,n=(null==(t=e.config)?void 0:t.logContext)||g.createRequestContext();return u.logger.info(n,`[addResponseInterceptor] 响应状态码: ${r}`),401===r||403===r?(u.logger.warn(n,`[addResponseInterceptor] HTTP ${r} 认证失败，清除登录状态并跳转登录`),this.redirectToLogin(),Promise.reject({code:r,message:401===r?"登录已过期，请重新登录":"访问被拒绝"})):o&&void 0!==o.code?0===o.code?(u.logger.debug(n,"[addResponseInterceptor] 请求成功"),o.data):(u.logger.warn(n,`[addResponseInterceptor] 业务错误 - 错误码: ${o.code}, 信息: ${o.message}`),this.handleBusinessError(o,s),Promise.reject(d(i({},o),{config:s}))):(u.logger.error(n,"[addResponseInterceptor] 响应数据格式异常",o),c.index.showToast({title:"服务器响应格式异常",icon:"none"}),Promise.reject({code:-1,message:"响应格式异常"}))}),this.addErrorInterceptor(e=>(this.handleNetworkError(e),Promise.reject(e)))}addRequestInterceptor(e){this.requestInterceptors.push(e)}addResponseInterceptor(e){this.responseInterceptors.push(e)}addErrorInterceptor(e){this.errorInterceptors.push(e)}handleBusinessError(e,t){const r=(null==e?void 0:e.code)||0,o=g.createRequestContext();u.logger.warn(o,"[handleBusinessError] 业务错误",e);((null==t?void 0:t.silenceBusinessErrorCodes)||[]).includes(r)?u.logger.info(o,`[handleBusinessError] 已静默错误码 ${r}`,e):E.handleError(e,{showToast:!0,needLogin:I.isAuthError(r)})}redirectToLogin(){const e=g.createRequestContext();if(f)u.logger.warn(e,"[redirectToLogin] 正在跳转中，忽略重复请求");else{f=!0;try{c.index.removeStorageSync(p.TOKEN_KEY),c.index.removeStorageSync(p.USER_INFO_KEY),c.index.removeStorageSync("chinese_rose_token"),c.index.removeStorageSync("chinese_rose_userInfo"),c.index.removeStorageSync("token"),c.index.removeStorageSync("user"),c.index.removeStorageSync("userInfo"),g.clearRequestContext();try{const t=_.useUserStore();t.token="",t.userInfo=null,u.logger.debug(e,"[redirectToLogin] 已清除store状态")}catch(t){u.logger.warn(e,"[redirectToLogin] 清除store状态失败（非致命错误）",t)}u.logger.info(e,"[redirectToLogin] 已清除用户信息，跳转到登录页"),c.index.reLaunch({url:"/pages/login/login"})}finally{setTimeout(()=>{f=!1},h.REDIRECT_THROTTLE_TIME)}}}handleNetworkError(e){const t=g.createRequestContext();u.logger.error(t,"[handleNetworkError] 网络请求错误",e),E.handleError(e,{showToast:!0,canRetry:!0,retryCallback:()=>{const e=getCurrentPages(),t=e[e.length-1];t&&t.onLoad&&t.onLoad(t.options)}})}request(e){return t=this,r=null,o=function*(){var t,r,o;let s=e;for(const e of this.requestInterceptors)s=yield e(s);!1!==s.showLoading&&(0===this.loadingCount&&c.index.showLoading({title:"加载中...",mask:!0}),this.loadingCount++);try{const e=s.url.startsWith("http")?s.url:this.baseURL+s.url,o="GET"===(s.method||"GET").toUpperCase()&&null!=(t=s.params)?t:s.data,n=s.logContext||g.createRequestContext();s.logContext=n,u.logger.info(n,`[request] 开始请求 ${s.method||"GET"} ${e}`,{data:o,headers:s.headers});const a=yield new Promise((t,r)=>{c.wx$1.request({url:e,method:s.method||"GET",data:o,header:i({"Content-Type":"application/json"},s.headers),timeout:s.timeout||this.timeout,success:e=>t(d(i({},e),{config:s})),fail:e=>r(d(i({},e),{config:s}))})});if(!1!==s.showLoading&&(this.loadingCount>0&&this.loadingCount--,0===this.loadingCount)){const e=null==(r=c.index)?void 0:r.hideLoading;"function"==typeof e&&e()}let l=a;for(const t of this.responseInterceptors)l=t(l);return l}catch(n){if(!1!==s.showLoading&&(this.loadingCount>0&&this.loadingCount--,0===this.loadingCount)){const e=null==(o=c.index)?void 0:o.hideLoading;"function"==typeof e&&e()}for(const e of this.errorInterceptors)yield e(n);throw n}finally{g.clearRequestContext()}},new Promise((e,s)=>{var n=e=>{try{i(o.next(e))}catch(t){s(t)}},a=e=>{try{i(o.throw(e))}catch(t){s(t)}},i=t=>t.done?e(t.value):Promise.resolve(t.value).then(n,a);i((o=o.apply(t,r)).next())});var t,r,o}get(e,t,r){return this.request(i({url:e,method:"GET",params:t},r))}post(e,t,r){return this.request(i({url:e,method:"POST",data:t},r))}put(e,t,r){return this.request(i({url:e,method:"PUT",data:t},r))}delete(e,t){return this.request(i({url:e,method:"DELETE"},t))}upload(e,t){return new Promise((r,o)=>{let s="";try{const e=c.index.getStorageSync(p.TOKEN_KEY);if(e){const t=JSON.parse(e);(!t.expires||Date.now()<=t.expires)&&(s=t.value)}}catch(n){const e=g.createRequestContext();u.logger.error(e,"[upload] 文件上传获取token失败",n)}c.index.uploadFile({url:this.baseURL+"/upload",filePath:e,name:"file",formData:t,header:{Authorization:s?`Bearer ${s}`:""},success:e=>{try{const t=JSON.parse(e.data);0===t.code?r(t):o(t)}catch(t){o({code:-1,message:"响应解析失败"})}},fail:o})})}},T=e=>m.request(e);T.get=m.get.bind(m),T.post=m.post.bind(m),T.put=m.put.bind(m),T.delete=m.delete.bind(m),T.upload=m.upload.bind(m);const P=T;exports.http=m,exports.request=P;
