"use strict";var e=Object.defineProperty,r=(r,o,t)=>(((r,o,t)=>{o in r?e(r,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[o]=t})(r,"symbol"!=typeof o?o+"":o,t),t);const o=require("../common/vendor.js"),t=require("../types/errorCodes.js"),s=require("./logger.js");function n(){return{traceId:`req_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,userId:"",timestamp:Date.now(),platform:"miniprogram"}}const a={"-10000":"系统繁忙，请稍后重试","-10001":"系统升级中，请稍后访问",40001:"获取微信信息失败，请重试",40002:"微信授权失败，请重新授权",40003:"微信登录失败，请使用其他方式登录",40163:"操作过于频繁，请稍后再试",42001:"微信授权已过期，请重新授权",45011:"操作太频繁，请稍后再试",NETWORK_ERROR:"网络异常，请检查网络连接",TIMEOUT:"请求超时，请稍后重试",REQUEST_FAILED:"请求失败，请重试",404:"请求的资源不存在",500:"服务器异常，请稍后重试",502:"网关错误，请稍后重试",503:"服务暂时不可用，请稍后重试"};const i=new class{constructor(){r(this,"retryCallbacks",new Map)}handle(e,r={}){const{showToast:a=!0,canRetry:i=!1,retryCallback:c=null,duration:l=2500,needLogin:d=!1,silent:u=!1}=r,g=n(),{code:h,message:E}=this.extractErrorInfo(e);return s.logger.error(g,"[ErrorHandler] 错误处理",{error:e,code:h,message:E,options:r}),u?E:t.isAuthError(h)||d?(this.handleAuthError(E),E):t.isQuotaError(h)?(this.handleQuotaError(E),E):t.isNetworkError(h)&&i&&c?(this.showRetryModal(E,c),E):(a&&o.index.showToast({title:E,icon:"none",duration:l}),E)}extractErrorInfo(e){if("string"==typeof e)return{code:-1,message:e};let r=0;if(void 0!==e.errorCode?r=e.errorCode:void 0!==e.errCode?r=e.errCode:void 0!==e.err_code?r=e.err_code:void 0!==e.code?r=e.code:void 0!==e.statusCode&&(r=e.statusCode),e.errMsg){if(e.errMsg.includes("timeout"))return{code:t.ErrorCode.ERR_REQUEST_TIMEOUT,message:a.TIMEOUT};if(e.errMsg.includes("network"))return{code:-1,message:a.NETWORK_ERROR};if(e.errMsg.includes("request:fail"))return{code:-1,message:a.REQUEST_FAILED};const o=e.errMsg.match(/[-\d]+/);o&&(r=parseInt(o[0]))}let o="";return r&&0!==r&&(o=t.getFriendlyErrorMessage(r,e.message||e.msg)),!o&&a[String(r)]&&(o=a[String(r)]),o||(o=e.message||e.msg||e.errMsg||"未知错误，请重试"),{code:Number(r),message:o}}handleAuthError(e){o.index.showModal({title:"提示",content:e,showCancel:!1,confirmText:"去登录",success:()=>{["chinese_rose_token","chinese_rose_userInfo","token","userInfo","user"].forEach(e=>{try{o.index.removeStorageSync(e)}catch(r){}}),o.index.reLaunch({url:"/pages/login/login"})}})}handleQuotaError(e){o.index.showModal({title:"配额提醒",content:e,confirmText:"我知道了",showCancel:!1})}showRetryModal(e,r){const t=n(),a=`retry_${Date.now()}`;this.retryCallbacks.set(a,r),o.index.showModal({title:"提示",content:e,confirmText:"重试",cancelText:"取消",success:e=>{if(e.confirm){const e=this.retryCallbacks.get(a);e&&(s.logger.info(t,"[ErrorHandler] 用户选择重试"),e(),this.retryCallbacks.delete(a))}else this.retryCallbacks.delete(a)}})}handleImageError(e,r){const o=n();return s.logger.warn(o,"[ErrorHandler] 图片加载失败",{src:e}),r||"/static/images/default.png"}handleValidationErrors(e){if(!e||0===e.length)return;const r=e[0];o.index.showToast({title:r.message,icon:"none",duration:2e3})}};exports.handleError=(e,r)=>i.handle(e,r);
