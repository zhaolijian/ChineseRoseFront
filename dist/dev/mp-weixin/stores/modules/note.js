"use strict";var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,o=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,u=(t,r,o)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o,n=(e,t)=>{for(var r in t||(t={}))l.call(t,r)&&u(e,r,t[r]);if(o)for(var r of o(t))a.call(t,r)&&u(e,r,t[r]);return e},s=(e,t,r)=>new Promise((o,l)=>{var a=e=>{try{n(r.next(e))}catch(t){l(t)}},u=e=>{try{n(r.throw(e))}catch(t){l(t)}},n=e=>e.done?o(e.value):Promise.resolve(e.value).then(a,u);n((r=r.apply(e,t)).next())});const c=require("../../common/vendor.js"),i=require("../../api/modules/note.js");require("../../utils/request.js");const v=require("../../utils/logger.js"),g=require("../../utils/logger-helpers.js"),f=c.defineStore("note",()=>{const e=c.ref([]),o=c.ref(null),l=c.ref(1),a=c.ref(20),u=c.ref(0),f=c.ref(!0),d=c.ref(!1),y=c.ref(""),p=c.ref([]),h=c.ref("idle"),N=c.ref(""),S=c.ref({}),x=(...t)=>s(exports,[...t],function*(t=1,r={}){const o=g.createContext();try{d.value=!0,S.value=n({},r);const s=yield i.getNoteList(n({page:t,pageSize:a.value},r));1===t?e.value=[...s.list]:e.value.push(...s.list),l.value=s.page,u.value=s.total;const c="boolean"==typeof s.hasMore?s.hasMore:s.page*(s.pageSize||a.value)<s.total;return f.value=c,v.logger.debug(o,"[NoteStore] 获取笔记列表成功",{page:t,params:r,total:u.value}),s}catch(s){throw v.logger.error(o,"[NoteStore] 获取笔记列表失败",s),s}finally{d.value=!1}});return{notes:e,currentNote:o,currentPage:l,pageSize:a,total:u,hasMore:f,loading:d,searchKeyword:y,searchResults:p,syncStatus:h,lastSyncTime:N,fetchNotes:x,fetchNoteDetail:t=>s(exports,null,function*(){const r=g.createContext();try{d.value=!0;const l=yield i.getNoteDetail(t);o.value=l;const a=e.value.findIndex(e=>e.id===t);return-1!==a&&(e.value[a]=l),v.logger.debug(r,"[NoteStore] 获取笔记详情成功",{id:t}),l}catch(l){throw v.logger.error(r,"[NoteStore] 获取笔记详情失败",l),l}finally{d.value=!1}}),createNote:o=>s(exports,null,function*(){var l;const a=g.createContext();try{d.value=!0;const g=(s=n({},o),c={noteType:o.noteType||"reading",tags:null!=(l=o.tags)?l:[]},t(s,r(c))),f=yield i.createNote(g);return e.value.unshift(f),u.value+=1,v.logger.info(a,"[NoteStore] 创建笔记成功",{id:f.id}),f}catch(f){throw v.logger.error(a,"[NoteStore] 创建笔记失败",f),f}finally{d.value=!1}var s,c}),updateNote:(t,r)=>s(exports,null,function*(){var l;const a=g.createContext();try{d.value=!0;const u=yield i.updateNote(t,r),n=e.value.findIndex(e=>e.id===t);return-1!==n&&(e.value[n]=u),(null==(l=o.value)?void 0:l.id)===t&&(o.value=u),v.logger.info(a,"[NoteStore] 更新笔记成功",{id:t}),u}catch(u){throw v.logger.error(a,"[NoteStore] 更新笔记失败",u),u}finally{d.value=!1}}),deleteNote:t=>s(exports,null,function*(){var r;const l=g.createContext();try{d.value=!0,yield i.deleteNote(t),e.value=e.value.filter(e=>e.id!==t),u.value=Math.max(0,u.value-1),(null==(r=o.value)?void 0:r.id)===t&&(o.value=null),v.logger.info(l,"[NoteStore] 删除笔记成功",{id:t})}catch(a){throw v.logger.error(l,"[NoteStore] 删除笔记失败",a),a}finally{d.value=!1}}),searchNotes:(e,...t)=>s(exports,[e,...t],function*(e,t={}){const r=g.createContext(),o=e.trim();if(y.value=o,!o)return p.value=[],v.logger.debug(r,"[NoteStore] 搜索关键字为空，返回空结果"),[];try{d.value=!0;const e=yield i.searchNotes(o,t);return p.value=e.list,v.logger.debug(r,"[NoteStore] 搜索笔记成功",{keyword:o,count:e.list.length}),e.list}catch(l){throw v.logger.error(r,"[NoteStore] 搜索笔记失败",l),l}finally{d.value=!1}}),fetchNotesByBook:(t,...r)=>s(exports,[t,...r],function*(t,r={}){const o=g.createContext();try{d.value=!0;const s=yield i.getNotesByBook(t,n({page:l.value,pageSize:a.value},r));e.value=s.list,u.value=s.total;const c="boolean"==typeof s.hasMore?s.hasMore:s.page*(s.pageSize||a.value)<s.total;return f.value=c,v.logger.debug(o,"[NoteStore] 按书籍获取笔记成功",{bookId:t}),s}catch(s){throw v.logger.error(o,"[NoteStore] 按书籍获取笔记失败",s),s}finally{d.value=!1}}),clearSearch:()=>{y.value="",p.value=[]},syncNotes:()=>s(exports,null,function*(){const e=g.createContext();try{h.value="syncing",yield x(1,S.value),N.value=(new Date).toISOString(),h.value="success",v.logger.info(e,"[NoteStore] 同步笔记成功")}catch(t){throw h.value="error",v.logger.error(e,"[NoteStore] 同步笔记失败",t),t}}),reset:()=>{e.value=[],o.value=null,l.value=1,u.value=0,f.value=!0,d.value=!1,y.value="",p.value=[],h.value="idle",N.value="",S.value={}}}});exports.useNoteStore=f;
