"use strict";var e=Object.defineProperty,t=Object.defineProperties,o=Object.getOwnPropertyDescriptors,l=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,u=(t,o,l)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:l}):t[o]=l,n=(e,t)=>{for(var o in t||(t={}))r.call(t,o)&&u(e,o,t[o]);if(l)for(var o of l(t))a.call(t,o)&&u(e,o,t[o]);return e},i=(e,t)=>{var o={};for(var u in e)r.call(e,u)&&t.indexOf(u)<0&&(o[u]=e[u]);if(null!=e&&l)for(var u of l(e))t.indexOf(u)<0&&a.call(e,u)&&(o[u]=e[u]);return o},s=(e,t,o)=>new Promise((l,r)=>{var a=e=>{try{n(o.next(e))}catch(t){r(t)}},u=e=>{try{n(o.throw(e))}catch(t){r(t)}},n=e=>e.done?l(e.value):Promise.resolve(e.value).then(a,u);n((o=o.apply(e,t)).next())});const c=require("../../common/vendor.js"),d=require("../../utils/request.js"),v=c.defineStore("book",()=>{const e=c.ref([]),l=c.ref(null),r=c.ref(!1),a=c.ref(1),u=c.ref(20),v=c.ref(0),f=c.ref(!0),p=c.computed(()=>e.value.length),h=c.computed(()=>e.value.filter(e=>"reading"===e.status)),g=c.computed(()=>e.value.filter(e=>"finished"===e.status)),y=c.computed(()=>e.value.filter(e=>"wishlist"===e.status)),b=(...l)=>s(exports,[...l],function*(l=1,s={}){var c,p,h,g,y,b,k,m,w,x;try{r.value=!0;const B=s,{pageSize:P,limit:S}=B,O=i(B,["pageSize","limit"]),q=null!=(c=null!=S?S:P)?c:u.value,E=n({page:l,limit:q},O),j=yield d.request({url:"/v1/books",method:"GET",data:E});if(j){const r=j,i=r.books||[];1===l?e.value=[...i]:e.value.push(...i);const{pagination:s}=r,c=null!=(h=null!=(p=null==s?void 0:s.page)?p:r.page)?h:l,d=null!=(y=null!=(g=null==s?void 0:s.limit)?g:r.pageSize)?y:q,B=null!=(k=null!=(b=null==s?void 0:s.total)?b:r.total)?k:i.length,P=null!=(w=null!=(m=null==s?void 0:s.totalPages)?m:r.totalPages)?w:Math.max(1,Math.ceil(B/(d||1))),S="boolean"==typeof r.hasMore?r.hasMore:s?s.page<s.totalPages:c<P;a.value=c,u.value=d,v.value=B,f.value=S;return x=n({},r),t(x,o({books:i,page:c,pageSize:d,total:B,totalPages:P,hasMore:S,pagination:null!=s?s:{page:c,limit:d,total:B,totalPages:P}}))}}catch(B){throw console.error("获取书籍列表失败:",B),B}finally{r.value=!1}}),k=t=>s(exports,null,function*(){var o;try{const r=t,{id:a}=r,u=i(r,["id"]),n=yield d.request({url:`/v1/books/${a}`,method:"PUT",data:u});if(n){const t=n,r=e.value.findIndex(e=>e.id===a);return-1!==r&&(e.value[r]=t),(null==(o=l.value)?void 0:o.id)===a&&(l.value=t),t}throw new Error("更新书籍失败")}catch(r){throw console.error("更新书籍失败:",r),r}});return{books:e,currentBook:l,loading:r,currentPage:a,pageSize:u,total:v,hasMore:f,bookCount:p,readingBooks:h,finishedBooks:g,wishlistBooks:y,fetchBooks:b,fetchBookDetail:t=>s(exports,null,function*(){try{const o=yield d.request({url:`/v1/books/${t}`,method:"GET"});if(o){l.value=o;const r=e.value.findIndex(e=>e.id===t);return-1!==r&&(e.value[r]=o),o}throw new Error("获取书籍详情失败")}catch(o){throw console.error("获取书籍详情失败:",o),o}}),createBook:t=>s(exports,null,function*(){try{const o=yield d.request({url:"/v1/books",method:"POST",data:t});if(o){const t=o;return e.value.unshift(t),v.value++,t}throw new Error("创建书籍失败")}catch(o){throw console.error("创建书籍失败:",o),o}}),updateBook:k,deleteBook:t=>s(exports,null,function*(){var o;try{if(void 0!==(yield d.request({url:`/v1/books/${t}`,method:"DELETE"}))){const r=e.value.findIndex(e=>e.id===t);-1!==r&&(e.value.splice(r,1),v.value--),(null==(o=l.value)?void 0:o.id)===t&&(l.value=null)}}catch(r){throw console.error("删除书籍失败:",r),r}}),searchBooks:(e,t=1)=>s(exports,null,function*(){return yield b(t,{keyword:e,page:t,limit:u.value})}),filterBooksByStatus:(e,t=1)=>s(exports,null,function*(){return yield b(t,{status:e,page:t,limit:u.value})}),fetchBookByISBN:e=>s(exports,null,function*(){try{return(yield d.request({url:"/v1/books/isbn",method:"GET",params:{isbn:e}}))||null}catch(t){return console.error("通过ISBN获取书籍信息失败:",t),null}}),updateReadingProgress:(e,t)=>s(exports,null,function*(){return yield k({id:e,progress:t})}),updateReadingStatus:(e,t)=>s(exports,null,function*(){return yield k({id:e,status:t})}),batchDeleteBooks:t=>s(exports,null,function*(){try{void 0!==(yield d.request({url:"/v1/books/batch-delete",method:"POST",data:{ids:t}}))&&(e.value=e.value.filter(e=>!t.includes(e.id)),v.value-=t.length)}catch(o){throw console.error("批量删除书籍失败:",o),o}}),resetState:()=>{e.value=[],l.value=null,r.value=!1,a.value=1,v.value=0,f.value=!0},setCurrentBook:e=>{l.value=e}}});exports.useBookStore=v;
