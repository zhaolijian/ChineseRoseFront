"use strict";var e=Object.defineProperty,r=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,n=(r,o,t)=>o in r?e(r,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[o]=t,a=(e,a)=>{for(var s in a||(a={}))o.call(a,s)&&n(e,s,a[s]);if(r)for(var s of r(a))t.call(a,s)&&n(e,s,a[s]);return e},s=(e,r,o)=>new Promise((t,n)=>{var a=e=>{try{g(o.next(e))}catch(r){n(r)}},s=e=>{try{g(o.throw(e))}catch(r){n(r)}},g=e=>e.done?t(e.value):Promise.resolve(e.value).then(a,s);g((o=o.apply(e,r)).next())});const g=require("../../common/vendor.js"),l=require("../../utils/storage.js");require("../../utils/request.js");const i=require("../../utils/logger.js"),u=require("../../utils/logger-helpers.js"),c=require("../../utils/base64.js"),d=require("../../api/modules/auth.js"),f=require("../../types/errorCodes.js");class h extends Error{constructor(e,r){super(f.getFriendlyErrorMessage(e,r)),this.code=e,this.name="BusinessError"}}const v=g.defineStore("user",()=>{const e=g.ref(null),r=g.ref("");let o=!1,t=!1,n=null;const v=g.computed(()=>!!r.value&&!!e.value),p=g.computed(()=>{var r,o;return(null==(r=e.value)?void 0:r.nickname)||(null==(o=e.value)?void 0:o.phone)||"用户"}),y=g.computed(()=>{var r;return(null==(r=e.value)?void 0:r.avatar)||"/static/images/default-avatar.png"}),k=()=>s(exports,null,function*(){const o=u.createContext();try{const t=yield l.getStorage("token"),n=yield l.getStorage("userInfo");t&&n?m(t,n)?(r.value=t,e.value=n,i.logger.debug(o,"[initUserInfo] 用户信息初始化成功")):(i.logger.warn(o,"[initUserInfo] 检测到损坏的用户数据，清除本地存储"),yield w()):i.logger.debug(o,"[initUserInfo] 本地无用户信息")}catch(t){i.logger.error(o,"[initUserInfo] 初始化用户信息失败，清除可能损坏的数据",t);try{yield w()}catch(n){i.logger.error(o,"[initUserInfo] 清除数据失败",n)}}}),I=e=>{const r=u.createContext();try{if(!e||"string"!=typeof e||0===e.trim().length)return i.logger.debug(r,"[validateToken] Token为空或格式无效"),!1;const t=e.split(".");if(3!==t.length)return i.logger.debug(r,"[validateToken] Token格式错误，期望三段式结构"),!1;if(t.some(e=>!e||0===e.length))return i.logger.debug(r,"[validateToken] Token部分段落为空"),!1;try{const e=JSON.parse(c.base64Decode(t[0]));if(!e.alg||!e.typ)return i.logger.debug(r,"[validateToken] JWT header格式无效"),!1;if("HS256"!==e.alg)return i.logger.debug(r,"[validateToken] JWT算法不匹配",{expected:"HS256",actual:e.alg}),!1;const o=JSON.parse(c.base64Decode(t[1]));if(!o.user_id||"number"!=typeof o.user_id)return i.logger.debug(r,"[validateToken] JWT payload缺少有效的user_id字段"),!1;if(!o.exp||!o.iat||!o.nbf)return i.logger.debug(r,"[validateToken] JWT payload缺少标准时间字段"),!1;const n=Math.floor(Date.now()/1e3);return o.exp<=n?(i.logger.debug(r,"[validateToken] JWT已过期",{exp:o.exp,expDate:new Date(1e3*o.exp).toLocaleString(),now:n,nowDate:new Date(1e3*n).toLocaleString()}),!1):o.nbf>n?(i.logger.debug(r,"[validateToken] JWT尚未生效",{nbf:o.nbf,now:n}),!1):(i.logger.debug(r,"[validateToken] JWT格式和内容验证通过",{userId:o.user_id,expireAt:new Date(1e3*o.exp).toLocaleString(),algorithm:e.alg}),!0)}catch(o){return i.logger.debug(r,"[validateToken] JWT解析失败，可能是伪造或损坏的token",o),!1}}catch(t){return i.logger.error(r,"[validateToken] 验证过程异常",t),!1}},m=(e,r)=>{const o=u.createContext();try{if(!I(e))return i.logger.debug(o,"[validateUserData] Token验证失败"),!1;if(!r||"object"!=typeof r)return i.logger.debug(o,"[validateUserData] 用户信息格式无效"),!1;const t=["id"];for(const e of t)if(!(e in r))return i.logger.debug(o,"[validateUserData] 缺少必需字段",{field:e}),!1;return i.logger.debug(o,"[validateUserData] 数据验证通过"),!0}catch(t){return i.logger.error(o,"[validateUserData] 数据验证异常",t),!1}},b=(o,t)=>s(exports,null,function*(){const n=u.createContext();if(!o||!t)throw i.logger.error(n,"[saveUserInfo] 参数验证失败，用户信息或token不能为空"),new h(f.ErrorCode.ERR_INVALID_PARAMS,"用户信息或token不能为空");const a=r.value,s=e.value;try{i.logger.debug(n,"[saveUserInfo] 开始保存用户信息"),r.value=o,e.value=t,yield l.setStorage("token",o),yield l.setStorage("userInfo",t),i.logger.info(n,"[saveUserInfo] 用户信息保存成功")}catch(g){throw r.value=a,e.value=s,i.logger.error(n,"[saveUserInfo] 保存用户信息失败，已回滚状态",g),new h(f.ErrorCode.ERR_STORAGE_FAILED,"保存用户信息失败")}}),w=()=>s(exports,null,function*(){const o=u.createContext();i.logger.debug(o,"[clearUserInfo] 开始清除用户信息"),r.value="",e.value=null;try{yield l.removeStorage("token"),yield l.removeStorage("userInfo"),i.logger.info(o,"[clearUserInfo] 用户信息清除成功")}catch(t){i.logger.error(o,"[clearUserInfo] 清除存储数据失败",t)}}),S=()=>s(exports,null,function*(){const e=u.createContext();if(i.logger.debug(e,"[preLoginCheck] 检查当前登录状态"),v.value)throw i.logger.warn(e,"[preLoginCheck] 用户已登录，拒绝重复登录"),new h(f.ErrorCode.ERR_ALREADY_LOGGED_IN,"您已经登录，如需切换账号请先退出当前账号");i.logger.debug(e,"[preLoginCheck] 当前未登录，可以进行登录")}),C=()=>s(exports,null,function*(){const r=u.createContext();try{i.logger.debug(r,"[fetchUserInfo] 开始获取用户信息");const o=yield d.getUserInfo();return e.value=o,l.setStorage("userInfo",o),i.logger.info(r,"[fetchUserInfo] 获取用户信息成功",{userId:o.id}),{code:0,message:"获取成功",data:o,success:!0}}catch(o){return i.logger.error(r,"[fetchUserInfo] 获取用户信息失败",o),{code:-1,message:o.message||"网络错误",data:{},success:!1}}});return{userInfo:e,token:r,isLoggedIn:v,userNickname:p,userAvatar:y,initUserInfo:k,loginWithWeChat:e=>s(exports,null,function*(){const r=u.createContext();try{i.logger.info(r,"[loginWithWeChat] 开始微信登录");const o=yield d.wechatCodeLogin({code:e.code,nickname:e.userInfo.nickName,avatar:e.userInfo.avatarUrl,gender:e.userInfo.gender});return yield b(o.token,o.user),i.logger.info(r,"[loginWithWeChat] 微信登录成功"),{code:0,message:"登录成功",data:o,success:!0}}catch(o){return i.logger.error(r,"[loginWithWeChat] 微信登录失败",o),{code:-1,message:o.message||"网络错误",data:null,success:!1}}}),wechatQuickLogin:(e,r)=>s(exports,null,function*(){var t,n,a,s,g;const l=u.createContext();if(i.logger.info(l,"[wechatQuickLogin] 开始微信一键登录流程（双code方式）"),!e||!r)throw i.logger.error(l,"[wechatQuickLogin] 登录参数不完整",{loginCode:!!e,phoneCode:!!r}),new h(f.ErrorCode.ERR_INVALID_PARAMS,"获取登录信息失败，请重试");if(o)throw i.logger.warn(l,"[wechatQuickLogin] 登录正在进行中，拒绝重复请求"),new h(f.ErrorCode.ERR_OPERATION_IN_PROGRESS);o=!0,i.logger.debug(l,"[wechatQuickLogin] 已设置登录锁");try{yield S(),i.logger.debug(l,"[wechatQuickLogin] 调用后端微信一键登录接口");const o=yield d.wechatQuickLogin(e,r);i.logger.info(l,"[wechatQuickLogin] 微信一键登录成功",{userId:o.user.id}),yield b(o.token,o.user),i.logger.debug(l,"[wechatQuickLogin] 用户信息已保存"),i.logger.info(l,"[wechatQuickLogin] 微信一键登录流程成功!")}catch(c){if(i.logger.error(l,"[wechatQuickLogin] 微信一键登录失败",c),c instanceof h)throw c;let e=f.ErrorCode.ERR_OPERATION_FAILED;(null==(t=c.message)?void 0:t.includes("Network Error"))||(null==(n=c.message)?void 0:n.includes("timeout"))||(null==(a=c.message)?void 0:a.includes("连接"))||(null==(s=c.message)?void 0:s.includes("ECONNREFUSED"))?e=f.ErrorCode.ERR_REQUEST_TIMEOUT:(null==(g=c.message)?void 0:g.includes("404"))&&(e=f.ErrorCode.ERR_NOT_FOUND);throw new h(e)}finally{o=!1,i.logger.debug(l,"[wechatQuickLogin] 已释放登录锁")}}),loginWithPhone:e=>s(exports,null,function*(){const r=u.createContext();if(t)throw i.logger.warn(r,"[loginWithPhone] 登录正在进行中，拒绝重复请求"),new h(f.ErrorCode.ERR_OPERATION_IN_PROGRESS);t=!0,i.logger.debug(r,"[loginWithPhone] 已设置登录锁");try{yield S(),i.logger.info(r,"[loginWithPhone] 开始手机号登录",{phone:e.phone});const o=yield d.smsLogin(e);return yield b(o.token,o.user),i.logger.info(r,"[loginWithPhone] 手机号登录成功",{userId:o.user.id}),{code:0,message:"登录成功",data:o,success:!0}}catch(o){return i.logger.error(r,"[loginWithPhone] 手机登录失败",o),{code:-1,message:o.message||"网络错误",data:null,success:!1}}finally{t=!1,i.logger.debug(r,"[loginWithPhone] 已释放登录锁")}}),devBypassLogin:e=>s(exports,null,function*(){const r=u.createContext(),o=e&&e.trim()||"19900000000",t=(new Date).toISOString(),n={id:999999,phone:o,nickname:"开发模式账号",avatar_url:"/static/images/default-avatar.png",created_at:t,updated_at:t},a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo5OTk5OTksImV4cCI6MTg5MzQ1NjAwMCwiaWF0IjoxNzAwMDAwMDAwLCJuYmYiOjE3MDAwMDAwMDB9.devsignature";return yield b(a,n),i.logger.info(r,"[devBypassLogin] 开发环境模拟登录成功",{phone:o}),{code:0,message:"开发模式登录成功",data:{token:a,user:n},success:!0}}),sendSMSCode:e=>s(exports,null,function*(){const r=u.createContext();try{return i.logger.info(r,"[sendSMSCode] 发送验证码",{phone:e}),yield d.sendSMSCode(e),i.logger.info(r,"[sendSMSCode] 验证码发送成功"),{code:0,message:"验证码发送成功",data:{sent:!0},success:!0}}catch(o){return i.logger.error(r,"[sendSMSCode] 发送验证码失败",o),{code:-1,message:o.message||"网络错误",data:null,success:!1}}}),fetchUserInfo:C,updateUserInfo:r=>s(exports,null,function*(){const o=u.createContext();try{i.logger.debug(o,"[updateUserInfo] 开始更新用户信息",r);const t=(e=>{const r={nickname:16,phone:15,avatar:500};for(const[o,t]of Object.entries(e))if(t&&"string"==typeof t){const e=r[o];if(e&&t.length>e)return{valid:!1,message:`${"nickname"===o?"昵称":"phone"===o?"手机号":"头像"}长度超限，最多${e}个字符`}}return{valid:!0,message:""}})(r);if(!t.valid)return i.logger.warn(o,"[updateUserInfo] 字段验证失败",{message:t.message}),{code:-1,message:t.message,data:{},success:!1};const n=yield d.updateUserInfo(r);return e.value=a(a({},e.value),n),l.setStorage("userInfo",e.value),i.logger.info(o,"[updateUserInfo] 用户信息更新成功",{userId:n.id}),{code:0,message:"更新成功",data:n,success:!0}}catch(t){return i.logger.error(o,"[updateUserInfo] 更新用户信息失败",t),{code:-1,message:t.message||"网络错误",data:{},success:!1}}}),logout:()=>s(exports,null,function*(){const e=u.createContext();try{i.logger.info(e,"[logout] 开始退出登录"),yield d.logout(),i.logger.debug(e,"[logout] 后端退出接口调用成功")}catch(r){i.logger.error(e,"[logout] 退出登录接口调用失败",r)}finally{yield w(),o=!1,t=!1,i.logger.info(e,"[logout] 退出登录完成")}}),checkLoginStatus:()=>s(exports,null,function*(){const e=u.createContext();return n?(i.logger.debug(e,"[checkLoginStatus] 检测到并发调用，复用现有Promise"),n):(n=s(exports,null,function*(){try{if(yield k(),!r.value)return i.logger.debug(e,"[checkLoginStatus] 无token，用户未登录"),!1;if(!I(r.value))return i.logger.debug(e,"[checkLoginStatus] Token本地验证失败，清除无效数据"),yield w(),!1;try{i.logger.debug(e,"[checkLoginStatus] Token本地验证通过，调用API验证token有效性");const r=yield C();return r.success?(i.logger.info(e,"[checkLoginStatus] token验证成功，用户已登录"),!0):(i.logger.debug(e,"[checkLoginStatus] token验证失败",{message:r.message}),yield w(),!1)}catch(o){return i.logger.error(e,"[checkLoginStatus] 检查登录状态失败",o),yield w(),!1}}finally{n=null}}),n)}),clearUserInfo:w}});exports.useUserStore=v;
