# 微信小程序环境搭建与验证指南

## 📋 前置准备

### 1. 开发工具
- **微信开发者工具**：[下载地址](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
- **VS Code**：安装uni-app相关插件
- **Node.js**：版本 >= 16.0.0

### 2. 小程序账号配置
- **AppID**: `wx630471360fc88823` ✅ 已配置
- **AppSecret**: 请在微信公众平台获取并妥善保管

## 🔧 环境配置步骤

### 1. 后端服务配置

#### 1.1 配置文件检查
```yaml
# configs/config.yaml
server:
  host: 0.0.0.0  # 允许外部访问
  port: 8080      # 服务端口

wechat:
  # 微信小程序配置已移至环境变量

sms:
  mock_enabled: true     # 开发环境启用Mock
  mock_code: "123456"    # 开发环境固定验证码
```

#### 1.2 环境变量设置
创建 `.env` 文件（不要提交到Git）：
```bash
# 微信小程序配置
WECHAT_APP_ID=wx630471360fc88823
WECHAT_APP_SECRET=your_app_secret_here

# 腾讯云COS配置（可选）
TENCENT_COS_SECRET_ID=your_cos_secret_id
TENCENT_COS_SECRET_KEY=your_cos_secret_key

# 短信服务配置（可选）
TENCENT_SMS_APP_ID=your_sms_app_id
TENCENT_SMS_SECRET_ID=your_sms_secret_id
TENCENT_SMS_SECRET_KEY=your_sms_secret_key
TENCENT_SMS_TEMPLATE_ID=your_template_id
```

#### 1.3 启动后端服务
```bash
cd /Users/zhaolijian/Projects/chinese-rose-backend
go run cmd/api/main.go
```

### 2. 前端小程序配置

#### 2.1 API地址配置
当前配置（`src/utils/request.ts`）：
```typescript
// 开发环境
// #ifdef MP-WEIXIN
this.baseURL = 'http://127.0.0.1:8080/api'  // 本地开发
// #endif
```

#### 2.2 安装依赖
```bash
cd /Users/zhaolijian/Projects/chinese-rose-front
npm install
```

#### 2.3 构建小程序
```bash
# 开发模式
npm run dev:mp-weixin

# 生产构建
npm run build:mp-weixin
```

### 3. 微信开发者工具配置

#### 3.1 导入项目
1. 打开微信开发者工具
2. 选择"小程序项目"
3. 项目目录：`/Users/zhaolijian/Projects/chinese-rose-front/dist/dev/mp-weixin`
4. AppID：`wx630471360fc88823`

#### 3.2 开发设置
在微信开发者工具中：
1. 详情 → 本地设置
2. ✅ 勾选"不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书"
3. ✅ 勾选"不校验小程序最低版本要求"

## 🌐 域名配置（生产环境）

### 1. 服务器域名配置
在微信公众平台配置合法域名：

**request合法域名**：
- `https://your-domain.com`（生产环境API地址）

**uploadFile合法域名**：
- `https://your-domain.com`（文件上传）
- `https://chinese-rose-storage-1302185194.cos.ap-beijing.myqcloud.com`（腾讯云COS）

**downloadFile合法域名**：
- `https://chinese-rose-storage-1302185194.cos.ap-beijing.myqcloud.com`（腾讯云COS）

### 2. HTTPS证书要求
- 证书必须是有效的SSL证书
- 支持TLS 1.2及以上版本
- 推荐使用Let's Encrypt免费证书

## 🧪 功能验证清单

### 1. 基础环境验证

#### ✅ 小程序启动验证
```bash
# 检查项
- [ ] 小程序能正常启动
- [ ] 首页能正常显示
- [ ] TabBar切换正常
- [ ] 页面路由跳转正常
```

#### ✅ 网络请求验证
```bash
# 检查项
- [ ] API请求能正常发送
- [ ] 请求头包含正确的trace-id
- [ ] 错误处理机制正常
- [ ] Loading状态显示正常
```

### 2. 核心功能验证

#### 2.1 用户认证流程

**手机号登录验证**：
```bash
测试步骤：
1. 进入登录页面
2. 输入手机号：13800138000
3. 点击获取验证码（开发环境会显示成功）
4. 输入验证码：123456（开发环境固定）
5. 点击登录

预期结果：
- [ ] 验证码发送成功提示
- [ ] 倒计时60秒正常工作
- [ ] 登录成功跳转到首页
- [ ] Token正确存储
- [ ] 用户信息正确获取
```

**微信一键登录验证**：
```bash
测试步骤：
1. 点击"微信一键登录"
2. 授权手机号

预期结果：
- [ ] 授权弹窗正常显示
- [ ] 授权成功后自动登录
- [ ] 跳转到首页
```

#### 2.2 书籍管理功能

**书架显示验证**：
```bash
测试步骤：
1. 登录后进入首页
2. 查看书架列表

预期结果：
- [ ] 书籍列表正常加载
- [ ] 空状态提示正确
- [ ] 加载状态显示正常
```

**添加书籍验证**：
```bash
测试步骤：
1. 点击添加书籍按钮
2. 填写书籍信息：
   - 书名：《测试书籍》
   - 作者：测试作者
   - ISBN：9787111111111
3. 选择封面图片（可选）
4. 点击保存

预期结果：
- [ ] 表单验证正常
- [ ] 图片上传功能正常（如配置COS）
- [ ] 保存成功提示
- [ ] 返回书架能看到新书
```

**编辑/删除书籍验证**：
```bash
测试步骤：
1. 点击书籍进入详情
2. 点击编辑按钮
3. 修改信息并保存
4. 测试删除功能

预期结果：
- [ ] 编辑页面数据回显正确
- [ ] 修改保存成功
- [ ] 删除确认弹窗正常
- [ ] 删除后列表更新
```

### 3. 真机调试指南

#### 3.1 开启真机调试
1. 微信开发者工具工具栏 → 真机调试
2. 扫码在手机上打开小程序
3. 可实时查看console日志

#### 3.2 真机调试注意事项
- **网络问题**：确保手机和电脑在同一局域网
- **HTTPS问题**：真机必须使用HTTPS（除非开启调试模式）
- **权限问题**：检查相机、相册等权限是否授予

#### 3.3 常见真机问题

**问题1：无法连接到后端服务**
```bash
解决方案：
1. 检查电脑防火墙是否开放8080端口
2. 使用电脑局域网IP替代127.0.0.1
3. 手机开启调试模式
```

**问题2：登录后立即退出**
```bash
解决方案：
1. 检查Token存储是否正常
2. 检查API响应格式是否正确
3. 查看日志是否有401错误
```

## 📝 验证报告

### 环境状态检查

| 检查项 | 状态 | 说明 |
|-------|------|------|
| 后端服务运行状态 | ⏸️ 待验证 | 需要启动后端服务 |
| 数据库连接 | ⏸️ 待验证 | MySQL需要运行 |
| Redis连接 | ⏸️ 待验证 | Redis需要运行 |
| 小程序AppID配置 | ✅ 已配置 | wx630471360fc88823 |
| API请求配置 | ✅ 已配置 | 开发环境指向本地 |
| 短信服务 | ✅ Mock模式 | 开发环境使用123456 |

### 功能验证结果

| 功能模块 | 验证状态 | 备注 |
|---------|---------|------|
| 用户登录 | ⏸️ 待验证 | 包括手机号和微信登录 |
| 书籍管理 | ⏸️ 待验证 | CRUD功能 |
| 图片上传 | ⚠️ 需配置 | 需要配置腾讯云COS |
| 笔记功能 | ⏸️ 待验证 | 待开发完成 |
| 思维导图 | ⏸️ 待验证 | 待开发完成 |

### 已知问题与解决方案

1. **开发环境HTTP请求**
   - 问题：小程序要求HTTPS
   - 解决：开发工具勾选"不校验域名"

2. **Token过期处理**
   - 问题：Token过期后需要重新登录
   - 解决：已实现自动跳转登录页

3. **文件上传限制**
   - 问题：小程序单文件最大10MB
   - 解决：前端做文件大小校验

## 🚀 下一步行动

1. **完成环境搭建**
   - [ ] 启动MySQL和Redis
   - [ ] 启动后端服务
   - [ ] 编译运行小程序

2. **功能验证**
   - [ ] 完成所有核心功能测试
   - [ ] 记录发现的问题
   - [ ] 真机测试验证

3. **生产环境准备**
   - [ ] 配置HTTPS证书
   - [ ] 配置合法域名
   - [ ] 完善错误监控

## 📞 技术支持

如遇到问题，请检查：
1. 控制台日志信息
2. 网络请求状态
3. 后端服务日志
4. 微信开发者工具调试器

---

*最后更新：2025-09-21*